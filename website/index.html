<!DOCTYPE html>
<html lang="en" data-rolemap-key="oppli-db-v1">
<head>
<meta charset="utf-8" />
<meta name="description" content="Oppli is a local-first app to manage job applications, networking contacts, coffee chats, and entrepreneurship ideas with Next Actions, Kanban, and Calendar views." />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Oppli" />
<meta property="og:description" content="Local-first job hunt, networking and entrepreneurship dashboard." />
<meta property="og:url" content="https://oppli.io" />
<meta property="og:type" content="website" />
<title>Oppli – Job Hunting, Networking & Entrepreneurship Dashboard</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzQiIGhlaWdodD0iMzQiIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB4PSIxMCIgeT0iMTAiIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgcng9IjE2IiByeT0iMTYiIGZpbGw9IiMwMENFRDEiLz4KPHBhdGggZD0iTTI1IDUwbDE1IDE1IDM1LTM1IiBzdHJva2U9IiMwMDJCNUIiIHN0cm9rZS13aWR0aD0iNiIgZmlsbD0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=">
<link rel="shortcut icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzQiIGhlaWdodD0iMzQiIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB4PSIxMCIgeT0iMTAiIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgcng9IjE2IiByeT0iMTYiIGZpbGw9IiMwMENFRDEiLz4KPHBhdGggZD0iTTI1IDUwbDE1IDE1IDM1LTM1IiBzdHJva2U9IiMwMDJCNUIiIHN0cm9rZS13aWR0aD0iNiIgZmlsbD0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=">
<style>
/* --- Next Actions v16 UI patch (minimal) --- */
/* === NEXT ACTIONS v16 (scoped) === */
.na-v16 .actions-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(520px,1fr));
    gap:14px;
    align-items:stretch;
  }
  
  .na-v16 .action-card{
    border:1px solid #e7ebf0;
    background:#fff;
    border-radius:16px;
    box-shadow:0 6px 20px rgba(0,0,0,.06);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    height:100%;
  }
  
  /* header */
  .na-v16 .action-card .action-head{
    display:block !important;
    padding:10px 12px 8px !important;
    border-bottom: 0 !important;
  }
  
  .na-v16 .action-card .action-top-row{
    display:flex !important;
    justify-content:space-between !important;
    align-items:center !important;
    gap:16px;
    margin-bottom:4px;
    width:100%;
    flex-shrink:0;
  }
  
  .na-v16 .action-card .action-title{
    flex:1;
    min-width:0;
    max-width:60%;
  }
  
  .na-v16 .action-card .head-right{
    flex:0 0 auto;
    min-width:40%;
  }
  
  .na-v16 .action-card .relation-line{
    margin-top:4px;
    margin-bottom:2px;
    display:block !important;
    width:100% !important;
    font-size:12px; 
    color:#4b5563; 
    font-style: italic;
    clear:both !important;
  }
  
  .na-v16 .action-card .desc-one{
    margin-top:2px;
    display:flex !important;
    width:100% !important;
    clear:both !important;
    align-items:center;
    gap:6px;
    min-width:0;
  }
  
  .na-v16 .action-card .desc-one .label{
    flex-shrink:0;
    white-space:nowrap;
  }
  
  .na-v16 .action-card .desc-one .text{
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    min-width: 0;
    flex: 1;
  }
  
  .na-v16 .head-left{min-width:0}

  .na-v16 .action-title{
    display:block;
    border:0;
    background:transparent;
    outline:none;
    font-weight:800;
    font-size:16px;
    padding:2px 0;
    border-radius:6px;
    line-height:1.2;
    white-space:normal;
    word-break:break-word;
    overflow-wrap:anywhere;
  }
  .na-v16 .action-title.editing{ box-shadow:0 0 0 2px rgba(0,180,216,.25); }
  


  
  /* header right (status, progress, icons) */
  .na-v16 .head-right{ display:flex; align-items:center; gap:8px; flex-wrap:nowrap; justify-content:flex-end; }
  .na-v16 .progress-text{ font-size:10px; color:#6b7280; opacity:.85; }
  .na-v16 .head-icons{ display:flex; gap:6px; align-items:center; }
  .na-v16 .iconbtn.tiny{ padding:2px 4px; border-radius:6px; }
  .na-v16 .head-icons .iconbtn.tiny svg,
  .na-v16 .sub-icons  .iconbtn.tiny svg{ width:12px; height:12px; }
  
  /* badges (scoped so no globals required) */
  .na-v16 .badge{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700; }
  .na-v16 .badge.todo{ background:#eceff3; color:#374151; }
  .na-v16 .badge.progress{ background:#dbeafe; color:#1e3a8a; }
  .na-v16 .badge.done{ background:#dcfce7; color:#065f46; }
  .na-v16 .badge.overdue{ background:#fee2e2; color:#991b1b; border:1px solid #e5e7eb; }
  
  /* body + subtasks */
  .na-v16 .action-body{
    padding:8px 10px 10px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  
  .na-v16 .sub-row{
    position:relative;
    display:grid;
    grid-template-columns: auto minmax(0,4fr) minmax(0,1.25fr) minmax(0,0.25fr);
    gap:8px;
    align-items:center;
    padding:12px 10px;
    padding-right: 44px;
    border-radius:10px;
    border:1px solid #eef2f7;
    background:#fff;}
  .na-v16 .sub-row:hover{ background:#f9fafb; }
  
  .na-v16 .sub-title{
    font-size:13px;
    outline:0;
    border-radius:6px;
    padding:2px 4px;
    word-break:break-word;
    min-width: 0;
  }
  .na-v16 .sub-title.sub-completed{ color:#9ca3af; text-decoration:line-through; }
  .na-v16 .sub-title.sub-overdue{ font-weight: 400; } 
  
  .na-v16 .due-pill{
    justify-self:center;
    align-self:center;
    font-size:12px;
    padding:2px 8px;
    border:1px solid #e5e7eb;
    border-radius:999px;
    background:#fff;
    font-weight:800;
    text-align:center;
  }
  .na-v16 .sub-overdue{ color:#b91c1c; font-weight:700; }
  
  .na-v16 .sub-icons{
    position: absolute;
    top: 4px;
    right: 4px;
    display: flex;
    gap: 2px;
  }
  .na-v16 .sub-icons .iconbtn.tiny{
    width: 16px;
    height: 16px;
    padding: 0;
    border-radius: 6px;
    line-height: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .na-v16 .sub-icons .iconbtn.tiny svg{
    width: 9px;
    height: 9px;
  }
  
  .na-v16 .drag-over{ outline:2px dashed #cfe9f4; outline-offset:3px; }
  
  /* footer */
  .na-v16 .action-foot{
    padding:10px 12px;
    border-top:1px solid #eef2f7;
    display:flex;
    justify-content:flex-end;
  }
  .na-v16 .action-foot .btn{ height:36px; }
  /* NA v16 aliases to match the JS */
.na-v16 .relation-line{ font-size:12px; color:#4b5563; margin-top:2px; }
/* Single-line, full-width description with ellipsis */
.na-v16 .desc-one{
    display: grid;
    grid-template-columns: auto 1fr; /* label + flexible text */
    align-items: center;
    gap: 6px;
    font-size: 10px;
    color: #6b7280;
    margin-top: 2px;
    min-width: 0;                 /* required for ellipsis in CSS grid */
  }
  .na-v16 .desc-one .label{
    white-space: nowrap;
    color: #0ea5e9;
    font-weight: 700;
  }
  .na-v16 .desc-one .text{
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;      /* ← the "…" */
    min-width: 0;                 /* allow shrinking */
  }
  
  /* When expanded (full description), drop the truncation */
  .na-v16 .desc-full{
    display: block;               /* override the grid */
    -webkit-line-clamp: unset;
    overflow: visible;
    white-space: pre-wrap;        /* keep user newlines */
  }
  
  
.na-v16 .head-right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

/* === fixes for spacing + lines in Next Actions cards === */
  
.na-v16 .relation-line{ 
    margin-top:2px; 
    margin-bottom:2px; 
    font-style:italic; 
    display:block; 
    clear:both; 
} 
.na-v16 .desc-one{ 
    margin-top:2px; 
    display:block; 
    clear:both; 
}
  
.na-v16 .action-title{ padding-left:0; margin-left:0; }    /* aligns title with relation/description */
  
.na-v16 .action-foot{
    /* kill the gray separator above the Add subtask area */
    border-top: 0 !important;
    margin-top: auto;
  }
/* Bigger clickable area around the checkbox, ONLY in Next Actions cards */
.na-v16 .sub-check{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:8px;      /* enlarges hit area */
  margin:-8px;      /* cancels layout growth so layout doesn't shift */
  border-radius:8px;
  cursor:pointer;
  position: relative
}
.na-v16 .sub-check input[type="checkbox"]{
  margin:0;
}
.na-v16 .sub-check::before{
  content:"";
  position:absolute;
  width:34px;             /* enlarge as you like */
  height:34px;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);  /* centered on the checkbox */
  border-radius:8px;
  background:transparent;
  pointer-events:auto;    /* clicks go to the label -> toggles checkbox */
}

/* Hand cursor on the input itself too */
.na-v16 .sub-row input[type="checkbox"]{
  cursor:pointer;
}


  
  :root{ --navy:#002B5B; --teal:#007F7F; --sky:#00B4D8; --gray:#F2F2F2; --sand:#E8C07D; --graphite:#3A3A3A; --white:#ffffff; --red:#d72638; --muted:#6b7280; --success:#16a34a; --info:#0ea5e9; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--gray);color:var(--graphite);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .topbar{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--navy),var(--teal));color:#fff;border-bottom:1px solid rgba(255,255,255,.12)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700}
  .logo{display:inline-block}
  .logo svg{display:block}
  .actions{position:relative;display:flex;gap:8px;align-items:center}
  .gearbtn{background:transparent;border:1px solid rgba(255,255,255,.35);border-radius:12px;padding:8px 12px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;color:#fff}
  .gearbtn svg{width:18px;height:18px}
  .actions .menu{position:absolute;right:0;top:calc(100% + 6px);background:#fff;color:#333;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.14);padding:8px;display:none;min-width:200px}
  .actions .menu.open{display:block}
  .menu .item{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;cursor:pointer;font:600 14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .menu .item:hover{background:#f3f4f6}
  .menu .item svg{width:16px;height:16px}
  button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn{background:var(--sky);color:#fff}
  .btn-teal{background:var(--teal);color:#fff}
  .btn-destructive{background:var(--red);color:#fff}
  .btn-ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.3)}
  .tabs{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;background:#fff;border-radius:14px;padding:6px;border:1px solid #e5e7eb}
  .tab{padding:10px 12px;border-radius:10px;text-align:center;font-weight:600;color:#333;background:#f8fafc;cursor:pointer}
  .tab.active{background:var(--sand)}
  .toolbar{display:flex;align-items:center;justify-content:space-between;margin:14px 0;gap:12px}
  .left{display:flex;align-items:center;gap:10px}
  .subtabs{display:flex;gap:8px;align-items:center;margin:0}
  .pill{display:inline-flex;align-items:center;height:36px;padding:0 12px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:600;font-size:12px;font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial}
  .pill.active{background:var(--sand)}
  /* inline filters/search */
  .filters-inline{display:flex;align-items:flex-end;gap:15px;flex-wrap:nowrap}
  .filters-inline .field{display:flex;flex-direction:column;gap:4px}
  .filters-inline .field label{display:flex;align-items:center;gap:6px;margin:0;font-size:12px;color:#6b7280}
  .filters-inline .field select,
  .filters-inline .search input{height:36px;padding:8px 10px;border-radius:10px;border:1px solid #d1d5db;font-size:12px}
  .filters-inline .search{position:relative;display:flex;align-items:center}
  .filters-inline .search .icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);pointer-events:none}
  .filters-inline .search input{padding-left:32px;min-width:220px}
  /* generic field (labels on top) */
  .field{display:flex;flex-direction:column;gap:4px}
  .field label{display:flex;align-items:center;gap:6px;margin:0;font-size:12px;color:#6b7280}
  /* smaller select utility */
  .small-select{height:32px;padding:6px 8px;font-size:12px;width:120px}
  /* narrower content wrapper for Jobs/Chats */
  .content-narrow{max-width:1040px;margin:0}
  /* cards / general */
  .card{position:relative;background:#fff;border:1px solid #e5e7eb;border-radius:16px;overflow:hidden}
  .card-head{padding:12px 14px;background:var(--navy);color:#fff;font-weight:700;display:flex;justify-content:space-between;align-items:center}
  .card-body{padding:14px}
  .stack-gap>*+*{margin-top:12px}
  label{font-size:12px;font-weight:600;color:#555;display:block;margin:6px 0 4px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d1d5db;background:#fff}
  textarea{min-height:96px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px}
  /* tables */
  table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
  thead th{background:#f8fafc;font-size:12px;color:#555}
  th,td{padding:10px 12px;border-bottom:1px solid #eef2f7;text-align:left}
  tr:last-child td{border-bottom:0}
  tbody tr{transition:background-color .12s ease, box-shadow .12s ease; cursor:pointer}
  tbody tr:hover{background:rgba(0,180,216,.08)}
  .iconbtn{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
  /* Dropdown menu for table actions */
  .action-dropdown{position:relative;display:inline-block}
  .action-dropdown-btn{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:8px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px}
  /* Ensure Actions column has enough width for dropdown */
  th:last-child, td:last-child{min-width:140px;width:140px}
  .action-dropdown-btn:hover{background:#e5e7eb}
  .action-dropdown-menu{position:fixed;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);min-width:100px;z-index:1000;display:none}
  .action-dropdown-menu.open{display:block}
  .action-dropdown-item{display:flex;align-items:center;gap:6px;padding:6px 10px;cursor:pointer;font-size:12px;font-weight:normal;border:none;background:none;width:100%;text-align:left}
  .action-dropdown-item:hover{background:#f8fafc}
  .action-dropdown-item:first-child{border-radius:8px 8px 0 0}
  .action-dropdown-item:last-child{border-radius:0 0 8px 8px}
  /* sort indicators */
  th.sortable{cursor:pointer; user-select:none; position:relative}
  th.sortable .sort-ind{font-size:10px;opacity:.6;margin-left:6px}
  th[aria-sort="ascending"] .sort-ind::after{content:"▲"}
  th[aria-sort="descending"] .sort-ind::after{content:"▼"}
  th[aria-sort="none"]:hover .sort-ind::after{content:"↕"}
  /* Kanban */
  .kanban{display:flex;gap:12px;overflow-x:auto;padding-bottom:8px;margin-left:0;padding-left:0}
  .kan-col{min-width:260px;flex:0 0 260px}
  .kan-col.card{background:#f7fafc;border-color:#e8edf4}
  .colhead{padding:8px 10px;background:var(--navy);color:#fff;font-weight:700;text-align:center}
  .colhead.rejected{background:#611}
  .kan-card{position:relative;border:1px solid #e5e7eb;border-radius:12px;background:#fbfdff;padding:10px;margin:8px 0;cursor:grab; transition: box-shadow .12s ease, border-color .12s ease}
  .kan-col:first-child{margin-left:0}
  .kan-card:hover{box-shadow:0 6px 18px rgba(0,0,0,.08); border-color:#cfe9f4}
  .card-actions{position:absolute;top:4px;right:4px;display:flex;gap:4px}
  .card-actions .iconbtn{padding:2px 4px}
  .card-actions .iconbtn svg{width:12px;height:12px;transform:translateY(1px)}
  .dropzone{min-height:40px}
  .drop-over{outline:2px dashed var(--sky);outline-offset:4px}
  /* badges */
  .badge{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;font-size:11px;font-weight:700}
  .badge.todo{background:#e5e7eb;color:#374151}
  .badge.progress{background:#dbeafe;color:#1e3a8a}
  .badge.done{background:#dcfce7;color:#065f46}
  .badge.overdue{background:#fee2e2;color:#991b1b;border:1px solid #e5e7eb}
  /* actions grid */
  .actions-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:12px}
  .action-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;display:flex;flex-direction:column}
  .action-head{display:flex;justify-content:space-between;align-items:center;padding:12px 12px;border-bottom:1px solid #eef2f7}
  
  /* Override for Next Actions specifically */
  .na-v16 .action-head{
    display:block !important;
    justify-content:unset !important;
    align-items:unset !important;
  }
  .action-title{font-weight:700;outline:none;border-radius:8px;padding:2px 4px}
  .action-title.editing{box-shadow:0 0 0 2px rgba(0,180,216,.25)}
  .action-sub{font-size:12px;color:#6b7280}
  .action-body{padding:10px 12px;display:flex;flex-direction:column;gap:6px}
  .sub-row{display:grid;grid-template-columns:auto 1fr auto auto;gap:8px;align-items:center;padding:6px;border-radius:8px}
  .sub-row:hover{background:#f9fafb}
  .sub-row .tiny{opacity:.6}
  .sub-controls{display:none;gap:6px}
  .sub-row:hover .sub-controls{display:flex}
  .sub-title{outline:none;border-radius:6px;padding:4px 6px}
  .sub-date{height:28px;padding:4px 6px;border-radius:6px;border:1px solid #d1d5db}
  .sub-overdue{color:#b91c1c;font-weight:600}
  .sub-completed{color:#9ca3af;text-decoration:line-through}
  .action-foot{padding:10px 12px;border-top:1px solid #eef2f7;display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center}
  .action-foot input[type="text"]{height:32px;padding:6px 8px}
  .action-foot input[type="date"]{height:32px;padding:6px 8px;border-radius:8px;border:1px solid #d1d5db}
  .pulse-done{animation:pulse 800ms ease-out}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(22,163,74,.0)}50%{box-shadow:0 0 0 8px rgba(22,163,74,.18)}100%{box-shadow:0 0 0 0 rgba(22,163,74,.0)}}
  
  /* Expanded action modal styles */
  .subtask-expanded{margin-bottom:12px;border:1px solid #eef2f7;border-radius:8px;overflow:hidden}
  .subtask-expanded .sub-row{background:#f9fafb;border-bottom:1px solid #eef2f7;margin:0}
  .subtask-notes{padding:8px 12px;background:#fff;font-size:12px;color:#6b7280}
  .subtask-notes .label{font-weight:600;color:#374151;margin-right:8px}
  .subtask-notes .text{color:#4b5563;line-height:1.4;word-wrap:break-word;overflow-wrap:break-word;white-space:normal}
  
  /* Modal description override - show full text */
  .modal .na-v16 .desc-one .text{
    overflow: visible;
    white-space: normal;
    text-overflow: unset;
  }
  
  /* Style close button for expand modal */
  .modal[data-modal-type="expand"] .close-x{
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }
  .modal[data-modal-type="expand"] .close-x:hover{
    background: rgba(255,255,255,0.3);
  }
  
  /* Expanded action modal layout - clean and beautiful */
  .action-head-expanded{
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .expand-top-row{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 4px;
  }
  
  .expand-title-section{
    flex: 2;
    min-width: 0;
  }
  
  .expand-title{
    font-size: 16px;
    font-weight: 700;
    color: #1f2937;
    line-height: 1.3;
    word-wrap: break-word;
    overflow-wrap: break-word;
    padding-right: 16px;
  }
  
  .expand-status-section{
    flex: 1;
    min-width: 0;
  }
  
  .expand-status-content{
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: nowrap;
    justify-content: flex-end;
    min-width: 0;
  }
  
  .na-v16 .expand-status-content{
    gap: 8px;
    flex-wrap: nowrap !important;
  }
  
  .na-v16 .expand-status-content .badge{
    flex-shrink: 0;
  }
  
  .na-v16 .expand-status-content .progress-text{
    flex-shrink: 0;
    white-space: nowrap;
  }
  
  /* Idea Next Steps Section Styles */
  .info-note{
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
    padding: 8px 12px;
    margin-bottom: 12px;
    font-size: 12px;
    color: #0369a1;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .idea-actions-container{
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
  }
  
  .idea-action-card{
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  
  .empty-state{
    text-align: center;
    padding: 32px 16px;
    color: #64748b;
  }
  
  .empty-icon{
    font-size: 32px;
    margin-bottom: 8px;
  }
  
  .empty-text{
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #475569;
  }
  
  .empty-subtext{
    font-size: 12px;
    color: #64748b;
  }
  
  .add-step-form-improved{
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    margin-top: 8px;
  }
  
  .add-step-header{
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    font-weight: 600;
    color: #374151;
  }
  
  .add-step-icon{
    font-size: 16px;
  }
  
  .input-group{
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .step-input-improved{
    flex: 1;
    min-width: 200px;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }
  
  .step-input-improved:focus{
    border-color: #0ea5e9;
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
  }
  
  .step-date-improved{
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }
  
  .step-date-improved:focus{
    border-color: #0ea5e9;
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
  }
  
  .add-step-btn-improved{
    padding: 8px 16px;
    background: #0ea5e9;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .add-step-btn-improved:hover{
    background: #0284c7;
  }
  
  .add-step-btn-improved:disabled{
    background: #9ca3af;
    cursor: not-allowed;
  }
  
  /* Add action button - same style as useful links */
  .add-action-btn{
    background: #f0f9ff;
    border: 1px dashed #0ea5e9;
    border-radius: 6px;
    padding: 8px 16px;
    color: #0ea5e9;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    margin-top: 8px;
    text-align: center;
  }
  
  .add-action-btn:hover{
    background: #e0f2fe;
    border-color: #0284c7;
  }
  
  .add-step-form-hidden{
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    margin-top: 8px;
  }
  
  .input-row{
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap;
  }
  
  .input-row input{
    flex: 1;
    min-width: 120px;
  }
  
  .button-row{
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  
  .button-row .btn{
    padding: 6px 12px;
    font-size: 12px;
  }
  
  .expand-relation{
    margin-top: 0px;
    margin-bottom: 2px;
  }
  
  .expand-relation .relation-line{
    font-size: 12px;
    color: #6b7280;
    font-style: italic;
    line-height: 1.4;
  }
  
  .expand-description-section{
    margin-top: 8px;
  }
  
  .expand-description-section .desc-one{
    margin-top: 0;
  }
  
  .expand-description-section .desc-one .text{
    overflow: visible;
    white-space: normal;
    text-overflow: unset;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
  }
  
  .expand-description-section .desc-one .label{
    color: #0ea5e9;
    font-weight: 600;
    margin-right: 8px;
  }
  
  /* Subtasks editing section */
  .subtasks-edit-section{
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
  }
  
  .subtask-edit-row{
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 32px;
    margin-bottom: 16px;
    padding: 20px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #f9fafb;
  }
  
  .subtask-field{
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  
  .subtask-field-full{
    grid-column: 1 / -1;
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 8px;
  }
  
  .subtask-field label,
  .subtask-field-full label{
    font-size: 12px;
    font-weight: 600;
    color: #374151;
  }
  
  .subtask-field input,
  .subtask-field-full textarea{
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
  }
  
  .checkbox-wrapper{
    margin-top: 8px;
  }
  
  .checkbox-label{
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 14px;
    color: #374151;
  }
  
  .checkbox-label input[type="checkbox"]{
    width: 16px;
    height: 16px;
    margin: 0;
    padding: 0;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    cursor: pointer;
  }
  
  .checkbox-label input[type="checkbox"]:checked{
    background-color: #0ea5e9;
    border-color: #0ea5e9;
  }
  
  .checkbox-text{
    font-weight: 500;
  }
  
  /* Subtask Creation Styles */
  .subtasks-create-section{
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb;
  }
  
  .subtask-create-row{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 12px;
    position: relative;
    padding: 16px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #f9fafb;
    font-family: inherit;
  }
  
  .subtask-remove-x{
    position: absolute;
    top: 8px;
    right: 8px;
    width: 20px;
    height: 20px;
    border: none;
    background: #ef4444;
    color: white;
    border-radius: 50%;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    padding: 0;
  }
  
  .subtask-remove-x:hover{
    background: #dc2626;
  }
  
  .btn-outline{
    padding: 8px 16px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: #fff;
    color: #374151;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .btn-outline:hover{
    background: #f3f4f6;
    border-color: #9ca3af;
  }
  
  .action-info-section{
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e5e7eb;
  }
  
  /* Entrepreneurship Ideas Styles - Matching HTML Example */
  .toolbar{
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 14px 0 10px;
    flex-wrap: wrap;
  }
  
  .toolbar .search{
    position: relative;
    flex: 1;
    min-width: 220px;
  }
  
  .toolbar .search input{
    width: 100%;
    height: 40px;
    border: 1px solid #d1d5db;
    border-radius: 12px;
    padding: 8px 12px 8px 34px;
    background: #fff;
  }
  
  .toolbar .search .ico{
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    opacity: .6;
  }
  
  .btn{
    appearance: none;
    border: 0;
    border-radius: 12px;
    padding: 10px 14px;
    font-weight: 800;
    cursor: pointer;
  }
  
  .btn-primary{
    background: var(--sky, #00B4D8);
    color: #fff;
  }
  
  .btn-ghost{
    background: #fff;
    border: 1px solid #e5e7eb;
    color: #111;
  }
  
  .switch{
    display: flex;
    align-items: center;
    gap: 0;
    font-weight: 600;
    color: #374151;
  }
  
  .switch span{
    margin-left: -6px;
  }
  
  .ideas-checkbox{
    margin: 0;
    padding: 0;
    width: 16px;
    height: 16px;
  }
  
  .ideas-switch{
    gap: 4px;
  }
  
  .ideas-switch span{
    margin-left: 0;
  }
  
  /* idea cards */
  .list{
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .idea{
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    overflow: hidden;
  }
  
  .idea-head{
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 10px;
    align-items: center;
    padding: 12px 12px;
    border-bottom: 1px solid #eef2f7;
  }
  
  .idea-head-new{
    display: grid;
    grid-template-columns: auto 1fr auto auto;
    gap: 16px;
    align-items: center;
    padding: 12px 32px 12px 16px;
    border-bottom: 1px solid #eef2f7;
    position: relative;
  }
  
  .emoji{
    font-size: 22px;
    line-height: 1;
  }
  
  .title{
    border: 0;
    background: transparent;
    outline: none;
    font-weight: 800;
    font-size: 16px;
    color: #0ea5e9; /* Light blue color for titles */
  }
  
  .muted{
    color: #6b7280;
  }
  
  .pill{
    display: inline-flex;
    align-items: center;
    gap: 6px;
    height: 30px;
    padding: 0 10px;
    border: 1px solid #e5e7eb;
    border-radius: 999px;
    background: #fff;
    font-weight: 700;
    font-size: 12px;
  }
  
  .star{
    cursor: pointer;
    user-select: none;
  }
  
  .menu{
    display: flex;
    gap: 6px;
  }
  
  .iconbtn{
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 6px 8px;
    cursor: pointer;
    display: inline-flex;
    gap: 6px;
    align-items: center;
  }
  
  .iconbtn svg{
    width: 16px;
    height: 16px;
  }
  
  .idea-body{
    padding: 16px;
    display: none;
    background: #f8fafc;
  }
  
  .idea.open .idea-body{
    display: block;
  }
  
  .section{
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    margin: 12px 0;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }
  
  .section h4{
    margin: 0 0 12px;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: .2px;
    color: #0ea5e9;
  }
  
  .input-card{
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    margin: 8px 0;
  }
  
  .row{
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  
  .stack > * + *{
    margin-top: 10px;
  }
  
  .todo{
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 8px;
    align-items: center;
    padding: 8px;
    border-radius: 10px;
    border: 1px dashed #e5e7eb;
    background: #fff;
  }
  
  .todo input[type="checkbox"]{
    width: 18px;
    height: 18px;
  }
  
  .link{
    color: #0ea5e9;
    text-decoration: none;
    font-weight: 700;
  }
  
  .small{
    font-size: 12px;
  }
  
  .archived{
    opacity: .6;
  }
  
  .help-text{
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
  }
  
  .related-action{
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin: 4px 0;
  }
  
  .action-title{
    font-weight: 600;
    color: #374151;
  }
  
  .action-status{
    text-transform: capitalize;
    color: #6b7280;
  }
  
  .emoji-btn{
    background: transparent;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 8px;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .emoji-btn:hover{
    background: #f8fafc;
    border-color: #cbd5e1;
  }
  
  .title-description{
    border: 0;
    background: transparent;
    outline: none;
    font-weight: 700;
    font-size: 16px;
    color: #1e293b; /* Slate gray - professional and readable */
    padding: 4px 8px;
    border-radius: 6px;
    transition: background 0.2s;
  }
  
  .title-description:focus{
    background: #f8fafc;
  }
  
  .details-btn{
    background: #f1f5f9;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 600;
    color: #475569;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .details-btn:hover{
    background: #e2e8f0;
    color: #334155;
  }
  
  .star-big{
    font-size: 24px;
    cursor: pointer;
    user-select: none;
    transition: transform 0.2s;
  }
  
  .star-big:hover{
    transform: scale(1.1);
  }
  
  .delete-x{
    position: absolute;
    top: 4px;
    right: 4px;
    background: transparent;
    border: none;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: bold;
    color: #9ca3af;
    cursor: pointer;
    transition: color 0.2s;
    padding: 0;
    margin: 0;
  }
  
  .delete-x:hover{
    color: #dc2626;
  }
  
  .emoji-modal{
    padding: 8px;
  }
  
  .emoji-grid{
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    max-width: 300px;
  }
  
  .emoji-option{
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .emoji-option:hover{
    background: #e2e8f0;
    border-color: #cbd5e1;
    transform: scale(1.05);
  }
  
  .emoji-option.selected{
    background: #dbeafe;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
  }
  
  .delete-modal{
    padding: 8px;
  }
  
  .inv-row{
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin: 8px 0;
    overflow: hidden;
    position: relative;
  }
  
  .inv-header{
    display: flex;
    justify-content: flex-start;
    align-items: center;
    padding: 8px 12px;
    background: #f1f5f9;
    border-bottom: 1px solid #e2e8f0;
    position: relative;
  }
  
  .inv-date{
    border: 1px solid #cbd5e1;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 12px;
    background: white;
  }
  
  .inv-delete{
    position: absolute;
    top: 2px;
    right: 2px;
    background: transparent;
    border: none;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #374151;
    cursor: pointer;
    transition: color 0.2s;
    padding: 0;
    margin: 0;
  }
  
  .inv-delete:hover{
    color: #dc2626;
  }
  
  .inv-content{
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .inv-content-compact{
    padding: 12px 24px 12px 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .inv-top-row{
    display: flex;
    gap: 12px;
    align-items: center;
  }
  
  .inv-url-container{
    flex: 1;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .inv-link-display{
    color: #0ea5e9;
    text-decoration: none;
    font-size: 14px;
    padding: 6px 8px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    background: #f8fafc;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .inv-link-display:hover{
    background: #e0f2fe;
    border-color: #0ea5e9;
  }
  
  .inv-edit-url{
    background: transparent;
    border: none;
    font-size: 12px;
    cursor: pointer;
    padding: 2px;
    opacity: 0.7;
    transition: opacity 0.2s;
  }
  
  .inv-edit-url:hover{
    opacity: 1;
  }
  
  .inv-date-compact{
    border: 1px solid #d1d5db;
    border-radius: 4px;
    padding: 6px 8px;
    font-size: 12px;
    background: white;
    width: 140px;
  }
  
  .inv-text-compact{
    width: 100%;
    min-height: 60px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 8px;
    resize: vertical;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.4;
  }
  
  .inv-link-compact{
    width: 100%;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 8px;
    font-size: 14px;
  }
  
  .inv-text{
    width: 100%;
    min-height: 80px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 12px;
    resize: vertical;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.5;
  }
  
  .inv-link{
    width: 100%;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 12px;
    font-size: 14px;
  }
  
  .add-inv-btn{
    background: #f0f9ff;
    border: 1px dashed #0ea5e9;
    border-radius: 6px;
    padding: 8px 16px;
    color: #0ea5e9;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    margin-top: 8px;
  }
  
  .add-inv-btn:hover{
    background: #e0f2fe;
    border-color: #0284c7;
  }
  
  .add-step-form{
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 8px;
    padding: 12px;
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
  }
  
  .step-input{
    flex: 1;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 8px;
    font-size: 14px;
  }
  
  .step-date{
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 8px;
    font-size: 12px;
    width: 140px;
  }
  
  .add-step-btn{
    background: #0ea5e9;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  
  .add-step-btn:hover{
    background: #0284c7;
  }
  
  .subtasks-list{
    margin-top: 8px;
    padding-left: 16px;
  }
  
  .subtask-item{
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    font-size: 14px;
    color: #4b5563;
  }
  
  .due-date{
    color: #6b7280;
    font-size: 12px;
  }
  
  .completed{
    text-decoration: line-through;
    color: #9ca3af;
  }
  
  .link-row{
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin: 8px 0;
    overflow: hidden;
    position: relative;
  }
  
  .link-content-compact{
    padding: 12px 24px 12px 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .link-top-row{
    display: flex;
    gap: 12px;
    align-items: center;
  }
  
  .link-label-compact{
    border: 1px solid #d1d5db;
    border-radius: 4px;
    padding: 6px 8px;
    font-size: 12px;
    background: white;
    width: 120px;
  }
  
  .link-url-container{
    flex: 1;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .link-url-display{
    color: #0ea5e9;
    text-decoration: none;
    font-size: 14px;
    padding: 6px 8px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    background: #f8fafc;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .link-url-display:hover{
    background: #e0f2fe;
    border-color: #0ea5e9;
  }
  
  .link-edit-url{
    background: transparent;
    border: none;
    font-size: 12px;
    cursor: pointer;
    padding: 2px;
    opacity: 0.7;
    transition: opacity 0.2s;
  }
  
  .link-edit-url:hover{
    opacity: 1;
  }
  
  .link-url-compact{
    width: 100%;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 8px;
    font-size: 14px;
  }
  
  .link-delete{
    position: absolute;
    top: 2px;
    right: 2px;
    background: transparent;
    border: none;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #374151;
    cursor: pointer;
    transition: color 0.2s;
    padding: 0;
    margin: 0;
  }
  
  .link-delete:hover{
    color: #dc2626;
  }
  
  .add-link-btn{
    background: #f0f9ff;
    border: 1px dashed #0ea5e9;
    border-radius: 6px;
    padding: 8px 16px;
    color: #0ea5e9;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    margin-top: 8px;
  }
  
  .add-link-btn:hover{
    background: #e0f2fe;
    border-color: #0284c7;
  }
  
  /* Calendar View Styles */
  .calendar-container{
    margin-top: 16px;
  }
  
  .calendar-header{
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
  }
  
  .calendar-view-toggle{
    display: flex;
    gap: 4px;
  }
  
  .calendar-view-btn{
    padding: 6px 12px;
    border: 1px solid #d1d5db;
    background: #fff;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .calendar-view-btn.active{
    background: #0ea5e9;
    color: #fff;
    border-color: #0ea5e9;
  }
  
  .calendar-nav{
    display: flex;
    align-items: center;
    gap: 16px;
  }
  
  .calendar-nav-btn{
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s;
  }
  
  .calendar-nav-btn:hover{
    background: #f3f4f6;
  }
  
  .calendar-title{
    font-size: 18px;
    font-weight: 700;
    color: #1f2937;
  }
  
  .month-grid{
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e5e7eb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .day-header{
    background: #f8fafc;
    padding: 8px;
    text-align: center;
    font-size: 12px;
    font-weight: 600;
    color: #6b7280;
  }
  
  .calendar-day{
    background: #fff;
    height: 120px;
    padding: 4px;
    position: relative;
    overflow-y: auto;
  }
  
  .calendar-day.other-month{
    background: #f9fafb;
    color: #9ca3af;
  }
  
  .calendar-day.week-day{
    height: 200px;
  }
  
  .day-header-row{
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
  }
  
  .day-number{
    font-size: 12px;
    font-weight: 600;
    color: #374151;
  }
  
  .day-expand-btn{
    background: none;
    border: none;
    font-size: 10px;
    color: #6b7280;
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 3px;
    transition: background 0.2s;
  }
  
  .day-expand-btn:hover{
    background: #f3f4f6;
    color: #374151;
  }
  
  .subtask-calendar-card{
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 4px;
    padding: 3px 4px;
    margin-bottom: 2px;
    font-size: 10px;
    position: relative;
    display: flex;
    align-items: flex-start;
    gap: 3px;
    min-height: 0;
    cursor: pointer;
  }
  
  .subtask-calendar-card.completed{
    opacity: 0.7;
  }
  
  .subtask-calendar-card.completed .card-content{
    text-decoration: line-through;
  }
  
  .subtask-calendar-card input[type="checkbox"]{
    display: none;
  }
  
  .subtask-calendar-card .card-content{
    flex: 1;
    min-width: 0;
    line-height: 1.2;
  }
  
  .subtask-calendar-card .action-title{
    font-weight: 600;
    color: #1e40af;
    font-size: 10px;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .subtask-calendar-card .subtask-title{
    color: #6b7280;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-top: 1px;
  }
  
  .no-date-section{
    margin-top: 24px;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
  }
  
  .no-date-section h3{
    margin: 0 0 12px 0;
    font-size: 14px;
    color: #374151;
    font-weight: 600;
  }
  
  .no-date-section .subtask-calendar-card{
    display: inline-flex;
    margin-right: 8px;
    margin-bottom: 8px;
    width: auto;
    max-width: 200px;
  }
  
  /* Week View Styles */
  .week-grid{
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e5e7eb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
  }
  
  /* Day Expand Modal Styles */
  .day-expand-content{
    padding: 16px 0;
  }
  
  .day-expand-title{
    margin: 0 0 16px 0;
    font-size: 18px;
    font-weight: 700;
    color: #1f2937;
  }
  
  .no-tasks{
    color: #6b7280;
    font-style: italic;
    text-align: center;
    padding: 32px;
  }
  
  .day-tasks-list{
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .expanded-subtask-card{
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #fff;
    overflow: hidden;
  }
  
  .expanded-card-header{
    padding: 12px 16px;
    background: #f8fafc;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .expanded-action-title{
    font-size: 14px;
    font-weight: 600;
    color: #1e40af;
    margin-bottom: 4px;
  }
  
  .expanded-subtask-title{
    font-size: 12px;
    color: #6b7280;
  }
  
  .expanded-card-content{
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .expanded-card-content input[type="checkbox"]{
    width: 16px;
    height: 16px;
  }
  
  .expanded-card-actions{
    display: flex;
    gap: 8px;
  }
  
  .btn-small{
    padding: 4px 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    background: #fff;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .btn-small:hover{
    background: #f3f4f6;
  }
  
  .btn-small.danger{
    color: #dc2626;
    border-color: #fecaca;
  }
  
  .btn-small.danger:hover{
    background: #fef2f2;
    border-color: #fca5a5;
  }
  
  /* Right-click Context Menu */
  .context-menu{
    position: fixed;
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    z-index: 1000;
    min-width: 150px;
    padding: 4px 0;
  }
  
  .context-menu-item{
    padding: 8px 12px;
    font-size: 14px;
    color: #374151;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .context-menu-item:hover{
    background: #f3f4f6;
  }
  
  .context-menu-item.danger{
    color: #dc2626;
  }
  
  .context-menu-item.danger:hover{
    background: #fef2f2;
  }
  /* Modal forms & actions (no new classes needed) */
/* Modal action buttons — size, centering, spacing */
#modalBody .right{
    margin-top:auto;
    display:flex;
    justify-content:flex-end;
    gap:12px;
    padding-top:12px;
  }
  
  #modalBody .right .btn,
  #modalBody .right .btn-teal,
  #modalBody .right .btn-destructive,
  #modalBody .right .iconbtn{
    height:38px;              /* a touch smaller */
    min-width:110px;          /* narrower buttons */
    padding:0 14px;
    display:inline-flex;      /* ensure centering */
    align-items:center;       /* vertical center */
    justify-content:center;   /* horizontal center */
    line-height:1;            /* kill baseline drift */
    font-size:15px;           /* slightly bigger text */
    border-radius:12px;
  }
  
/* === Unified toolbar row + search === */
.toolbarRow{
  display:flex;
  align-items:flex-end;
  gap:15px;
  margin:4px 0 30px; /* 4px up from tabs, 30px down to content for more space */
  flex-wrap:nowrap;           /* keep on one line */
  overflow-x:auto;            /* scroll if overflow */
}
/* Add button styling */
.btn-teal{
  margin-left:6px;
}
.toolbarLeft{ display:flex; align-items:flex-end; gap:12px; min-width:0 }
.searchWrap{
  position:relative;
  /* flex:1;            ← remove this */
  flex:0 1 220px;          /* narrower so filters fit */
  min-width:200px;
}
.searchWrap .searchIcon{ /* dedicated container to avoid conflicts with generic .icon */
  position:absolute;
  left:4px;
  top:50%;
  transform:translateY(-50%);
  pointer-events:none;
}
.searchWrap input[type="search"]{
  width:100%;
  height:36px;
  padding:8px 10px 8px 30px;  /* tiny left padding after the icon */
  border:1px solid #d1d5db;
  border-radius:10px;
  background:#fff;
  font-size:12px;
}

/* Right side container for segmented controls / view icons / Add button */
.toolbarRight{
  display:flex;
  align-items:flex-end;
  gap:15px;
  margin-left:auto;           /* pushes this cluster to the right */
}

/* Segmented control (replaces chips) */
.segControl{
  display:inline-flex;
  border:1px solid #e5e7eb;
  border-radius:12px;
  background:#fff;
  overflow:hidden;
}
.segBtn{
  appearance:none;
  border:0;
  padding:8px 14px;
  font:12px system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
  background:transparent;
  cursor:pointer;
  transition:background .15s ease, color .15s ease;
  white-space:nowrap;
}
.segBtn + .segBtn{ border-left:1px solid #e5e7eb; }
.segBtn:hover{ background:#f8fafc; }
.segBtn:focus{ outline:2px solid #94d1ff; outline-offset:-2px; }
.segBtn.isActive{
  background:#f3cf8d;
  color:#1f2937;
  font-weight:600;
}

/* Table / Funnel tiny icon buttons (text 6px above icon) */
.viewSwitch{ display:flex; align-items:center; gap:8px; }
.viewBtn{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  cursor:pointer;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:4px 6px;
  background:#fff;
}
.viewBtn .label{
  font-size:6px; line-height:1; text-transform:uppercase; letter-spacing:.04em; color:#6b7280;
}
.viewBtn .icon svg{ width:18px; height:18px; display:block; }
.viewBtn.isActive{ background:#f3cf8d; border-color:#e1c27a; }
.viewBtn:focus{ outline:2px solid #94d1ff; outline-offset:2px; }

/* Entrepreneurship (Ideas) Styles */
.ideas-v1 .idea {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  margin-bottom: 16px;
  overflow: hidden;
  transition: all 0.2s ease;
}

.ideas-v1 .idea.open {
  border-color: #00B4D8;
}

.ideas-v1 .idea-head-new {
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  background: #f8fafc;
  border-bottom: 1px solid #e5e7eb;
}

.ideas-v1 .emoji-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  transition: background 0.2s;
}

.ideas-v1 .emoji-btn:hover {
  background: #e5e7eb;
}

.ideas-v1 .title-description {
  flex: 1;
  border: none;
  background: none;
  font-size: 16px;
  font-weight: 600;
  color: #1f2937;
  outline: none;
}

.ideas-v1 .details-btn {
  background: #00B4D8;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s;
}

.ideas-v1 .details-btn:hover {
  background: #0284c7;
}

.ideas-v1 .star-big {
  font-size: 20px;
  cursor: pointer;
  padding: 4px;
}

.ideas-v1 .delete-x {
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.ideas-v1 .idea-body {
  padding: 16px;
  display: none;
}

.ideas-v1 .idea.open .idea-body {
  display: block;
}

.ideas-v1 .idea-section {
  margin-bottom: 20px;
}

.ideas-v1 .section-title {
  font-size: 14px;
  font-weight: 600;
  color: #374151;
  margin: 0 0 8px 0;
}

.ideas-v1 .input-card {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px;
}

.ideas-v1 .action-card-simple {
  background: #f8fafc;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
}

.ideas-v1 .action-head-simple {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.ideas-v1 .action-title-simple {
  font-weight: 600;
  color: #1f2937;
}

.ideas-v1 .action-date-simple {
  font-size: 12px;
  color: #6b7280;
}

.ideas-v1 .action-notes-simple {
  color: #6b7280;
  font-size: 14px;
  margin-bottom: 8px;
}

.ideas-v1 .sub-row-simple {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
}

.ideas-v1 .sub-content-simple {
  flex: 1;
}

.ideas-v1 .sub-date-simple {
  color: #6b7280;
  font-size: 12px;
}

.ideas-v1 .sub-delete-btn {
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.ideas-v1 .action-foot-simple {
  display: flex;
  justify-content: flex-end;
  margin-top: 8px;
}

.ideas-v1 .btn-small {
  background: #00B4D8;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
}

.ideas-v1 .btn-outline {
  background: none;
  border: 1px solid #00B4D8;
  color: #00B4D8;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.ideas-v1 .btn-outline:hover {
  background: #00B4D8;
  color: white;
}

.ideas-v1 .done {
  text-decoration: line-through;
  color: #6b7280;
}

.emoji-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
  padding: 16px;
}

.emoji-option {
  background: none;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.2s;
}

.emoji-option:hover {
  border-color: #00B4D8;
  background: #f0f9ff;
}

/* Dashboard 360 Toggle Styles */
/* Make header a flex row so the toggle can sit on the far right */
.module-header { display:flex; align-items:center }

/* Toggle styling */
.dash360-toggle{ margin-left:auto; display:inline-flex; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden }
.dash360-tab{ padding:6px 12px; background:#fff; border:0; cursor:pointer }
.dash360-tab.is-active{ 
  background: var(--sand) !important;
  border-color: #d4a853 !important;   /* slightly darker border like menu */
  color: #1f2937 !important;          /* readable on yellow */
}

/* Top controls */
.dash360-top-controls{display:flex;gap:12px;align-items:center;padding:12px 0;border-bottom:1px solid #e5e7eb;margin-bottom:16px}
.dash360-search{position:relative;flex:1;min-width:220px;background:#fff;border:1px solid #e5e7eb;border-radius:12px}
.dash360-search .ico{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.6}
.dash360-search input[type="search"]{width:100%;height:40px;border:0;outline:0;border-radius:12px;padding:8px 12px 8px 34px;background:#fff;font:inherit}

/* List */
.dash360-companies-list{display:flex;flex-direction:column;gap:12px}

/* Company card = Entrepreneurship look, scoped */
.dash360-company-card{
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:12px;
  overflow:hidden;
  transition:all .2s ease;
}
.dash360-company-card.open{ border-color:#00B4D8; }           /* matches ideas-v1 .idea.open */

/* Header = ideas-v1 .idea-head-new */
.dash360-card-header{
  padding:16px;
  display:flex;
  align-items:center;
  gap:12px;
  background:#f8fafc;
  border-bottom:1px solid #e5e7eb;
}
.dash360-card-header img{
  width:28px;height:28px;object-fit:contain;
  border-radius:6px;border:1px solid #e5e7eb;background:#fff;
}
.dash360-company-name{
  flex:1; min-width:0;
  font-weight:600; font-size:16px; color:#1f2937;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}



/* Star = ideas "star-big" feel */
.dash360-star{
  background:none;border:0;cursor:pointer;line-height:1;
  font-size:20px; padding:4px;
}



/* Section box = ideas "section" look (local copy) */
.dash360-section{
  background:#f1f5f9;
  border:1px solid #e2e8f0;
  border-radius:12px;
  padding:16px;
  margin:12px 0;
  box-shadow:0 1px 3px rgba(0,0,0,.05);
}
.dash360-section > h4{
  margin:0 0 12px;.dash360-inv-text 
  font-size:14px;
  font-weight:600;
  letter-spacing:.2px;
  color:#0ea5e9;
}

/* Notes */
.dash360-section textarea{width:100%;min-height:80px;resize:vertical;border:1px solid #e5e7eb;border-radius:8px;padding:12px;outline:0;white-space:pre-wrap}

/* Generic row used by Jobs etc. */
.dash360-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:8px;align-items:start;padding:10px;border:1px solid #eef2f7;border-radius:10px;background:#fff}
.dash360-row:hover{background:#f9fafb}
.dash360-row-notes{grid-column:1/-1}
.dash360-empty{padding:12px;color:#6b7280;font-style:italic;background:#f8fafc;border:1px dashed #e5e7eb;border-radius:8px}

/* Scope under #dash360-root to win specificity and avoid clashes */
#dash360-root .dash360-details{
  background:#00B4D8;
  color:#fff;
  border:none;
  padding:6px 12px;
  border-radius:6px;
  font-size:14px;
  cursor:pointer;
  transition:background .2s;
}
#dash360-root .dash360-details:hover{ background:#0284c7; }

/* Dash360 logo box + image — 24px, radius 4px */
#dash360-root .dash360-logo{
  width:24px;height:24px;
  border:1px solid #e5e7eb;
  border-radius:4px;
  background:#fff;
  display:grid;place-items:center;overflow:hidden;
}
#dash360-root .dash360-logo img{
  width:100%;height:100%;object-fit:contain;
}
#dash360-root .dash360-logo-badge{
  width:100%;height:100%;
  display:grid;place-items:center;
  font-weight:700;color:#334155;background:#f1f5f9;
}

/* Already present—keep this single source of truth */
.dash360-details-panel{ padding:16px; display:none; background:#f8fafc; }
.dash360-company-card.open .dash360-details-panel{ display:block; }

/* === Dash360 Company view tweaks (scoped) === */

/* 1) Star bigger; add a little space so Details sits visually more left */
#dash360-root .dash360-star { font-size: 24px; }         /* was ~20px */
#dash360-root .dash360-details { margin-right: 8px; }     /* extra gap before the star */

/* 2) Search ~10% narrower within top controls */
#dash360-root .dash360-top-controls { display:flex; align-items:center; gap:12px; }
#dash360-root .dash360-search { flex: 0 1 80%; max-width: 80%; }

/* Company view: favorite filter matches Entrepreneurship */
#dash360-root .ideas-switch{
  display:inline-flex;
  align-items:center;
  gap:8px;
  color:#374151;
  font-weight:600;
}
#dash360-root .ideas-switch input[type="checkbox"]{ width:16px; height:16px; }
#dash360-root .ideas-switch span{ /* capitalization safeguard if text ever comes lowercased */
  text-transform:none; /* we already set the exact text */
}
/* neutralize any legacy switch pseudo-decorations inside Dash360 */
#dash360-root .ideas-switch::before,
#dash360-root .ideas-switch::after{ content:none !important; }

/* Dash360: section titles with leading icon */
#dash360-root .dash360-h4{
  display:flex; align-items:center; gap:8px;
  margin:0 0 12px; font-weight:700; font-size:14px; letter-spacing:.2px;
  color:#0ea5e9;
}
#dash360-root .dash360-h4::before{
  content: attr(data-ico);
  font-size:18px; line-height:1; transform: translateY(1px);
}

/* Entrepreneurship Details button — match Dash360 look */
.ideas-v1 .details-btn,
.ideas-module .details-btn {
  background: #00B4D8;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s;
}

.ideas-v1 .details-btn:hover,
.ideas-module .details-btn:hover {
  background: #0284c7;
}

/* Dash360: section wrappers + empty state */
#dash360-root .dash360-section{ padding:12px 16px; border-top:1px solid #e5e7eb; }
#dash360-root .dash360-empty{ color:#6b7280; font-style:italic; padding:8px 0; }

/* Dash360 — Investigation Log (Entrepreneurship parity) */
#dash360-root .dash360-inv-list{ display:flex; flex-direction:column; gap:12px; }
#dash360-root .dash360-inv-card{
  position:relative; padding:12px; border:1px solid #e5e7eb; border-radius:12px;
  background:#f7fbff;
}
#dash360-root .dash360-inv-close{
  position: absolute;
  top: 2px;
  right: 2px;
  background: transparent;
  border: none;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #374151;
  cursor: pointer;
  transition: color 0.2s;
  padding: 0;
  margin: 0;
}
#dash360-root .dash360-inv-fields{ display:grid; grid-template-columns: 160px 1fr; gap:12px; margin-bottom:10px; }
#dash360-root .dash360-inv-url-container{
  flex: 1;
  display: flex;
  align-items: center;
  gap: 6px;
}
#dash360-root .dash360-inv-fields input[type="date"],
#dash360-root .dash360-inv-fields input[type="url"]{
  width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:8px;
}
#dash360-root .dash360-inv-text{
  width: 100%;
  min-height: 60px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  padding: 8px;
  resize: vertical;
  font-family: inherit;
  font-size: 14px;
  line-height: 1.4;
}
#dash360-root .dash360-inv-add{

    display: flex;
    background: #f0f9ff;
    border: 1px dashed #0ea5e9;
    border-radius: 6px;
    padding: 8px 16px;
    color: #0ea5e9;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
    margin-top: 8px;
    justify-content:center; 
    align-items:center;

}
#dash360-root .dash360-inv-add:hover{background: #e0f2fe;
  border-color: #0284c7;}
#dash360-root .dash360-section textarea {
  padding: 12px 16px !important;

/* Company Notes section (what you already added) */
#dash360-root .dash360-notes-sec{
  padding:12px 16px;
}
#dash360-root .dash360-notes-sec textarea{
  width:100%;
  box-sizing:border-box;
}

/* Investigation log — make URL row + textarea “shorter” with equal insets */
#dash360-root .dash360-inv-card .dash360-inv-fields{
  margin:0 16px;           /* horizontal inset for the date+URL row */
}

#dash360-root .dash360-inv-card .dash360-inv-text{
  margin:12px 16px 0;      /* horizontal inset + little gap below URL row */
  width:auto;              /* override earlier width:100% so margins work */
  box-sizing:border-box;   /* safer if you later add padding/border */
}

/* Keep the close × pinned to the card corner */
#dash360-root .dash360-inv-card{ position:relative; }
#dash360-root .dash360-inv-close{
  position:absolute; top:10px; right:10px;
}
/* Push content down and left so it clears the close "×" comfortably */
#dash360-root .dash360-inv-card{
  padding: 22px 42px 16px 16px; /* top  right  bottom  left */
  position: relative;           /* (should already be set) */
}

#dash360-root .dash360-inv-close{
  position: absolute;
  top: 10px;
  right: 10px;                  /* the "×" stays fixed here */
}

/* Dash360 Confirmation Modal Styles */
#dash360-root .dash360-confirm-modal {
  position: fixed !important;
  inset: 0 !important;
  display: flex !important;
  align-items: center;
  justify-content: center;
  z-index: 99999 !important;
  background: rgba(15,23,42,.45) !important;
}
#dash360-root .dash360-confirm-modal .d360-box {
  background: #fff !important;
  border: 1px solid #e5e7eb !important;
  border-radius: 12px !important;
  box-shadow: 0 20px 50px rgba(2,6,23,.25) !important;
  width: min(92vw,560px) !important;
  overflow: hidden !important;
}
#dash360-root .dash360-confirm-modal .d360-head {
  background: #00B4D8 !important;
  color: #fff !important;
  font-weight: 800 !important;
  padding: 14px 16px !important;
}
#dash360-root .dash360-confirm-modal .d360-body {
  padding: 18px 16px 6px !important;
  color: #1f2937 !important;
  font-size: 18px !important;
}
#dash360-root .dash360-confirm-modal .d360-sub {
  padding: 0 16px 16px !important;
  color: #64748b !important;
}
#dash360-root .dash360-confirm-modal .d360-foot {
  padding: 12px 16px !important;
  display: flex !important;
  justify-content: flex-end !important;
  gap: 12px !important;
  border-top: 1px solid #eef2f7 !important;
}
#dash360-root .dash360-confirm-modal .btn {
  appearance: none !important;
  border-radius: 10px !important;
  padding: 10px 16px !important;
  font-weight: 700 !important;
  border: 1px solid #e5e7eb !important;
  background: #fff !important;
  color: #0f172a !important;
  cursor: pointer !important;
}
#dash360-root .dash360-confirm-modal .btn-danger {
  border: none !important;
  background: #e11d48 !important;
  color: #fff !important;
}
#dash360-root .dash360-confirm-modal .btn:hover {
  background: #f8fafc !important;
}
#dash360-root .dash360-confirm-modal .btn-danger:hover {
  background: #be123c !important;
}

/* Dash360 — Job card layout (Company view) */
#dash360-root .dash360-job-card{
  background:#f8fbff;
  border:1px solid #e6edf6;
  border-radius:14px;
  box-shadow:0 1px 0 rgba(0,0,0,.02);
  padding:16px;

  /* force two columns like Entrepreneurship */
  display:grid !important;
  grid-template-columns:1fr 2fr !important; /* left / right */
  gap:16px !important;
  align-items:start !important;
}

/* LEFT column */
#dash360-root .dash360-job-left .job-title{
  font-weight:800; font-size:18px; margin-bottom:6px; color:#0f172a;
}
#dash360-root .dash360-job-left .meta-row{
  display:flex; align-items:center; gap:10px; margin:6px 0; color:#111827;
}
#dash360-root .dash360-job-left .meta-row .ico{
  width:22px; text-align:center; opacity:.9;
}
#dash360-root .dash360-status{
  display:inline-block; padding:2px 10px; border-radius:9999px;
  background:#e6f4ff; color:#0369a1; font-weight:700; font-size:12px;
}

/* RIGHT column */
#dash360-root .dash360-job-right{
  border-left:1px solid #e5e7eb; padding-left:16px;
}
#dash360-root .dash360-job-right .notes-label{
  font-weight:700; margin-bottom:6px; color:#0f172a;
}
#dash360-root .dash360-job-right textarea{
  width:100%; min-height:100px; resize:vertical;
  border:1px solid #e5e7eb; border-radius:10px;
  padding:12px 14px; background:#fff; box-sizing:border-box;
}

  /* empty state */
  #dash360-root .dash360-empty{ color:#6b7280; padding:8px 4px; }

  /* === Dashboard 360 > Company > Next Actions (scoped) === */

  /* Extra space between cards */
  .dash360-section-body .na-v16{
    display:flex; flex-direction:column; gap:18px;
  }

  /* Extra space below the info chip */
  .dash360-section-body .na-info{ margin-bottom:18px; }

  /* Head icons (Edit/Expand/Delete) */
  .dash360-section-body .na-v16 .head-icons .iconbtn{
    width:32px; height:32px; padding:0; border-radius:10px;
    background:#f3f4f6; border:1px solid #e5e7eb;
    display:inline-flex; align-items:center; justify-content:center;
  }
  .dash360-section-body .na-v16 .head-icons .iconbtn:hover{ background:#eef1f4; }
  .dash360-section-body .na-v16 .head-icons .iconbtn .ico svg{ width:16px; height:16px; display:block; }

  /* Subtask tiny trash */
  .dash360-section-body .na-v16 .sub-icons .iconbtn.tiny{
    width:26px; height:26px; padding:0; border-radius:10px;
    background:#f3f4f6; border:1px solid #e5e7eb;
  }
  .dash360-section-body .na-v16 .sub-icons .iconbtn.tiny .ico svg{ width:14px; height:14px; }

  /* Add Action button - matching Useful Links styling */
  .dash360-section-body .na-v16 .btn-dashed-full{
    display:block; width:100%;
    margin-top:12px;
    background:#f0f9ff;
    border:1px dashed #0ea5e9;
    border-radius:6px;
    padding:12px 16px;
    text-align:center;
    color:#0ea5e9;
    font-weight:700;
    cursor:pointer;
  }
  .dash360-section-body .na-v16 .btn-dashed-full:hover{ background:#e0f2fe; }

    
</style>
</head>
<body>
  <div class="topbar">
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <div class="brand">
        <span class="logo" aria-label="Oppli logo">
          <svg width="34" height="34" viewBox="0 0 100 100" role="img" aria-label="Oppli">
            <rect x="10" y="10" width="80" height="80" rx="16" ry="16" fill="#00CED1"/>
            <path d="M25 50l15 15 35-35" stroke="#002B5B" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        <span style="font-size:18px">Oppli</span>
      </div>
      <div class="actions" id="actionsMenu">
        <button class="gearbtn" id="gearBtn" title="Settings">
          <!-- Simple gear icon -->
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          <span>Settings</span>
        </button>
        <div class="menu" id="settingsMenu" role="menu" aria-hidden="true">
          <div class="item" id="menuExport"><svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2l-5.5 5.5L8 9l2-2v7h4V7l2 2 1.5-1.5L12 2z"/></svg> Export backup</div>
          <label class="item" for="fileImport"><svg viewBox="0 0 24 24"><path d="M19 13v6H5v-6H3v8h18v-8h-2zM11 3v8H8l4 4 4-4h-3V3h-2z"/></svg> Import backup</label>
          <input id="fileImport" type="file" accept="application/json" style="display:none" />
        </div>
      </div>
    </div>
  </div>

  <div class="container stack-gap" style="margin-top:12px">
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="companies">Companies</div>
      <div class="tab" data-tab="jobs">Jobs</div>
      <div class="tab" data-tab="chats">Coffee chats</div>
      <div class="tab" data-tab="contacts">Contacts</div>
      <div class="tab" data-tab="actions">Next actions</div>
      <div class="tab" data-tab="ideas">Dashboard 360</div>
    </div>
    <div id="view"></div>
  </div>

  <div class="modal-backdrop" id="modalBack" style="display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.3);position:fixed;inset:0;z-index:50">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" style="background:#fff;border-radius:16px;max-width:680px;width:92%;max-height:70vh;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.12);display:flex;flex-direction:column">
      <div class="modal-head" style="padding:14px 16px;background:#00B4D8;color:#fff;font-weight:700;display:flex;justify-content:space-between;align-items:center;border-radius:16px 16px 0 0;flex-shrink:0">
        <div id="modalTitle">Modal</div>
        <button class="close-x" id="modalClose" style="background:transparent;border:0;color:#fff;font-size:18px;cursor:pointer">×</button>
      </div>
      <div class="modal-body" id="modalBody" style="padding:14px 16px;overflow-y:auto;flex:1;min-height:0"></div>
    </div>
  </div>

<script>
/* ---------------- Persistence ---------------- */
const KEY = document.documentElement.getAttribute("data-rolemap-key");
if (!KEY) {
  throw new Error("Missing data-rolemap-key on <html> element!");
}

const sampleDB = {
  companies:[{id:'cmp-wise',name:'Wise',type:'Dream',website:'https://wise.com',sector:'Fintech',subSector:'Payments',location:'London, UK',priority:'High',employees:'',valuation:'',description:'',createdAt:new Date().toISOString(),lastInteractionAt:new Date().toISOString(),notes:'Top choice'},{id:'cmp-monzo',name:'Monzo',type:'Other',website:'https://monzo.com',sector:'Fintech',subSector:'Banking',location:'London, UK',priority:'Medium',employees:'3000',valuation:'4B',description:'App-based bank',createdAt:new Date().toISOString(),lastInteractionAt:'',notes:''}],
  jobs:[{id:'job-wise-pm',title:'Product Manager',companyId:'cmp-wise',sourceLink:'https://careers.wise.com/pm',salary:'',location:'London',status:'Applied',notes:'',lastFollowUp:new Date().toISOString().slice(0,10)}],
  contacts:[{id:'ctc-john',name:'John Doe',role:'Director of Product',department:'Product',companyId:'cmp-wise',email:'john@wise.com',linkedIn:'https://linkedin.com/in/johndoe',relStrength:'Warm',howWeMet:'Event',notes:'Platform reliability'}],
  chats:[{id:'cht-john',contactId:'ctc-john',companyId:'cmp-wise',jobId:'job-wise-pm',description:'Discuss PM role',status:'Scheduled',channel:'LinkedIn',dateScheduled:new Date(Date.now()+3*86400000).toISOString().slice(0,10),notes:'Bring 3 questions'}],
  actions:[
    {id:'act-demo', title:'Break into Wise PM', relatedType:'Job', relatedId:'job-wise-pm', description:'Plan next 2 weeks.',
     createdAt:new Date().toISOString(),
     subactions:[
       {id:'sub1', title:'Reach out to recruiter', description:'Email John', due:'', done:false},
       {id:'sub2', title:'Prepare interview answers', description:'STAR stories', due:'', done:true}
     ]}
  ],
  ideas:[],
  version:9
};
// demo dates: one overdue (yesterday) and one future (+5 days)
(function(){
  const y = new Date(Date.now()-86400000).toISOString().slice(0,10);
  const f = new Date(Date.now()+5*86400000).toISOString().slice(0,10);
  sampleDB.actions[0].subactions[0].due = y;
  sampleDB.actions[0].subactions[1].due = f;
})();
let db = load();
function load(){ try{ const raw = localStorage.getItem(KEY); return raw? JSON.parse(raw) : sampleDB; }catch(e){ return sampleDB; } }
function save(){ try{ localStorage.setItem(KEY, JSON.stringify(db)); }catch(e){ console.error('Save failed', e); alert('Save failed: ' + e.message); } }

/* ---------------- Images (IndexedDB) ---------------- */
const IMAGES_DB_NAME = 'rolemap-images';
const IMAGES_DB_VERSION = 1;
let _imagesDbPromise = null;

function openImagesDB(){
  if (_imagesDbPromise) return _imagesDbPromise;
  _imagesDbPromise = new Promise((resolve, reject)=>{
    const req = indexedDB.open(IMAGES_DB_NAME, IMAGES_DB_VERSION);
    req.onupgradeneeded = ()=>{
      const dbi = req.result;
      if (!dbi.objectStoreNames.contains('logos')) {
        dbi.createObjectStore('logos', { keyPath: 'id' });
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
  return _imagesDbPromise;
}
async function logosPut(id, blob, type){
  const dbi = await openImagesDB();
  return new Promise((resolve,reject)=>{
    const tx = dbi.transaction('logos','readwrite');
    tx.objectStore('logos').put({id, blob, type});
    tx.oncomplete = ()=> resolve();
    tx.onerror = ()=> reject(tx.error);
  });
}
async function logosGet(id){
  const dbi = await openImagesDB();
  return new Promise((resolve,reject)=>{
    const tx = dbi.transaction('logos','readonly');
    const req = tx.objectStore('logos').get(id);
    req.onsuccess = ()=> resolve(req.result || null);
    req.onerror = ()=> reject(req.error);
  });
}
async function logosDelete(id){
  const dbi = await openImagesDB();
  return new Promise((resolve,reject)=>{
    const tx = dbi.transaction('logos','readwrite');
    tx.objectStore('logos').delete(id);
    tx.oncomplete = ()=> resolve();
    tx.onerror = ()=> reject(tx.error);
  });
}
function dataUrlToBlob(dataUrl){
  return fetch(dataUrl).then(r=>r.blob());
}
function blobToDataUrl(blob){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=> resolve(String(fr.result));
    fr.onerror = reject;
    fr.readAsDataURL(blob);
  });
}
async function processImage(file){
  const maxDim = 256;
  const quality = 0.8;
  const budget = 20*1024;
  const img = await new Promise((resolve,reject)=>{
    const o = new Image();
    o.onload = ()=> resolve(o);
    o.onerror = reject;
    o.src = URL.createObjectURL(file);
  });
  const w = img.naturalWidth || img.width;
  const h = img.naturalHeight || img.height;
  const scale = Math.min(1, maxDim / Math.max(w,h));
  const outW = Math.max(1, Math.round(w*scale));
  const outH = Math.max(1, Math.round(h*scale));
  const canvas = document.createElement('canvas');
  canvas.width = outW; canvas.height = outH;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, outW, outH);
  URL.revokeObjectURL(img.src);
  const blob = await new Promise((resolve)=>{
    canvas.toBlob(b=>{
      if (!b) { canvas.toBlob(b2=> resolve(b2), 'image/jpeg', quality); return; }
      if (b.size > budget) { canvas.toBlob(b2=> resolve(b2), 'image/jpeg', quality); } else { resolve(b); }
    }, 'image/webp', quality);
  });
  let finalBlob = blob;
  let type = (finalBlob && finalBlob.type) || 'image/webp';
  if (!finalBlob) { finalBlob = file; type = file.type || 'image/jpeg'; }
  if (finalBlob.size > budget) throw new Error('Logo is too large after compression (over 20 KB). Please choose a smaller image.');
  return { blob: finalBlob, type };
}
// Backward-compat migration for legacy data URL logos
(async function migrateLegacyLogos(){
  try{
    (db.companies||[]).forEach(c=>{ if (!('logoId' in c)) c.logoId = ''; });
    const ops = (db.companies||[]).map(async (c)=>{
      const legacy = c && (c.logo || c.logoDataUrl);
      if (legacy && typeof legacy === 'string' && legacy.startsWith('data:')){
        const id = 'logo-' + c.id;
        const blob = await dataUrlToBlob(legacy);
        await logosPut(id, blob, blob.type || 'image/jpeg');
        c.logoId = id; delete c.logo; delete c.logoDataUrl;
      }
    });
    await Promise.all(ops);
    save();
  }catch(e){}
})();

/* ---------------- UI helpers ---------------- */
const $ = sel => document.querySelector(sel);
function el(tag, attrs={}, children=[]) { const n = document.createElement(tag); for (const k in attrs){ if(k==='class') n.className = attrs[k]; else if(k==='html') n.innerHTML = attrs[k]; else n.setAttribute(k, attrs[k]); } for (const c of children){ n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c); } return n; }
function uid(prefix){ return prefix+'-'+Math.random().toString(36).slice(2,10); }
function icon(name){
  const span = el('span', {class:'icon', 'aria-hidden':'true'});
  const svgNS = 'http://www.w3.org/2000/svg';
  const s = document.createElementNS(svgNS,'svg'); s.setAttribute('viewBox','0 0 24 24'); s.setAttribute('width','18'); s.setAttribute('height','18');
  const p = document.createElementNS(svgNS,'path');
  if(name==='edit'){ p.setAttribute('d','M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z'); }
  if(name==='trash'){ p.setAttribute('d','M6 7h12v2H6V7zm2 3h8l-1 9H9L8 10zm3-7h2l1 2h4v2H6V5h4l1-2z'); }
  if(name==='filter'){ p.setAttribute('d','M3 5h18v2l-7 7v5l-4-2v-3L3 7V5z'); }
  if(name==='sort'){ p.setAttribute('d','M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z'); }
  if(name==='dots'){ p.setAttribute('d','M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z'); }
  if(name==='plus'){ p.setAttribute('d','M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z'); }
  if(name==='expand'){p.setAttribute('d','M4 10V4h6v2H6v4H4zm10-6h6v6h-2V6h-4V4zm6 10v6h-6v-2h4v-4h2zM10 20H4v-6h2v4h4v2z');}
  if(name==='search'){ p.setAttribute('d','M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5 1.5-1.5-5-5zM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'); }
  if(name==='warning'){ p.setAttribute('d','M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z'); }
  if(name==='close'){
    p.setAttribute('d','M6 6L18 18M6 18L18 6');
    p.setAttribute('fill','none');
    p.setAttribute('stroke','currentColor');
    p.setAttribute('stroke-width','2');
    p.setAttribute('stroke-linecap','round');
  }
  if(name==='table'){
    p.setAttribute('d','M3 3h18v18H3V3zm2 2v4h5V5H5zm7 0v4h7V5h-7zM5 11v4h5v-4H5zm7 0v4h7v-4h-7z');
  }
  if(name==='funnel'){
    p.setAttribute('d','M3 5h18v2l-7 7v5l-4-2v-3L3 7V5z');
  }
  if(name==='board'){
    // simple kanban board: two small cards in first two columns, one tall column on the right
    p.setAttribute('d',
      'M3 6h6v3H3V6z' +        // left col, top card
      'M3 11h6v3H3v-3z' +      // left col, bottom card
      'M10 6h6v3h-6V6z' +      // middle col, top card
      'M10 11h6v3h-6v-3z' +    // middle col, bottom card
      'M17 6h4v8h-4V6z'        // right col, tall card
    );
  }
  if(name==='calendar'){
    p.setAttribute('d','M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7v-5z');
  }
  if(name==='check'){
    p.setAttribute('d','M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z');
  }
  s.appendChild(p); span.appendChild(s); return span;
}
/* Build a search input with left icon */
function makeSearch(placeholder, onChange){
  const wrap = el('div',{class:'searchWrap'});
  const ic = el('span',{class:'searchIcon'},[icon('search')]);
  wrap.appendChild(ic);
  const input = el('input',{type:'search', placeholder});
  input.oninput = ()=> onChange && onChange(input.value);
  wrap.appendChild(input);
  return {wrap, input};
}

/* ---------------- Dash360 helpers ---------------- */
function dash360Debounce(fn, delay){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); }; }
function dash360El(tag, attrs={}, children=[]){
  const el=document.createElement(tag);
  for(const [k,v] of Object.entries(attrs||{})){
    if(k==='class') el.className=v;
    else el.setAttribute(k,v);
  }
  (Array.isArray(children)?children:[children]).forEach(c=>{
    if(c==null) return;
    el.appendChild(typeof c==='string'?document.createTextNode(c):c);
  });
  return el;
}

/* ---------------- Dash360 toggle functionality ---------------- */
function dash360SwitchView(view){
  // Find the Entrepreneurship content - it's everything except the module header
  const entreRoot = document.querySelector('.ideas-module');
  let dashRoot = document.querySelector('#dash360-root');
  
  if(!dashRoot){
    dashRoot = document.createElement('div');
    dashRoot.id = 'dash360-root';
    dashRoot.className = 'dash360-module';
    (entreRoot?.parentElement || document.body).appendChild(dashRoot);
  }
  
  if(view==='company'){
    // Hide Entrepreneurship content (everything except header)
    if(entreRoot) {
      // Hide the toolbar and list, but keep the header visible
      const toolbar = entreRoot.querySelector('.toolbar');
      const list = entreRoot.querySelector('.list');
      if(toolbar) toolbar.style.display = 'none';
      if(list) list.style.display = 'none';
    }
    // Show Company view
    dashRoot.style.display = 'block';
    dash360RenderCompanyView(dashRoot);
  }else{
    // Show Entrepreneurship content
    if(entreRoot) {
      const toolbar = entreRoot.querySelector('.toolbar');
      const list = entreRoot.querySelector('.list');
      if(toolbar) toolbar.style.display = '';
      if(list) list.style.display = '';
    }
    // Hide Company view
    dashRoot.style.display = 'none';
  }
}



function dash360ApplyLogo(img, company){
  const fallback = () => {
    const wrap = img.parentElement;
    const initial = (company.name||'?').trim().charAt(0).toUpperCase() || '?';
    const badge = dash360El('div',{class:'dash360-logo-badge'},[initial]);
    if (wrap && img.isConnected) wrap.replaceChild(badge, img);
  };
  img.addEventListener('error', fallback, { once:true });

  // Prefer logoId via IndexedDB
  if (company.logoId && typeof logosGet === 'function') {
    logosGet(company.logoId).then(rec => {
      if (rec?.blob) img.src = URL.createObjectURL(rec.blob);
      else if (company.logoUrl) img.src = company.logoUrl;
      else fallback();
    }).catch(() => {
      if (company.logoUrl) img.src = company.logoUrl; else fallback();
    });
    return;
  }

  // Fallback to plain URL
  if (company.logoUrl) img.src = company.logoUrl; else fallback();
}

/* ---------------- Dash360 Data Management ---------------- */
function dash360Load(){ 
  try{ 
    return JSON.parse(localStorage.getItem('dash360:companies')||'[]'); 
  }catch(e){ 
    return []; 
  } 
}

// ============ Dash360 Canonical Data Layer (single source of truth) ============
function dash360Load(){ try{ return JSON.parse(localStorage.getItem('dash360:companies')||'[]'); }catch(e){ return []; } }
function dash360Save(list){ localStorage.setItem('dash360:companies', JSON.stringify(list||[])); }

// Always use DB.description (fallback ''), never let cache override content.
// Cache may only carry UI-only flags like isFavorite and investigation data.
function dash360EnsureSeeded(){
  const prev = dash360Load();                // for isFavorite and inv data
  const src  = Array.isArray(db?.companies) ? db.companies : [];
  const jobs = Array.isArray(db?.jobs) ? db.jobs : [];
  const contacts = Array.isArray(db?.contacts) ? db.contacts : [];
  const chats = Array.isArray(db?.chats) ? db.chats : [];
  const actions = Array.isArray(db?.actions) ? db.actions : [];
  const links = Array.isArray(db?.links) ? db.links : [];

  const merged = src.map(c=>{
    const p = prev.find(x => String(x.id) === String(c.id)) || {};
    const text = String(c.description ?? '');
    return {
      id: c.id,
      name: c.name || '—',
      notes: text,                // mirror of description
      description: text,          // single source of truth (DB)
      logoId: c.logoId || '',
      logoUrl: c.logoUrl || '',
      isFavorite: !!p.isFavorite, // UI-only
      inv: Array.isArray(p.inv) ? p.inv : [], // preserve investigation data
      jobs: jobs.filter(j=> j.companyId===c.id),
      contacts: contacts.filter(k=> k.companyId===c.id),
      chats: chats.filter(ch=> ch.companyId===c.id),
      actions: actions.filter(a=> (a.companyId===c.id || a.relatedCompanyId===c.id)),
      links: links.filter(l=> l.companyId===c.id),
    };
  });

  dash360Save(merged);
  return merged;
}

// Update cache (mirror both keys) and soft-sync DB description
function dash360UpdateCompany(id, delta){
  const list = dash360Load();
  const i = list.findIndex(x => String(x.id) === String(id));
  if (i >= 0){
    const d = { ...(delta||{}) };
    // always mirror both keys when either changes
    if ('notes' in d && !('description' in d)) d.description = d.notes;
    if ('description' in d && !('notes' in d)) d.notes = d.description;
    list[i] = { ...list[i], ...d };
    dash360Save(list);

    // soft-sync base DB
    const base = (db?.companies||[]).find(x => String(x.id) === String(id));
    if (base && (d.description ?? d.notes) != null){
      const v = String(d.description ?? d.notes ?? '');
      base.description = v;
      base.notes = v; // keep DB consistent for legacy paths
    }
    return list[i];
  }
  return null;
}

// Convenience used by the Notes textarea
function dash360SetCompanyNotes(company, value){
  dash360UpdateCompany(company.id, { description:String(value) });
}

// Helper: lowercases safely
function dash360Norm(s){ return (s||'').toString().toLowerCase(); }

// Investigation log helpers
function dash360FindCompanyCache(id){ const list=dash360Load(); return { list, idx:list.findIndex(x=>String(x.id)===String(id)) }; }
function dash360UpsertInv(id, updater){
  const {list, idx} = dash360FindCompanyCache(id);
  if (idx<0) return;
  const c = list[idx];
  c.inv = Array.isArray(c.inv) ? c.inv : [];
  updater(c.inv);
  dash360Save(list);
}

function dash360GetCacheCompany(id){
  const list = dash360Load(); const idx = list.findIndex(x=> String(x.id)===String(id));
  return { list, idx, item: idx>=0 ? list[idx] : null };
}

// Confirmation modal helper
function dash360ShowConfirmModal(title, message, warning, onConfirm, onCancel) {
  console.log('Creating confirmation modal...');
  const modal = document.createElement('div');
  modal.className = 'dash360-confirm-modal';
  
  modal.innerHTML = `
    <div class="d360-box">
      <div class="d360-head">${title}</div>
      <div class="d360-body">${message}</div>
      <div class="d360-sub">${warning}</div>
      <div class="d360-foot">
        <button class="btn" id="dash360-cancel-btn">Cancel</button>
        <button class="btn btn-danger" id="dash360-delete-btn">Delete</button>
      </div>
    </div>
  `;
  
  // Add to dash360-root
  const dash360Root = document.querySelector('#dash360-root');
  console.log('Dash360 root found:', !!dash360Root);
  if (dash360Root) {
    dash360Root.appendChild(modal);
    console.log('Modal added to DOM');
  } else {
    console.error('Dash360 root not found!');
  }
  
  // Event handlers
  const cancelBtn = modal.querySelector('#dash360-cancel-btn');
  const deleteBtn = modal.querySelector('#dash360-delete-btn');
  
  const closeModal = () => {
    modal.remove();
  };
  
  cancelBtn.addEventListener('click', () => {
    closeModal();
    if (onCancel) onCancel();
  });
  deleteBtn.addEventListener('click', () => {
    closeModal();
    if (onConfirm) onConfirm();
  });
  
  // Close on backdrop click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });
  
  return modal;
}

// Top controls + list renderer
function dash360RenderCompanyView(root){
  root.innerHTML = '';
  const companies = dash360EnsureSeeded();

  // top controls
  const top = dash360El('div', { class:'dash360-top-controls' });

  const search = dash360El('div', { class:'dash360-search' });
  search.appendChild(dash360El('span', { class:'ico' }, ['🔎']));
  const searchInput = dash360El('input', { type:'search', placeholder:"Search by company, description and jobs…" });
  search.appendChild(searchInput);

  const favWrap = dash360El('label', { class:'switch ideas-switch' }, [
    dash360El('input', { type:'checkbox', id:'dash360-fav-toggle', class:'ideas-checkbox' }),
    dash360El('span', {}, ['Show Favorite'])
  ]);

  top.appendChild(search);
  top.appendChild(favWrap);
  root.appendChild(top);

  const list = dash360El('div', { class:'dash360-companies-list' });
  root.appendChild(list);

  let state = { q:'', favOnly:false };

  const filterFn = arr=>{
    const q = dash360Norm(state.q);
    return arr.filter(c=>{
      if (state.favOnly && !c.isFavorite) return false;
      if (!q) return true;
      const base = (db?.companies||[]).find(x=>String(x.id)===String(c.id)) || c;
      const inCompany = dash360Norm(c.name).includes(q) || dash360Norm(base.description).includes(q);
      const inJobs = (c.jobs||[]).some(j => [j.title, j.status, j.salary, j.location, j.lastFollowUp]
        .some(v => dash360Norm(v).includes(q)));
      return inCompany || inJobs;
    });
  };

  const debounced = dash360Debounce(()=> dash360RenderCompaniesList(filterFn(dash360EnsureSeeded()), list), 300);
  searchInput.addEventListener('input', e => { state.q = e.target.value; debounced(); });
  favWrap.querySelector('input').addEventListener('change', e => { state.favOnly = e.target.checked; debounced(); });

  dash360RenderCompaniesList(filterFn(companies), list);
}

function dash360CreateCompanyCard(company){
  const el = dash360El;
  const card = el('div',{class:'dash360-company-card','data-id':company.id});

  // Header
  const head = el('div',{class:'dash360-card-header'});
  const logoBox = el('div',{class:'dash360-logo'},[ el('img',{alt:''}) ]);
  const logoImg = logoBox.querySelector('img');
  if (typeof dash360ApplyLogo === 'function') dash360ApplyLogo(logoImg, {
    name: company.name, logoId: (company.logoId||''), logoUrl: (company.logoUrl||'')
  });
  const name = el('div',{class:'dash360-company-name'},[company.name||'—']);
  const detailsBtn = el('button',{class:'dash360-details',title:'Show/Hide Details'});
  const star = el('button',{class:'dash360-star',title:'Toggle favorite'},[company.isFavorite?'⭐':'☆']);
  const syncBtn = ()=> detailsBtn.innerHTML = card.classList.contains('open') ? 'Hide ▲' : 'Details ▼';
  syncBtn();
  detailsBtn.onclick = (e)=>{ e.stopPropagation(); card.classList.toggle('open'); syncBtn(); };
  star.onclick = (e)=>{ e.stopPropagation();
    const u = dash360UpdateCompany(company.id,{isFavorite:!company.isFavorite});
    company.isFavorite = u?.isFavorite ?? !company.isFavorite;
    star.textContent = company.isFavorite ? '⭐' : '☆';
    const favToggle = document.getElementById('dash360-fav-toggle');
    if (favToggle?.checked) favToggle.dispatchEvent(new Event('change',{bubbles:true}));
  };
  head.appendChild(logoBox); head.appendChild(name); head.appendChild(detailsBtn); head.appendChild(star);
  card.appendChild(head);

  // Details panel
  const details = el('div',{class:'dash360-details-panel'});

  // 6.1 Company Notes (leave existing behavior intact)
  const base = (db?.companies||[]).find(x=> String(x.id)===String(company.id)) || company;
  const notesSec = el('div',{class:'dash360-section'});
  notesSec.appendChild(el('h4',{class:'dash360-h4','data-ico':'✏️'},['Company Notes']));
  
  const notesTa = el('textarea', { style: 'padding:12px 16px;' });
  notesTa.value = base.description || '';
  
  notesTa.addEventListener('input', dash360Debounce(()=>{
    dash360SetCompanyNotes(company, notesTa.value);
  }, 300));
  
  notesSec.appendChild(notesTa);
  details.appendChild(notesSec);

  // 6.2 Investigation log
  const invSec = el('div',{class:'dash360-section'});
  invSec.appendChild(el('h4',{class:'dash360-h4','data-ico':'🔎'},['Investigation log']));
  dash360RenderInvestigation(company, invSec); // stub below
  details.appendChild(invSec);

  // 6.3 Jobs
  const jobsSec = el('div',{class:'dash360-section'});
  jobsSec.appendChild(el('h4',{class:'dash360-h4','data-ico':'💼'},['Jobs']));
  dash360RenderJobs(company, jobsSec); // stub below
  details.appendChild(jobsSec);

  // 6.4 Contacts
  const contactsSec = el('div',{class:'dash360-section'});
  contactsSec.appendChild(el('h4',{class:'dash360-h4','data-ico':'👥'},['Contacts']));
  dash360RenderContacts(company, contactsSec); // stub below
  details.appendChild(contactsSec);

  // 6.5 Coffee chats
  const chatsSec = el('div',{class:'dash360-section'});
  chatsSec.appendChild(el('h4',{class:'dash360-h4','data-ico':'☕'},['Coffee chats']));
  dash360RenderChats(company, chatsSec); // stub below
  details.appendChild(chatsSec);

  // 6.6 Next actions
  const actionsSec = el('div',{class:'dash360-section'});
  actionsSec.appendChild(el('h4',{class:'dash360-h4','data-ico':'✅'},['Next actions']));
  dash360RenderActions(company, actionsSec); // stub below
  details.appendChild(actionsSec);

  // 6.7 Useful links
  const linksSec = el('div',{class:'dash360-section'});
  linksSec.appendChild(el('h4',{class:'dash360-h4','data-ico':'🔗'},['Useful links']));
  dash360RenderLinks(company, linksSec); // stub below
  details.appendChild(linksSec);

  card.appendChild(details);
  return card;
}

// Stub renderer functions
function dash360RenderInvestigation(company, mount){
  const el = dash360El;
  mount.innerHTML = '';

  // Ensure heading with icon is present (some builders already insert it)
  const hasH4 = mount.querySelector('.dash360-h4');
  if (!hasH4){
    mount.appendChild(el('h4',{class:'dash360-h4','data-ico':'🔎'},['Investigation log']));
  }

  const listWrap = el('div',{class:'dash360-inv-list'});

  // Ensure we have a cache bucket + create one row by default
  (function ensureDefault(){
    const { list, idx, item } = dash360GetCacheCompany(company.id);
    if (idx < 0) return; // nothing to do if company not in cache
    const inv = Array.isArray(item.inv) ? item.inv : (item.inv = []);
    if (inv.length === 0){
      inv.push({ id: uid('inv'), date: new Date().toISOString().slice(0,10), url:'', text:'', createdAt: Date.now() });
      dash360Save(list);
    }
  })();

  // Read current notes (newest first)
  const cache = dash360Load().find(x=> String(x.id)===String(company.id));
  const inv = (cache && Array.isArray(cache.inv)) ? [...cache.inv] : [];
  inv.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));

  const commit = (rowId, getValues)=> dash360Debounce(()=>{
    const { list, idx, item } = dash360GetCacheCompany(company.id);
    if (idx < 0) return;
    item.inv = Array.isArray(item.inv) ? item.inv : [];
    const i = item.inv.findIndex(x=> x.id===rowId);
    if (i>=0){ item.inv[i] = { ...item.inv[i], ...getValues() }; dash360Save(list); }
  },300)();

  function renderCard(row){
    const card = el('div',{class:'dash360-inv-card','data-id':row.id});

    // close "X" (no visible Delete button)
    const close = el('button', { class:'dash360-inv-close', type:'button' }, ['×']);
    close.addEventListener('click', () => {
      console.log('[INV ×] handler fired');
    
      const doDelete = () => {
        const { list, idx, item } = dash360GetCacheCompany(company.id);
        if (idx >= 0) {
          const i = (item.inv || []).findIndex(x => String(x.id) === String(row.id));
          if (i >= 0) { item.inv.splice(i, 1); dash360Save(list); }
        }
        card.remove();
      };
    
      // Remove any existing modals first
      document.querySelectorAll('#dash360-root .dash360-confirm-modal').forEach(n => n.remove());
    
      // Call the modal function directly (not window.dash360ShowConfirmModal)
      dash360ShowConfirmModal(
        'Delete Investigation Note',
        'Are you sure you want to delete this investigation note?',
        'This action cannot be undone.',
        doDelete,
        () => {}
      );
    });

    // fields row: date + url
    const fields = el('div',{class:'dash360-inv-fields'});
    const date = el('input',{type:'date', value: row.date || new Date().toISOString().slice(0,10)});
    const url  = el('input',{type:'url',  placeholder:'Optional URL (https://...)', value: row.url || ''});
    fields.appendChild(date); fields.appendChild(url);

    // big textarea
    const ta = el('textarea',{class:'dash360-inv-text', placeholder:'What did you read/watch/learn? Add notes here...'},[row.text||'']);
    ta.value = row.text || '';

    // wire autosave
    const saveDate = ()=> commit(row.id, ()=>({ date: date.value }));
    const saveUrl  = ()=> commit(row.id, ()=>({ url:  url.value  }));
    const saveText = ()=> commit(row.id, ()=>({ text: ta.value    }));
    date.addEventListener('input', saveDate);
    url .addEventListener('input', saveUrl);
    ta  .addEventListener('input', saveText);

    card.appendChild(close);
    card.appendChild(fields);
    card.appendChild(ta);
    return card;
  }

  inv.forEach(n=> listWrap.appendChild(renderCard(n)));

  const addBar = el('div',{class:'dash360-inv-add'},['＋ Add investigation note']);
  addBar.addEventListener('click', ()=>{
    const row = { id: uid('inv'), date: new Date().toISOString().slice(0,10), url:'', text:'', createdAt: Date.now() };
    const { list, idx, item } = dash360GetCacheCompany(company.id);
    if (idx >= 0){ item.inv = item.inv || []; item.inv.unshift(row); dash360Save(list); }
    listWrap.prepend(renderCard(row));
  });

  mount.appendChild(listWrap);
  mount.appendChild(addBar);
}

function dash360RenderJobs(company, mount){
  const el = dash360El;

  // Keep section title + icon
  let h = mount.querySelector('h4.dash360-h4');
  if (!h) mount.prepend(el('h4',{class:'dash360-h4','data-ico':'💼'},['Jobs']));

  // Ensure/locate body container
  let body = mount.querySelector('.dash360-section-body');
  if (!body) body = mount.appendChild(el('div',{class:'dash360-section-body'}));
  body.innerHTML = '';

  // CSS once (jobs card layout)
  (function ensureCSS(){
    if (document.getElementById('d360j-css')) return;
    const css = `
#dash360-root .d360j-card{background:#f8fbff;border:1px solid #e6edf6;border-radius:14px;box-shadow:0 1px 0 rgba(0,0,0,.02);padding:16px;display:grid !important;grid-template-columns:1fr 2fr !important;gap:16px !important;align-items:start !important;}
#dash360-root .d360j-left .t{font-weight:800;font-size:18px;margin-bottom:6px;color:#0f172a;}
#dash360-root .d360j-left .row{display:flex;align-items:center;gap:10px;margin:6px 0;color:#111827;}
#dash360-root .d360j-left .ico{width:22px;text-align:center;opacity:.9;}
#dash360-root .d360j-status{display:inline-block;padding:2px 10px;border-radius:9999px;background:#e6f4ff;color:#0369a1;font-weight:700;font-size:12px;}
#dash360-root .d360j-right{border-left:1px solid #e5e7eb;padding-left:16px;}
#dash360-root .d360j-right .lab{font-weight:700;margin-bottom:6px;color:#0f172a;}
#dash360-root .d360j-right textarea{width:100%;min-height:100px;resize:vertical;border:1px solid #e5e7eb;border-radius:10px;padding:12px 14px;background:#fff;box-sizing:border-box;}
#dash360-root .dash360-empty{color:#6b7280;padding:8px 4px;}`;
    const s=document.createElement('style'); s.id='d360j-css'; s.textContent=css; (document.head||document.body).appendChild(s);
  })();

  const jobs = (db?.jobs||[]).filter(j=> String(j.companyId)===String(company.id));
  if (!jobs.length){ body.appendChild(el('div',{class:'dash360-empty'},['No jobs for this company'])); return; }

  // helpers
  const sanitizeUrl = (u)=>{
    if (!u) return null;
    const s = String(u).trim();
    return s ? (/^https?:\/\//i.test(s) ? s : `https://${s}`) : null;
  };
  const metaRow = (ico, text)=> el('div',{class:'row'},[
    el('span',{class:'ico'},[ico]), el('span',{},[ text || '—' ])
  ]);
  const linkRow = (ico, label, href)=>{
    if (!href) return el('div',{class:'row'},[
      el('span',{class:'ico'},[ico]), el('span',{},['—'])
    ]);
    const a = el('a',{href, target:'_blank', rel:'noopener', class:'d360-link'},[label]);
    return el('div',{class:'row'},[ el('span',{class:'ico'},[ico]), a ]);
  };

  jobs.forEach(job=>{
    const card = el('div',{class:'d360j-card'});

    // LEFT column
    const left = el('div',{class:'d360j-left'});
    left.appendChild(el('div',{class:'t'},[ job.title || '—' ]));
    left.appendChild(el('div',{class:'row'},[
      el('span',{class:'ico'},['📊']),
      el('span',{class:'d360j-status'},[ job.status || '—' ])
    ]));
    left.appendChild(metaRow('📍', job.location));
    left.appendChild(metaRow('💰', job.salary));

    // NEW: clickable Source link (calendar row removed)
    const sourceHref = sanitizeUrl(job.sourceLink || job.source || job.sourceUrl || job.postingUrl || job.applyUrl || job.url || job.link);
    left.appendChild(linkRow('🔗','Source', sourceHref));

    // RIGHT column
    const right = el('div',{class:'d360j-right'});
    right.appendChild(el('div',{class:'lab'},['Notes']));
    const ta = el('textarea',{placeholder:'Add notes about this job…'});
    ta.value = job.notes || '';
    const persist = () => {
      const list = db?.jobs||[]; const idx = list.findIndex(x=> String(x.id)===String(job.id));
      if (idx!==-1){ list[idx].notes = ta.value; if (typeof save==='function') save(); }
    };
    ta.addEventListener('input', (typeof dash360Debounce==='function'
      ? dash360Debounce(persist,300)
      : (()=>{let t;return()=>{clearTimeout(t);t=setTimeout(persist,300);};})()
    ));
    right.appendChild(ta);

    card.appendChild(left); card.appendChild(right); body.appendChild(card);
  });
}
function dash360RenderContacts(company, mount){
  const el = dash360El;

  // Keep section title + icon
  let h = mount.querySelector('h4.dash360-h4');
  if (!h) mount.prepend(el('h4',{class:'dash360-h4','data-ico':'👥'},['Contacts']));

  // Ensure/locate body container
  let body = mount.querySelector('.dash360-section-body');
  if (!body) body = mount.appendChild(el('div',{class:'dash360-section-body'}));
  body.innerHTML='';

  // CSS once (contacts card layout)
  (function ensureCSS(){
    if (document.getElementById('d360c-css')) return;
    const s=document.createElement('style'); s.id='d360c-css';
    s.textContent = `
#dash360-root .d360c-card{background:#f8fbff;border:1px solid #e6edf6;border-radius:14px;box-shadow:0 1px 0 rgba(0,0,0,.02);padding:16px;display:grid !important;grid-template-columns:1fr 2fr !important;gap:16px !important;align-items:start !important;}
#dash360-root .d360c-left .t{font-weight:800;font-size:20px;margin-bottom:6px;color:#0f172a;}
#dash360-root .d360c-left .row{display:flex;align-items:center;gap:10px;margin:6px 0;color:#111827;}
#dash360-root .d360c-left .ico{width:22px;text-align:center;opacity:.9;}
#dash360-root .d360c-right{border-left:1px solid #e5e7eb;padding-left:16px;}
#dash360-root .d360c-right .lab{font-weight:700;margin-bottom:6px;color:#0f172a;}
#dash360-root .d360c-right textarea{width:100%;min-height:100px;resize:vertical;border:1px solid #e5e7eb;border-radius:10px;padding:12px 14px;background:#fff;box-sizing:border-box;}
#dash360-root .dash360-empty{color:#6b7280;padding:8px 4px;}`;
    (document.head||document.body).appendChild(s);
  })();

  const contacts = (db?.contacts||[]).filter(c=> String(c.companyId)===String(company.id));
  if (!contacts.length){ body.appendChild(el('div',{class:'dash360-empty'},['No contacts for this company'])); return; }

  // helpers
  const sanitizeUrl = (u)=>{
    if (!u) return null;
    const s = String(u).trim();
    return s ? (/^https?:\/\//i.test(s) ? s : `https://${s}`) : null;
  };
  const row = (ico, txt)=> el('div',{class:'row'},[
    el('span',{class:'ico'},[ico]), el('span',{},[txt||'—'])
  ]);
  const linkRow = (ico, label, href)=>{
    if (!href) return el('div',{class:'row'},[
      el('span',{class:'ico'},[ico]), el('span',{},['—'])
    ]);
    const a = el('a',{href, target:'_blank', rel:'noopener', class:'d360-link'},[label]);
    return el('div',{class:'row'},[ el('span',{class:'ico'},[ico]), a ]);
  };

  contacts.forEach(c=>{
    const card = el('div',{class:'d360c-card'});

    // LEFT column
    const left = el('div',{class:'d360c-left'});
    left.appendChild(el('div',{class:'t'},[ c.name || '—' ]));
    left.appendChild(row('🏢', company?.name || company?.title || '—'));
    left.appendChild(row('🤝', c.role || c.relationship));
    left.appendChild(row('📧', c.email));

    // NEW: clickable LinkedIn link (phone + calendar removed)
    const liHref = sanitizeUrl(c.linkedIn || c.linkedin || c.linkedinUrl || c.linkedinURL || c.profile || c.profileUrl || c.url);
    left.appendChild(linkRow('🔗','LinkedIn', liHref));

    // RIGHT column
    const right = el('div',{class:'d360c-right'});
    right.appendChild(el('div',{class:'lab'},['Notes']));
    const ta = el('textarea',{placeholder:'Add notes about this contact…'});
    ta.value = c.notes || '';
    const persist = () => {
      const list = db?.contacts||[]; const idx = list.findIndex(x=> String(x.id)===String(c.id));
      if (idx!==-1){ list[idx].notes = ta.value; if (typeof save==='function') save(); }
    };
    ta.addEventListener('input', (typeof dash360Debounce==='function'
      ? dash360Debounce(persist,300)
      : (()=>{let t;return()=>{clearTimeout(t);t=setTimeout(persist,300);};})()
    ));
    right.appendChild(ta);

    card.appendChild(left); card.appendChild(right); body.appendChild(card);
  });
}
function dash360RenderChats(company, mount){
  const el = dash360El;

  // Keep section title + icon
  let h = mount.querySelector('h4.dash360-h4');
  if (!h) mount.prepend(el('h4',{class:'dash360-h4','data-ico':'☕'},['Coffee chats']));

  // Ensure/locate body container
  let body = mount.querySelector('.dash360-section-body');
  if (!body) body = mount.appendChild(el('div',{class:'dash360-section-body'}));
  body.innerHTML='';

  // CSS once (chats card layout + pill)
  (function ensureCSS(){
    if (document.getElementById('d360ch-css')) return;
    const s=document.createElement('style'); s.id='d360ch-css';
    s.textContent = `
#dash360-root .d360ch-card{background:#f8fbff;border:1px solid #e6edf6;border-radius:14px;box-shadow:0 1px 0 rgba(0,0,0,.02);padding:16px;display:grid !important;grid-template-columns:1fr 2fr !important;gap:16px !important;align-items:start !important;}
#dash360-root .d360ch-left .t{font-weight:800;font-size:20px;margin-bottom:6px;color:#0f172a;}
#dash360-root .d360ch-left .row{display:flex;align-items:center;gap:10px;margin:6px 0;color:#111827;}
#dash360-root .d360ch-left .ico{width:22px;text-align:center;opacity:.9;}
#dash360-root .d360ch-status{display:inline-block;padding:2px 10px;border-radius:9999px;background:#e6f4ff;color:#0369a1;font-weight:700;font-size:12px;}
#dash360-root .d360ch-right{border-left:1px solid #e5e7eb;padding-left:16px;}
#dash360-root .d360ch-right .lab{font-weight:700;margin-bottom:6px;color:#0f172a;}
#dash360-root .d360ch-right textarea{width:100%;min-height:100px;resize:vertical;border:1px solid #e5e7eb;border-radius:10px;padding:12px 14px;background:#fff;box-sizing:border-box;}
#dash360-root .dash360-empty{color:#6b7280;padding:8px 4px;}`;
    (document.head||document.body).appendChild(s);
  })();

  // helpers
  const pick = (obj, keys, fallback='')=>{
    for (const k of keys){ const v = obj?.[k]; if (v!=null && String(v).trim()!=='') return v; }
    return fallback;
  };
  const row = (ico, nodeOrText)=> el('div',{class:'row'},[
    el('span',{class:'ico'},[ico]),
    (typeof nodeOrText==='string' ? el('span',{},[nodeOrText||'—']) : nodeOrText)
  ]);

  // data
  const chats = (db?.chats||[]).filter(ch => String(ch.companyId)===String(company.id));
  if (!chats.length){
    body.appendChild(el('div',{class:'dash360-empty'},['No coffee chats for this company']));
    return;
  }

  // fixed channel list for display
  const CHANNELS = ['Email','Phone','Video','In-person','LinkedIn','Other'];

  chats.forEach(ch=>{
    const card = el('div',{class:'d360ch-card'});

    // LEFT column
    const left = el('div',{class:'d360ch-left'});

    // 1) Contact (bold) - resolve from contactId
    const contact = (db?.contacts||[]).find(c => String(c.id) === String(ch.contactId));
    const contactName = contact ? contact.name : pick(ch, ['with','contact','contactName','name'], '—');
    left.appendChild(el('div',{class:'t'},[ contactName ]));

    // 2) Job (use ch.jobTitle or resolve by jobId)
    let jobText = pick(ch, ['jobTitle','job','role']);
    if (!jobText){
      const jid = pick(ch, ['jobId','jobID','job_id']);
      if (jid){
        const j = (db?.jobs||[]).find(x => String(x.id)===String(jid));
        if (j) jobText = j.title || '';
      }
    }
    left.appendChild(row('💼', jobText || '—'));

    // 3) Status (pill)
    const statusSpan = el('span',{class:'d360ch-status'},[ pick(ch,['status','stage'],'—') ]);
    left.appendChild(row('📈', statusSpan));

    // 4) Scheduled date (labelled)
    const sched = pick(ch,['date','scheduledAt','when']);
    left.appendChild(row('📅', sched ? `Scheduled: ${sched}` : 'Scheduled: —'));

         // 5) Channel (text only, not dropdown)
     const currentChannel = pick(ch,['channel','medium','platform']);
     left.appendChild(row('📡', currentChannel || '—'));

    // RIGHT column (Notes)
    const right = el('div',{class:'d360ch-right'});
    right.appendChild(el('div',{class:'lab'},['Notes']));
    const ta = el('textarea',{placeholder:'Add notes about this coffee chat…'});
    ta.value = pick(ch,['notes','note','description'],'');
    const persist = () => {
      const list = db?.chats || [];
      const idx = list.findIndex(x => String(x.id)===String(ch.id));
      if (idx!==-1){ list[idx].notes = ta.value; if (typeof save==='function') save(); }
    };
    ta.addEventListener('input',
      typeof dash360Debounce==='function' ? dash360Debounce(persist,300)
                                          : (()=>{let t;return()=>{clearTimeout(t);t=setTimeout(persist,300);};})()
    );
    right.appendChild(ta);

    card.appendChild(left);
    card.appendChild(right);
    body.appendChild(card);
  });
}
//---0) Comany---
// ---- Company 360: watch for "New action" modal and patch it when opened ----
(function d360InstallNAWatcher(){
  if (window.__d360NAWatcher) return;
  window.__d360NAWatcher = true;

  function findCandidateModal(){
    // Prefer dialogs/modals that are visible
    const vis = el => !!el && getComputedStyle(el).display !== 'none';
    const mods = [
      ...document.querySelectorAll('dialog, [role="dialog"], .modal, .na-modal')
    ].filter(vis);
    if (mods.length) return mods.at(-1);

    // Fallback: container that has two selects and a textarea (shape of the form)
    const pick = [...document.querySelectorAll('select')];
    if (pick.length >= 2){
      return (pick.at(-1).closest('dialog, [role="dialog"], .modal') || pick.at(-1).closest('body'));
    }
    return null;
  }

  function tryPatch(){
    const flag = window.__d360PatchNA;             // set by the CTA (below)
    if (!flag) return;

    const modal = findCandidateModal();
    if (!modal) return;                            // wait for next mutation

    // Wire the selects inside this modal
    d360WireNAmodal(modal, flag.company);
    // clear the flag so we don't re-patch other modals
    window.__d360PatchNA = null;
  }

  const mo = new MutationObserver(tryPatch);
  mo.observe(document.body, { childList:true, subtree:true });

  // also try when focus shifts (some UIs paint after focus)
  window.addEventListener('focus', tryPatch, true);
})();

function d360WireNAmodal(modal, company){
  const companyId   = String(company.id);
  const companyName = company.name || company.title || companyId;

  // Build company-scoped lists
  const jobs = (db?.jobs||[]).filter(j => String(j.companyId) === companyId);

  const contactIds = new Set((db?.contacts||[])
    .filter(c => String(c.companyId) === companyId)
    .map(c => String(c.id)));

  const chats = (db?.chats||[])
    .filter(ch => contactIds.has(String(ch.contactId)));

  // Locate the two selects robustly
  const allSelects = [...modal.querySelectorAll('select')];

  // Prefer matching by nearby label text
  const byLabel = txt => {
    const labs = [...modal.querySelectorAll('label')];
    const lab  = labs.find(l => l.textContent.trim().toLowerCase() === txt);
    if (!lab) return null;
    let n = lab.nextElementSibling;
    while (n && n.tagName !== 'SELECT') n = n.nextElementSibling;
    return n || null;
  };

  let selRelated = byLabel('related') || allSelects[0] || null;
  let selPick    = byLabel('pick related item') || allSelects[1] || null;

  // Fallback: if we only found the first select, use the next <select> in DOM order
  if (selRelated && !selPick){
    const i = allSelects.indexOf(selRelated);
    if (i >= 0 && allSelects[i+1]) selPick = allSelects[i+1];
  }

  if (!selRelated || !selPick){
    // Nothing to wire; bail quietly
    return;
  }

  // Force the three Related options and keep selection stable if user changes it
  const setRelatedOptions = () => {
    const cur = selRelated.value || selRelated.options[selRelated.selectedIndex]?.textContent?.trim();
    selRelated.innerHTML = '';
    ['company','job','coffee chat'].forEach(v=>{
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v === 'coffee chat' ? 'Coffee chat' : v[0].toUpperCase()+v.slice(1);
      selRelated.appendChild(o);
    });
    if (cur && ['Company','Job','Coffee chat'].includes(cur)) selRelated.value = cur;
  };

  const fillPick = (kind) => {
    selPick.innerHTML = '';
    if (kind === 'Company'){
      selPick.disabled = true;
      const o = document.createElement('option');
      o.value = companyId;
      o.textContent = companyName;
      selPick.appendChild(o);
    } else if (kind === 'Job'){
      selPick.disabled = false;
      jobs.forEach(j=>{
        const o = document.createElement('option');
        o.value = String(j.id);
        o.textContent = j.title || String(j.id);
        selPick.appendChild(o);
      });
    } else if (kind === 'Coffee chat'){
      selPick.disabled = false;
      chats.forEach(ch=>{
        const contact = (db?.contacts||[]).find(c => String(c.id)===String(ch.contactId));
        const label = contact?.name || ch.with || ch.name || String(ch.id);
        const o = document.createElement('option');
        o.value = String(ch.id);
        o.textContent = label;
        selPick.appendChild(o);
      });
    }
  };

  setRelatedOptions();
  // Default to Company the first time
  if (!selRelated.value) selRelated.value = 'Company';
  fillPick(selRelated.value);

  selRelated.addEventListener('change', () => fillPick(selRelated.value));
}



// --- 1) Company-scoped filter: reuse your global db (no new state) ---
function d360_actionsForCompany(companyId){
  const jobsByCompany = new Set(
    (db?.jobs||[]).filter(j => String(j.companyId) === String(companyId)).map(j => String(j.id))
  );

  // Chats are tied to a contact; we derive company via contact.companyId
  const contactsByCompany = new Set(
    (db?.contacts||[]).filter(c => String(c.companyId) === String(companyId)).map(c => String(c.id))
  );
  const chatsByCompany = new Set(
    (db?.chats||[]).filter(ch => contactsByCompany.has(String(ch.contactId))).map(ch => String(ch.id))
  );

  return (db?.actions||[]).filter(a => {
    const rt  = (a.relatedType||'').toLowerCase();
    const rid = String(a.relatedId||'');
    if (rt === 'company')     return rid === String(companyId);
    if (rt === 'job')         return jobsByCompany.has(rid);
    if (rt === 'coffee chat') return chatsByCompany.has(rid);
    // Also include actions that have this company as relatedId (for backward compatibility)
    if (rid === String(companyId)) return true;
    return false;
  });
}

// --- Helper: given an action (or id), resolve the owning company id ---
function d360GetCompanyIdForActionId(actionId){
  try{
    const act = (db?.actions||[]).find(x => String(x.id) === String(actionId));
    if (!act) return null;
    const rt  = (act.relatedType||'').toLowerCase();
    const rid = String(act.relatedId||'');
    if (rt === 'company') return rid || null;
    if (rt === 'job'){
      const job = (db?.jobs||[]).find(j => String(j.id) === rid);
      return job ? String(job.companyId) : null;
    }
    if (rt === 'coffee chat'){
      const chat = (db?.chats||[]).find(ch => String(ch.id) === rid);
      if (!chat) return null;
      const contact = (db?.contacts||[]).find(c => String(c.id) === String(chat.contactId));
      return contact ? String(contact.companyId) : null;
  }
  return null;
  }catch(_){ return null; }
}

// --- Helper: refresh Next Actions section for a specific company id ---
window.d360RefreshActionsForCompanyId = function(companyId){
  try{
    const card = document.querySelector(`.dash360-company-card[data-id="${companyId}"]`);
    if (!card) { console.log('⚠️ d360RefreshActionsForCompanyId: card not found for', companyId); return false; }
    const header = card.querySelector('.dash360-section h4.dash360-h4[data-ico="✅"]');
    const mount = header ? header.parentElement : null;
    if (!mount) { console.log('⚠️ d360RefreshActionsForCompanyId: mount not found for', companyId); return false; }
    const company = { id: String(companyId) };
    dash360RenderActions(company, mount);
    return true;
  }catch(err){ console.error('d360RefreshActionsForCompanyId error', err); return false; }
}

// --- 1) SVG Icon Helper ---
function d360Icon(name){
  const wrap = document.createElement('span');
  wrap.className = 'ico';
  const base = 'viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"';
  const svgs = {
    // pencil
    edit: `<svg ${base}>
             <path d="M12 20h9"/>
             <path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4z"/>
           </svg>`,
    // maximize-2 (arrows to corners)
    expand: `<svg ${base}>
               <polyline points="15 3 21 3 21 9"/>
               <line x1="21" y1="3" x2="14" y2="10"/>
               <polyline points="9 21 3 21 3 15"/>
               <line x1="3" y1="21" x2="10" y2="14"/>
             </svg>`,
    // X
    close: `<svg ${base}>
              <line x1="18" y1="6"  x2="6"  y2="18"/>
              <line x1="6"  y1="6"  x2="18" y2="18"/>
            </svg>`
  };
  wrap.innerHTML = svgs[name] || '';
  return wrap;
}

function d360EnsureNextActionSpacingCSS(){
  if (document.getElementById('d360-actions-spacing-css')) return;
  const s = document.createElement('style');
  s.id = 'd360-actions-spacing-css';
  s.textContent = `
    /* Dashboard360 → Company → Next actions (scoped, Entrepreneurship untouched) */
    #dash360-root .dash360-section-body .na-info{
      margin-bottom: 18px;                 /* gap between the alert chip and first card */
    }
    #dash360-root .dash360-section-body .na-v16{
      display: flex;                        /* stack cards vertically */
      flex-direction: column;
      gap: 18px;                            /* space between cards (and the CTA at bottom) */
    }
    /* make sure individual cards don't add their own extra margins */
    #dash360-root .dash360-section-body .na-v16 .action-card{
      margin: 0;
    }
  `;
  (document.head || document.body).appendChild(s);
}



// --- 2) Company 360 renderer – uses the SAME classes as Entrepreneurship (.na-v16) ---
function dash360RenderActions(company, mount){
  console.log('🎯 dash360RenderActions called with:', { companyId: company?.id, mount: mount });
  
  // remember current context so the save() wrapper can refresh this section
  d360EnsureAddActionCSS(); 
  d360EnsureNextActionSpacingCSS();
  window.d360CurrentCompanyForActions = company;
  window.d360CurrentActionsMount = mount;
  
  // SIMPLE SOLUTION: Create a global refresh function that works
  window.dash360RefreshNow = () => {
    console.log('🔄 Dashboard 360: REFRESHING NOW...');
    
    if (window.d360CurrentCompanyForActions && window.d360CurrentActionsMount) {
      console.log('🔄 Refreshing actions for company:', window.d360CurrentCompanyForActions.id);
      
      // Get fresh data
      const company = window.d360CurrentCompanyForActions;
      const mount = window.d360CurrentActionsMount;
      const actions = d360_actionsForCompany(company.id);
      
      console.log('📋 Fresh actions data:', actions.length, 'actions');
      console.log('📋 Actions details:', actions.map(a => ({ id: a.id, title: a.title, description: a.description })));
      
      // Check if the edited action is in the list
      const editedAction = actions.find(a => a.id === 'act-an09e9em');
      if (editedAction) {
        console.log('🎯 Found edited action in list:', editedAction.title);
      } else {
        console.log('❌ Edited action NOT found in list!');
        
        // Debug: Check what the action looks like in db.actions
        const allActions = db?.actions || [];
        const actionInDB = allActions.find(a => a.id === 'act-an09e9em');
        if (actionInDB) {
          console.log('🔍 Action found in db.actions:', {
            id: actionInDB.id,
            title: actionInDB.title,
            relatedType: actionInDB.relatedType,
            relatedId: actionInDB.relatedId,
            companyId: actionInDB.companyId
          });
          console.log('🔍 Current company ID:', company.id);
          console.log('🔍 Action belongs to different company:', actionInDB.relatedId !== company.id);
        } else {
          console.log('🔍 Action NOT found in db.actions at all!');
        }
      }
      
      // Clear and re-render
      console.log('🧹 REFRESH PATH: Clearing mount, current children:', mount.children.length);
      mount.innerHTML = '';
      console.log('🧹 REFRESH PATH: Mount cleared, new children count:', mount.children.length);
      
      // Re-create the header
      const el = dash360El;
      let h = mount.querySelector('h4.dash360-h4');
      if (!h) {
        const headerContainer = el('div', {style: 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;'});
        const title = el('h4',{class:'dash360-h4','data-ico':'✅'},['Next steps']);
        
        const refreshBtn = el('button', {
          class: 'iconbtn',
          title: 'Refresh actions',
          style: 'width: 32px; height: 32px; padding: 0; border-radius: 8px; background: #f3f4f6; border: 1px solid #e5e7eb; cursor: pointer;'
        }, ['🔄']);
        refreshBtn.onclick = () => {
          console.log('🔄 Dashboard 360: Manual refresh clicked');
          if (typeof window.dash360RefreshNow === 'function') {
            window.dash360RefreshNow();
          }
        };
        
        headerContainer.appendChild(title);
        headerContainer.appendChild(refreshBtn);
        mount.prepend(headerContainer);
      }
      
      // Re-create the body
      let body = mount.querySelector('.dash360-section-body');
      if (!body) body = mount.appendChild(el('div',{class:'dash360-section-body'}));
      body.innerHTML = '';
      
      // Info chip
      const info = el('div',{class:'na-info'},[
        el('span',{class:'bulb'},['💡']),
        el('span',{},['These actions are also visible in the ', el('b',{},['Next Actions']), ' module'])
      ]);
      body.appendChild(info);
      
      // Wrapper
      const wrap = el('div',{class:'na-v16'});
      body.appendChild(wrap);
      
      if (!actions.length){
        wrap.appendChild(el('div',{class:'dash360-empty'},['No actions for this company']));
        wrap.appendChild(d360_makeAddActionCTA(company));
      } else {
        console.log('🎨 Creating cards for', actions.length, 'actions...');
        actions.forEach((a, index) => {
          console.log('🎨 Creating card', index + 1, 'for action:', a.title);
          const card = d360_makeCompanyActionCard(a, company);
          wrap.appendChild(card);
          console.log('🎨 Card', index + 1, 'created and appended');
        });
        wrap.appendChild(d360_makeAddActionCTA(company));
      }
      
      console.log('✅ REFRESH PATH: All cards created, final mount children:', mount.children.length);
      console.log('✅ REFRESH PATH: Final body children:', body.children.length);
      console.log('✅ REFRESH PATH: Final wrap children:', wrap.children.length);
      console.log('✅ Refresh completed successfully');
    } else {
      console.log('⚠️ Dashboard 360: No context found for refresh');
    }
  };
  
  const el = dash360El;

  // Keep your header style
  let h = mount.querySelector('h4.dash360-h4');
  if (!h) {
    const headerContainer = el('div', {style: 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;'});
    const title = el('h4',{class:'dash360-h4','data-ico':'✅'},['Next steps']);
    
    // Simple refresh button
    const refreshBtn = el('button', {
      class: 'iconbtn',
      title: 'Refresh actions',
      style: 'width: 32px; height: 32px; padding: 0; border-radius: 8px; background: #f3f4f6; border: 1px solid #e5e7eb; cursor: pointer;'
    }, ['🔄']);
    refreshBtn.onclick = () => {
      console.log('🔄 Dashboard 360: Manual refresh clicked');
      if (typeof window.dash360RefreshNow === 'function') {
        window.dash360RefreshNow();
      }
    };
    
    headerContainer.appendChild(title);
    headerContainer.appendChild(refreshBtn);
    mount.prepend(headerContainer);
  }

  // Create/clear section body
  console.log('🧹 INITIAL RENDER PATH: Creating/clearing body');
  let body = mount.querySelector('.dash360-section-body');
  if (!body) body = mount.appendChild(el('div',{class:'dash360-section-body'}));
  body.innerHTML = '';

  // Info chip (matches Entrepreneurship)
  const info = el('div',{class:'na-info'},[
    el('span',{class:'bulb'},['💡']),
    el('span',{},['These actions are also visible in the ', el('b',{},['Next Actions']), ' module'])
  ]);
  body.appendChild(info);

  // Wrapper that triggers your existing .na-v16 card CSS
  const wrap = el('div',{class:'na-v16'});
  body.appendChild(wrap);

  const rows = d360_actionsForCompany(company.id);
  console.log('📋 Found actions for company:', rows.length, 'actions:', rows);

  if (!rows.length){
    wrap.appendChild(el('div',{class:'dash360-empty'},['No actions for this company']));
    wrap.appendChild(d360_makeAddActionCTA(company));
    return;
  }

  rows.forEach(a => wrap.appendChild(d360_makeCompanyActionCard(a, company)));
  wrap.appendChild(d360_makeAddActionCTA(company));
  
}

// Dash360: auto-refresh Next steps when actions change
(function d360AutoRefreshActions(){
  if (window.__d360SavePatched) return;
  window.__d360SavePatched = true;

  const origSave = window.save || function(){};
  window.save = function(...args){
    // snapshot before
    let before = '';
    try { before = JSON.stringify((db && db.actions) || []); } catch(e){}

    const out = origSave.apply(this, args);

    // snapshot after
    try {
      const after = JSON.stringify((db && db.actions) || []);
      if (before !== after && window.d360CurrentCompanyForActions && window.d360CurrentActionsMount){
        // re-render the currently open company’s actions
        dash360RenderActions(window.d360CurrentCompanyForActions, window.d360CurrentActionsMount);
      }
    } catch(e){}

    return out;
  };
})();

// Additional fallback: Force refresh after any action modification
(function d360ForceRefreshAfterActions(){
  if (window.__d360ForceRefreshPatched) return;
  window.__d360ForceRefreshPatched = true;
  
  // Override the save function to always trigger refresh
  const origSave = window.save || function(){};
  window.save = function(...args){
    const result = origSave.apply(this, args);
    
    // Small delay to ensure save is complete, then refresh
    setTimeout(() => {
      if (window.d360CurrentCompanyForActions && window.d360CurrentActionsMount) {
        console.log('🔄 Dashboard 360: Force refresh after save...');
        if (typeof window.dash360RefreshNow === 'function') {
          console.log('✅ Dashboard 360: Force refresh completed');
          window.dash360RefreshNow();
        } else {
          console.log('⚠️ Dashboard 360: Force refresh failed, using fallback...');
          dash360RenderActions(window.d360CurrentCompanyForActions, window.d360CurrentActionsMount);
        }
      }
    }, 100);
    
    return result;
  };
})();

// --- 3) Action card – DOM/classnames match Entrepreneurship cards ---
function d360_makeCompanyActionCard(action, company){
  console.log('🎨 d360_makeCompanyActionCard called for action:', action.title);
  const el = dash360El;
  const card = el('div',{class:'action-card','data-action-id': String(action.id||'')});

  const meta = computeActionStatus ? computeActionStatus(action) : {status:'To do',done:0,total:0};

  // Head
  const head = el('div',{class:'action-head'});

  // Top row
  const top = el('div',{class:'action-top-row'});

  // Editable title (same behavior)
  const title = el('div',{class:'action-title','aria-label':'Action title',contenteditable:'true'});
  title.textContent = action.title || '';
  console.log('🎨 Title element created with text:', title.textContent);
  title.addEventListener('keydown', e => { if (e.key === 'Enter') e.preventDefault(); });
  let tdeb;
  title.oninput = () => {
    clearTimeout(tdeb);
    title.classList.add('editing');
    const v = title.textContent;
    tdeb = setTimeout(() => { action.title = v; save(); title.classList.remove('editing'); }, 150);
  };
  top.appendChild(title);

  // Right cluster: status, progress, overdue, icons
  const right = el('div',{class:'head-right'});
  const stCls = meta.status === 'Done' ? 'done' : (meta.status === 'In progress' ? 'progress' : 'todo');
  right.appendChild(el('span',{class:`badge ${stCls}`},[meta.status]));
  right.appendChild(el('span',{class:'progress-text'},[`${meta.done} of ${meta.total} completed`]));
  if (typeof hasActionOverdue === 'function' && hasActionOverdue(action)){
    right.appendChild(el('span',{class:'badge overdue'},['Overdue']));
  }

  const icons = el('div',{class:'head-icons'});

  // Edit (reuse your modal)
  const editBtn = el('button',{class:'iconbtn',title:'Edit'});
  editBtn.appendChild(d360Icon('edit'));
  editBtn.onclick = () => {
    // Store current action for refresh callback
    window.d360CurrentActionForEdit = action;
    openActionEditModal(action);
  };
  icons.appendChild(editBtn);

  // Expand
  const expandBtn = el('button',{class:'iconbtn',title:'Open'});
  expandBtn.appendChild(d360Icon('expand'));
  expandBtn.onclick = () => (typeof openActionExpandModal==='function' ? openActionExpandModal(action) : null);
  icons.appendChild(expandBtn);

  // Delete (reuse your branded confirm if present)
  const delBtn = el('button',{class:'iconbtn',title:'Delete'});
  delBtn.appendChild(d360Icon('close'));
  delBtn.onclick = () => {
    const doDelete = () => {
      const list = db.actions || [];
      const idx = list.findIndex(x => String(x.id) === String(action.id));
      if (idx>-1){ list.splice(idx,1); save(); }
      // Inline: remove this card from DOM (no full refresh)
      try{ card.remove(); }catch(_){ }
    };
    const title = 'Delete action';
    const msg = `Delete "${action.title||'this action'}"?`;
    if (typeof window.dash360ShowConfirmModal === 'function'){
      window.dash360ShowConfirmModal(title, msg, '', doDelete, ()=>{});
    } else if (typeof confirmDeleteAction === 'function'){
      confirmDeleteAction(title, msg, '', doDelete);
    } else {
      if (confirm(msg)) doDelete();
    }
  };
  icons.appendChild(delBtn);

  right.appendChild(icons);
  top.appendChild(right);
  head.appendChild(top);

  // Relation line (reuse your helper)
  const relTxt = typeof getRelationText==='function' ? getRelationText(action) : '';
  head.appendChild(el('div',{class:'relation-line'},[ relTxt ]));

  // Description row
  head.appendChild(el('div',{class:'desc-one'},[
    el('span',{class:'label'},['Description:']),
    el('span',{class:'text'},[(action.description||'').trim() || '—'])
  ]));

  card.appendChild(head);

  // Body: subtasks
  const body = el('div',{class:'action-body'});
  (action.subactions||[]).forEach(s => body.appendChild(d360_makeSubRow(action, s, company)));
  card.appendChild(body);

  // Foot: Add subtask
  const foot = el('div',{class:'action-foot'});
  const add = el('button',{class:'btn','aria-label':'Add new subtask'},['Add new subtask']);
  add.onclick = () => {
    if (typeof openAddSubtaskModal==='function') {
      // Store current action for refresh callback
      window.d360CurrentActionForSubtasks = action;
      openAddSubtaskModal(action);
    }
  };
  foot.appendChild(add);
  card.appendChild(foot);

  console.log('🎨 Final card created for action:', action.title, 'with title element text:', card.querySelector('.action-title')?.textContent);
  return card;
}

// --- Inline DOM updater for a single action card ---
function d360UpdateActionCardInDOM(updatedAction){
  try{
    const card = document.querySelector(`.action-card[data-action-id="${updatedAction.id}"]`);
    if (!card) return false;
    const titleEl = card.querySelector('.action-title');
    if (titleEl && typeof updatedAction.title === 'string') titleEl.textContent = updatedAction.title;
    // Optionally update description/status counters if present in DOM
    return true;
  }catch(_){ return false; }
}

// --- 4) Subtask row (same classnames) ---
function d360_makeSubRow(action, s, company){
  const el = dash360El;
  const row = el('div',{class:'sub-row'});

  const cb = el('input',{type:'checkbox','aria-label':`Mark "${s.title}" completed`});
  cb.checked = !!s.done;
  cb.addEventListener('click', e => e.stopPropagation());
  cb.onchange = () => { s.done = cb.checked; save(); };
  const cbWrap = el('label',{class:'sub-check',title:'Mark complete'}); cbWrap.appendChild(cb);
  row.appendChild(cbWrap);

  row.appendChild(el('span',{class:'sub-title'+(s.done?' sub-completed':'')},[s.title||'']));

  const pretty = (typeof fmtDate==='function' && s.due) ? fmtDate(s.due) : (s.due||'—');
  row.appendChild(el('span',{class:'due-pill'},[pretty]));

  const icons = el('div',{class:'sub-icons'});
  const rm = el('button',{class:'iconbtn tiny',title:'Remove subtask'});
  rm.appendChild(d360Icon('close'));
  rm.onclick = () => {
    const doDelete = () => {
      const list = action.subactions || [];
      const i = list.indexOf(s);
      if (i>-1){ list.splice(i,1); save(); }
      try{ row.remove(); }catch(_){ }
      // Update header meta inline
      try{
        if (typeof computeActionStatus==='function'){
          const meta = computeActionStatus(action);
          const card = row.closest('.action-card');
          const progress = card?.querySelector('.progress-text');
          if (progress) progress.textContent = `${meta.done} of ${meta.total} completed`;
          const badge = card?.querySelector('.head-right .badge');
          if (badge){
            badge.textContent = meta.status;
            badge.classList.remove('done','progress','todo');
            badge.classList.add(meta.status==='Done'?'done':(meta.status==='In progress'?'progress':'todo'));
          }
        }
      }catch(_){ }
    };
    const title = 'Delete subtask';
    const msg = `Delete "${s.title||'this subtask'}"?`;
    if (typeof window.dash360ShowConfirmModal === 'function'){
      window.dash360ShowConfirmModal(title, msg, '', doDelete, ()=>{});
    } else if (typeof confirmDeleteAction === 'function'){
      confirmDeleteAction(title, msg, '', doDelete);
    } else {
      if (confirm(msg)) doDelete();
    }
  };
  icons.appendChild(rm);
  row.appendChild(icons);

  return row;
}

// --- 5) CTA (dashed full-width) – opens OUR “Add action” modal ---
function d360_makeAddActionCTA(company){
  const el = dash360El;
  const box = el('div',{style:'margin-top:14px;'});
  // New unique class → no conflicts
  const btn = el('button',{class:'d360-add-action', type:'button'},['+ Add next action']);
  btn.onclick = () => { dash360OpenAddActionModal(company); };
  box.appendChild(btn);
  return box;
}


// ---6) Add modal---
// --- Add action modal (self-contained, reliable) ---

// Shared CSS so "+ Add next action" matches the Useful link button
function d360EnsureAddActionCSS(){
  if (document.getElementById('d360-add-action-css')) return;
  const s = document.createElement('style');
  s.id = 'd360-add-action-css';
  s.textContent = `
  /* Dashboard360 → Company → Next Actions CTA */
  .dash360-section-body .na-v16 .d360-add-action{
    display:block;
    width:100%;
    margin-top:12px;
    background:#f0f9ff;
    border:1px dashed #0ea5e9;
    border-radius:6px;
    padding:12px 16px;
    text-align:center;
    color:#0ea5e9;
    font-weight:700;
    cursor:pointer;
  }
  .dash360-section-body .na-v16 .d360-add-action:hover{
    background:#e0f2fe;
  }`;
  (document.head || document.body).appendChild(s);
}

function d360EnsureNAmodalCSS(){
  // remove old style (optional)
  const old = document.getElementById('d360-na-modal-css');
  if (old) old.remove();

  const css = `
/* ---- Modal shell: always centered + backdrop ---- */
dialog.na-modal {
  width: min(880px, 94vw);
  border: 0; padding: 0; margin: 0;
  background: #fff; border-radius: 12px; overflow: hidden;
  box-shadow: 0 25px 60px rgba(2,6,23,.25);
  position: fixed;                /* force centering even if UA doesn't */
  left: 50%; top: 50%;
  transform: translate(-50%, -50%);
}
dialog.na-modal::backdrop{ background: rgba(15,23,42,0.45); }

/* Header / Body */
.na-modal .modal-head{background:#00B4D8;color:#fff;font-weight:800;
  padding:16px 20px;display:flex;align-items:center;justify-content:space-between}
.na-modal .modal-body{padding:16px 20px}
.na-modal .field{margin-bottom:14px}
.na-modal .field label{display:block;font-weight:700;margin-bottom:6px;color:#0f172a}

/* Inputs */
.na-modal input[type=text], .na-modal input[type=date], .na-modal select, .na-modal textarea{
  width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:12px 14px;background:#fff;box-sizing:border-box
}
.na-modal textarea{min-height:120px;resize:vertical}

/* Subtasks block + spacing */
.na-modal .subtasks{margin-top:16px}
.na-modal .subtasks [data-d360-sublist]{ margin-bottom:14px; }

/* Subtask card */
.na-modal .subtasks .subcard{
  background:#f8fafc;border:1px solid #e5e7eb;border-radius:16px;padding:16px 16px 14px;position:relative;
  box-shadow:0 1px 0 rgba(0,0,0,.02);
}
.na-modal .subtasks .subgrid2{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-bottom:10px}
.na-modal .subtasks .field-label{display:block;font-weight:700;color:#0f172a;margin:0 0 6px}

/* DELETE button (smaller, perfectly centered, red circle) – overrides any earlier rule */
.na-modal .subtasks .subcard .remove{
  position:absolute;top:8px;right:8px;
  width:22px !important;height:22px !important;border-radius:50% !important;
  border:0 !important;background:#ef4444 !important;color:#fff !important;
  display:flex;align-items:center;justify-content:center;
  padding:0 !important;line-height:22px !important;font-weight:700;font-size:12px;
  cursor:pointer;
}
.na-modal .subtasks .subcard .remove:hover{background:#dc2626}

/* Footer */
.na-modal .modal-foot{display:flex;justify-content:flex-end;gap:12px;padding:14px 20px;border-top:1px solid #eef2f7}
.na-modal .btn{border-radius:10px;font-weight:700;padding:10px 16px;cursor:pointer}
.na-modal .btn-muted{border:1px solid #e5e7eb;background:#fff;color:#0f172a}
.na-modal .btn-primary{border:0;background:#0d9488;color:#fff}
.na-modal .btn-primary:hover{background:#0b8277}

/* “+ Add Subtask” button – like your screenshot (compact, subtle) */
.na-modal .btn-dashed-full{
  display:inline-flex;align-items:center;gap:8px;
  width:auto; padding:10px 14px;
  border:1px solid #e5e7eb; background:#fff; color:#0f172a;
  border-radius:12px; font-weight:700;
}
  `;
  const s = document.createElement('style');
  s.id = 'd360-na-modal-css';
  s.textContent = css;
  (document.head || document.body).appendChild(s);
}



/* ---- Company 360 safety shims (define only if missing) ---- */
if (typeof window.computeActionStatus !== 'function') {
  window.computeActionStatus = function(a){
    var subs = Array.isArray(a.subactions) ? a.subactions : [];
    var done = subs.filter(function(s){ return !!s.done; }).length;
    var total = subs.length;
    var st = String(a.status || '').toLowerCase();
    var status;
    if (st === 'done') status = 'Done';
    else if (st === 'doing' || st === 'in progress') status = 'In progress';
    else if (st === 'todo') status = 'To do';
    else status = (total>0 && done===total) ? 'Done' : (done>0 ? 'In progress' : 'To do');
    return { status: status, done: done, total: total };
  };
}
if (typeof window.hasActionOverdue !== 'function') {
  window.hasActionOverdue = function(a){
    if (!a || !a.due) return false;
    var d = new Date(a.due + 'T00:00:00');
    var now = new Date();
    var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    return d < today && String(a.status).toLowerCase() !== 'done';
  };
}
if (typeof window.getRelationText !== 'function') {
  window.getRelationText = function(a){
    var rt  = String(a.relatedType||'').toLowerCase();
    var rid = String(a.relatedId||'');
    if (rt === 'company') {
      var comp = (db?.companies||[]).find(function(c){ return String(c.id)===rid; });
      return 'Entrepreneurship — ' + (comp?.name || comp?.title || rid);
    }
    if (rt === 'job') {
      var j = (db?.jobs||[]).find(function(x){ return String(x.id)===rid; });
      return 'Entrepreneurship — ' + (j?.title || rid);
    }
    if (rt === 'coffee chat') {
      var ch = (db?.chats||[]).find(function(x){ return String(x.id)===rid; });
      return 'Entrepreneurship — ' + (ch?.with || ch?.name || rid);
    }
    return 'Entrepreneurship — ' + rid;
  };
}

// ---7Dash360 — ensure Next-Actions modal styling is available in this view---
function dash360OpenAddActionModal(company){
  d360EnsureNAmodalCSS();

  const companyId   = String(company.id);
  const companyName = company.name || company.title || companyId;

  const jobs = (db?.jobs||[]).filter(j => String(j.companyId) === companyId);
  const contactIds = new Set((db?.contacts||[]).filter(c => String(c.companyId) === companyId).map(c => String(c.id)));
  const chats = (db?.chats||[]).filter(ch => contactIds.has(String(ch.contactId)));

  // Close any of OUR existing add modals before opening a new one
  document.querySelectorAll('dialog.na-modal').forEach(d => { try { if (d.open) d.close(); } catch(e){} d.remove(); });

  const genId = (p='act') => (typeof uid==='function' ? uid(p) : (p + Math.random().toString(36).slice(2,9)));

  const dlg = document.createElement('dialog'); dlg.className = 'na-modal';

  // --- Header ---
  const head = document.createElement('div'); head.className='modal-head'; head.textContent='Add action';
  dlg.appendChild(head);

  // --- Body ---
  const body = document.createElement('div'); body.className='modal-body'; dlg.appendChild(body);

  // Title
  const fTitle = document.createElement('div'); fTitle.className='field';
  fTitle.innerHTML = `<label>Title*</label><input type="text" required placeholder="Title*">`;
  const iTitle = fTitle.querySelector('input'); body.appendChild(fTitle);

  // Related + Pick
  const row = document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr 1fr'; row.style.gap='18px';
  const fRel = document.createElement('div'); fRel.className='field';
  const fPick= document.createElement('div'); fPick.className='field';
  fRel.innerHTML  = `<label>Related to</label><select></select>`;
  fPick.innerHTML = `<label>Pick related item</label><select></select>`;
  const selRelated = fRel.querySelector('select');
  const selPick    = fPick.querySelector('select');
  row.appendChild(fRel); row.appendChild(fPick); body.appendChild(row);

  // Description
  const fDesc = document.createElement('div'); fDesc.className='field';
  fDesc.innerHTML = `<label>Description</label><textarea placeholder="Description (optional)"></textarea>`;
  const iDesc = fDesc.querySelector('textarea'); body.appendChild(fDesc);

  // Subtasks
  const subs = document.createElement('div'); subs.className='subtasks';
  subs.innerHTML = `
    <div class="field"><label>Subtasks (Optional)</label></div>
    <div class="subtasks-list" data-d360-sublist></div>
    <button type="button" class="btn-dashed-full" data-d360-addsub>+ Add Subtask</button>
  `;
  body.appendChild(subs);
  const sublist = subs.querySelector('[data-d360-sublist]');
  subs.querySelector('[data-d360-addsub]').onclick = ()=> addSubRow();

  function addSubRow(title='', due='', notes=''){
    const wrap = document.createElement('div');
    wrap.className = 'subcard';
    wrap.setAttribute('data-d360-subtask','1');
    wrap.innerHTML = `
      <button type="button" class="remove" title="Remove">×</button>
      <div class="subgrid2">
        <div><label class="field-label">Title</label>
          <input type="text" placeholder="Subtask title" value="${(title||'').replace(/"/g,'&quot;')}" required>
        </div>
        <div><label class="field-label">Due Date</label>
          <input type="date" value="${due||''}">
        </div>
      </div>
      <div><label class="field-label">Notes</label>
        <textarea placeholder="Add notes...">${(notes||'').replace(/</g,'&lt;')}</textarea>
      </div>
    `;
    wrap.querySelector('.remove').onclick = ()=> wrap.remove();
    sublist.appendChild(wrap);
    if (!title) wrap.querySelector('input[type=text]').focus();
  }

  // --- Footer ---
  const foot = document.createElement('div'); foot.className='modal-foot';
  const btnCancel = document.createElement('button'); btnCancel.className='btn btn-muted'; btnCancel.type='button'; btnCancel.textContent='Cancel';
  const btnAdd    = document.createElement('button'); btnAdd.className='btn btn-primary'; btnAdd.type='button'; btnAdd.textContent='Add';
  foot.appendChild(btnCancel); foot.appendChild(btnAdd); dlg.appendChild(foot);

  // --- Related options + Picker ---
  function setRelatedOptions(){
    selRelated.innerHTML = '';
    ['Company','Job','Coffee chat'].forEach(label=>{
      const o=document.createElement('option'); o.value=label; o.textContent=label; selRelated.appendChild(o);
    });
  }
  setRelatedOptions();

  function fillPick(){
    const k = (selRelated.value||'').toLowerCase();
    selPick.innerHTML = '';
    if (k === 'company'){
      selPick.disabled = true;
      const o = document.createElement('option'); o.value = companyId; o.textContent = companyName; selPick.appendChild(o);
    } else if (k === 'job'){
      selPick.disabled = false;
      jobs.forEach(j=>{ const o=document.createElement('option'); o.value=String(j.id); o.textContent=j.title||String(j.id); selPick.appendChild(o); });
      if (!selPick.options.length){ const o=document.createElement('option'); o.value=''; o.textContent='— No jobs for this company —'; selPick.appendChild(o); }
    } else { // coffee chat
      selPick.disabled = false;
      chats.forEach(ch=>{
        const c = (db?.contacts||[]).find(x => String(x.id)===String(ch.contactId));
        const label = c?.name || ch.with || ch.name || String(ch.id);
        const o=document.createElement('option'); o.value=String(ch.id); o.textContent=label; selPick.appendChild(o);
      });
      if (!selPick.options.length){ const o=document.createElement('option'); o.value=''; o.textContent='— No coffee chats for this company —'; selPick.appendChild(o); }
    }
  }
  selRelated.onchange = fillPick;
  selRelated.value = 'Company';
  fillPick();

  // --- Actions ---
  const closeAndRemove = () => { try { if (dlg.open) dlg.close(); } catch(e){} dlg.remove(); };
  btnCancel.onclick = closeAndRemove;

  btnAdd.onclick = ()=>{
    if (!iTitle.value.trim()) { iTitle.focus(); return; }

    // Save exactly what the UI shows (Title Case), not lower-case.
    const chosenType = selRelated.value;                                // "Company" | "Job" | "Coffee chat"
    const chosenId   = chosenType === 'Company' ? companyId : String(selPick.value||'');

    const subactions = [...sublist.querySelectorAll('[data-d360-subtask]')].map(row=>{
      const t = row.querySelector('input[type=text]')?.value?.trim()||'';
      const d = row.querySelector('input[type=date]')?.value||'';
      const n = row.querySelector('textarea')?.value||'';
      return t ? { title:t, due:d, notes:n, done:false } : null;
    }).filter(Boolean);

    const rec = {
      id: genId('act'),
      title: iTitle.value.trim(),
      description: iDesc.value || '',
      status: 'todo',
      completed: false,
      relatedType: chosenType,     // ✅ Title Case expected by your renderer
      relatedId: chosenId,         // ✅ selected id (or company id)
      createdAt: new Date().toISOString(), // ✅ Add creation date
      subactions
    };

    db.actions = db.actions || [];
    db.actions.unshift(rec);
    if (typeof save==='function') save();
    
    // Incremental DOM: append the new card into this company's list (no full refresh)
    try{
      const cardList = document.querySelector(`.dash360-company-card[data-id="${companyId}"] .dash360-section-body .na-v16`);
      if (cardList && typeof d360_makeCompanyActionCard === 'function'){
        const newCard = d360_makeCompanyActionCard(rec, { id: companyId });
        const ctaBtn = cardList.querySelector('.d360-add-action');
        const ctaBox = ctaBtn ? ctaBtn.closest('div') : null;
        if (ctaBox && cardList.contains(ctaBox)) {
          cardList.insertBefore(newCard, ctaBox);
        } else {
          cardList.appendChild(newCard);
        }
      }
    }catch(_){ }
    
    closeAndRemove();
    return; // avoid any global refreshes that can cause duplication
  };

  // mount & open
  document.body.appendChild(dlg);
  try { dlg.showModal(); }
  catch(e){ dlg.setAttribute('open',''); }   // fallback non-modal if needed
}


// Ensures the chosen relation (type + id) is forced onto the last-saved action


function dash360RenderLinks(company, mount){
  const el = dash360El;

  // 1) Title (keep existing if already present)
  let h = mount.querySelector('h4.dash360-h4');
  if (!h) {
    mount.prepend(el('h4', { class: 'dash360-h4', 'data-ico': '🔗' }, ['Useful links']));
  }

  // 2) Section body container
  let body = mount.querySelector('.dash360-section-body');
  if (!body) body = mount.appendChild(el('div', { class: 'dash360-section-body' }));
  body.innerHTML = '';

  // 3) Scoped CSS (insert once)
  (function ensureCSS(){
    if (document.getElementById('d360links-css')) return;
    var s = document.createElement('style');
    s.id = 'd360links-css';
    s.textContent =
      '#dash360-root .d360link-row{' +
        'position:relative;background:#f8fbff;border:1px solid #e6edf6;border-radius:14px;' +
        'padding:12px;display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:center;' +
      '}' +
      '#dash360-root .d360link-row input{' +
        'width:100%;box-sizing:border-box;background:#fff;border:1px solid #e5e7eb;border-radius:10px;' +
        'padding:10px 12px;outline:none;' +
      '}' +
      '#dash360-root .d360link-close{' +
        'position:absolute;top:6px;right:8px;border:none;background:transparent;cursor:pointer;' +
        'font-size:16px;line-height:1;color:#334155;opacity:.8;' +
      '}' +
      '#dash360-root .d360link-close:hover{opacity:1}' +
      '#dash360-root .d360link-add{' +
        'margin-top:12px;background:#f0f9ff;border:1px dashed #0ea5e9;border-radius:6px;' +
        'padding:12px 16px;text-align:center;color:#0ea5e9;font-weight:700;cursor:pointer;' +
      '}' +
      '#dash360-root .d360link-add:hover{background:#e0f2fe}' +
      '#dash360-root .dash360-empty{color:#6b7280;padding:8px 4px;}';
    (document.head || document.body).appendChild(s);
  })();

  // 4) Helpers
  function uid(prefix){ return (prefix || 'link') + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
  function mkDebounce(fn, ms){
    if (typeof dash360Debounce === 'function') return dash360Debounce(fn, ms);
    var t; return function(){ var args = arguments; clearTimeout(t); t = setTimeout(function(){ fn.apply(null, args); }, ms); };
  }

  // Ensure db.links exists (no modern ||= so it's safe everywhere)
  if (!Array.isArray(db.links)) db.links = [];
  var listRef = db.links;

  function persistField(id, field, value){
    var idx = listRef.findIndex(function(x){ return String(x.id) === String(id); });
    if (idx !== -1){
      listRef[idx][field] = value;
      if (typeof save === 'function') save();
    }
  }

  function removeRow(id){
    var idx = listRef.findIndex(function(x){ return String(x.id) === String(id); });
    if (idx !== -1){
      listRef.splice(idx, 1);
      if (typeof save === 'function') save();
      render();
    }
  }

  function buildRow(item){
    var row = el('div', { class: 'd360link-row', 'data-id': item.id });

    var inpLabel = el('input', { type: 'text', placeholder: 'Label' });
    var inpUrl   = el('input', { type: 'url',  placeholder: 'https://...' });

    inpLabel.value = item.label || '';
    inpUrl.value   = item.url   || '';

    inpLabel.addEventListener('input', mkDebounce(function(){
      persistField(item.id, 'label', inpLabel.value);
    }, 300));

    inpUrl.addEventListener('input', mkDebounce(function(){
      persistField(item.id, 'url', inpUrl.value);
    }, 300));

    var close = el('button', { class: 'd360link-close', type: 'button' }, ['×']);
    close.addEventListener('click', function () {
      // what to do after the user confirms
      function doDelete() {
        removeRow(item.id); // this already updates db + re-renders
      }
    
      // use your custom modal if available; else fall back to native confirm
      if (typeof window.dash360ShowConfirmModal === 'function') {
        window.dash360ShowConfirmModal(
          'Delete Useful Link',
          'Are you sure you want to delete this useful link?',
          'This action cannot be undone.',
          doDelete,     // onConfirm
          function(){}  // onCancel (no-op)
        );
      } else {
        if (confirm('Delete this useful link?')) doDelete();
      }
    });    

    row.appendChild(inpLabel);
    row.appendChild(inpUrl);
    row.appendChild(close);
    return row;
  }

  function render(){
    body.innerHTML = '';

    // existing items for this company
    listRef
      .filter(function(x){ return String(x.companyId) === String(company.id); })
      .forEach(function(l){ body.appendChild(buildRow(l)); });

    // dashed "Add" bar
    var addBar = el('div', { class: 'd360link-add' }, ['+ Add useful link']);
    addBar.addEventListener('click', function(){
      var item = { id: uid('link'), companyId: company.id, label: '', url: '' };
      listRef.push(item);
      if (typeof save === 'function') save();
      render();
    });
    body.appendChild(addBar);

    // empty state (optional)
    var hasAny = listRef.some(function(x){ return String(x.companyId) === String(company.id); });
    if (!hasAny){
      body.insertBefore(el('div', { class: 'dash360-empty' }, ['No useful links yet']), addBar);
    }
  }

  render();
}


// Helper functions
function dash360RenderCompaniesList(companies, container){
  container.innerHTML='';
  
  // Sort companies alphabetically by name (case-insensitive)
  const sortedCompanies = companies.slice().sort((a, b) => {
    const nameA = (a.name || '').toLowerCase();
    const nameB = (b.name || '').toLowerCase();
    return nameA.localeCompare(nameB);
  });
  
  sortedCompanies.forEach(c=> container.appendChild(dash360CreateCompanyCard(c)));
  
  // Sync label for pre-opened cards (optional hardening)
  document.querySelectorAll('#dash360-root .dash360-company-card.open .dash360-details')
    .forEach(btn => btn.innerHTML = 'Hide ▲');
}

function dash360SectionPlaceholder(title, cls){
  const wrap = dash360El('div',{class:'dash360-section'});
  
  // Map titles to icons
  const iconMap = {
    'Investigation log': '🔎',
    'Contacts': '👥',
    'Coffee chats': '☕',
    'Next actions': '✅'
  };
  
  const icon = iconMap[title] || '📋';
  wrap.appendChild(dash360El('h4',{class:'dash360-h4','data-ico':icon},[title]));
  wrap.appendChild(dash360El('div',{class:'dash360-empty'},['Coming next']));
  return wrap;
}

function dash360BindToggle(){
  const btnEntre = document.getElementById('dash360-toggle-entre');
  const btnComp  = document.getElementById('dash360-toggle-company');
  if(!btnEntre || !btnComp) return;
  
  // Remove existing listeners to prevent duplicates
  btnEntre.onclick = null;
  btnComp.onclick = null;
  
  btnEntre.onclick = ()=>{ 
    btnEntre.classList.add('is-active'); 
    btnComp.classList.remove('is-active'); 
    dash360SwitchView('entre'); 
  };
  btnComp.onclick = ()=>{ 
    btnComp.classList.add('is-active'); 
    btnEntre.classList.remove('is-active'); 
    dash360SwitchView('company'); 
  };
  
  // Initialize the correct view based on which button is active
  if(btnComp.classList.contains('is-active')) {
    // Company button is active, show Company view
    dash360SwitchView('company');
  } else if(btnEntre.classList.contains('is-active')) {
    // Entrepreneurship button is active, show Entrepreneurship view
    dash360SwitchView('entre');
  } else {
    // No button is active, default to Company
    btnComp.classList.add('is-active');
    dash360SwitchView('company');
  }
}

// Initialize the toggle functionality when the page loads
document.addEventListener('DOMContentLoaded', () => {
  // If we're on the ideas tab, bind the toggle
  if (currentTab === 'ideas') {
    setTimeout(() => dash360BindToggle(), 100);
  }
});

/* Create dropdown menu for table actions */
function makeActionDropdown(editAction, deleteAction, newActionData = null) {
  const dropdown = el('div', {class: 'action-dropdown'});
  
  const btn = el('button', {class: 'action-dropdown-btn'}, [icon('dots')]);
  const menu = el('div', {class: 'action-dropdown-menu'});
  
  const editItem = el('button', {class: 'action-dropdown-item'}, [icon('edit'), 'Edit']);
  const deleteItem = el('button', {class: 'action-dropdown-item'}, [icon('trash'), 'Delete']);
  
  editItem.onclick = (e) => {
    e.stopPropagation();
    closeDropdown();
    editAction && editAction();
  };
  
  deleteItem.onclick = (e) => {
    e.stopPropagation();
    closeDropdown();
    deleteAction && deleteAction();
  };
  
  // Add "New Action" item first if newActionData is provided
  if (newActionData) {
    const newActionItem = el('button', {class: 'action-dropdown-item'}, [icon('plus'), 'New Action']);
    newActionItem.onclick = (e) => {
      e.stopPropagation();
      closeDropdown();
      openActionCreateModal(newActionData);
    };
    menu.appendChild(newActionItem);
  }
  
  menu.appendChild(editItem);
  menu.appendChild(deleteItem);
  
  function closeDropdown() {
    menu.classList.remove('open');
    if (menu.parentNode === document.body) {
      document.body.removeChild(menu);
    }
  }
  
  btn.onclick = (e) => {
    e.stopPropagation();
    
    // Close all other dropdowns
    document.querySelectorAll('.action-dropdown-menu.open').forEach(m => {
      m.classList.remove('open');
      if (m.parentNode === document.body) {
        document.body.removeChild(m);
      }
    });
    
    if (menu.classList.contains('open')) {
      closeDropdown();
    } else {
      // Portal approach: Move menu to body for overlay positioning
      document.body.appendChild(menu);
      menu.classList.add('open');
      
      // Position using fixed coordinates
      const rect = btn.getBoundingClientRect();
      const menuWidth = 120; // Approximate menu width
      const menuHeight = newActionData ? 120 : 80; // Approximate menu height
      
      let left = rect.right + 4; // Default: to the right of button
      let top = rect.top; // Default: align with button top
      
      // Check if menu would go off-screen horizontally
      if (left + menuWidth > window.innerWidth) {
        left = rect.left - menuWidth - 4; // Position to the left
      }
      
      // Check if menu would go off-screen vertically
      if (top + menuHeight > window.innerHeight) {
        top = rect.bottom - menuHeight; // Position above button
      }
      
      // Ensure menu doesn't go off top of screen
      if (top < 0) {
        top = 4;
      }
      
      // Ensure menu doesn't go off left of screen
      if (left < 0) {
        left = 4;
      }
      
      menu.style.left = left + 'px';
      menu.style.top = top + 'px';
    }
  };
  
  dropdown.appendChild(btn);
  // Don't append menu to dropdown - it will be portaled to body when opened
  
  return dropdown;
}

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.action-dropdown') && !e.target.closest('.action-dropdown-menu')) {
    document.querySelectorAll('.action-dropdown-menu.open').forEach(menu => {
      menu.classList.remove('open');
      if (menu.parentNode === document.body) {
        document.body.removeChild(menu);
      }
    });
  }
});

/* Segmented control (single-select tabs) */
function makeSegControl(ariaLabel, options, initialValue, onChange){
  const control = el('div',{class:'segControl', role:'tablist', 'aria-label':ariaLabel});
  options.forEach(opt=>{
    const active = opt.value===initialValue;
    const b = el('button',{
      class:'segBtn'+(active?' isActive':''),
      role:'tab',
      'aria-selected': active ? 'true' : 'false',
      'data-value': opt.value
    },[opt.label]);
    control.appendChild(b);
  });
  control.addEventListener('click', e=>{
    const btn = e.target.closest('.segBtn'); if(!btn) return;
    control.querySelectorAll('.segBtn').forEach(b=>{
      const active = b===btn;
      b.classList.toggle('isActive', active);
      b.setAttribute('aria-selected', active ? 'true' : 'false');
    });
    onChange && onChange(btn.dataset.value);
  });
  control.addEventListener('keydown', e=>{
    if(!['ArrowLeft','ArrowRight','Home','End'].includes(e.key)) return;
    const btns = Array.from(control.querySelectorAll('.segBtn'));
    const i = btns.indexOf(document.activeElement);
    let j = i>=0 ? i : 0;
    if(e.key==='ArrowRight') j=(i+1)%btns.length;
    if(e.key==='ArrowLeft')  j=(i-1+btns.length)%btns.length;
    if(e.key==='Home')       j=0;
    if(e.key==='End')        j=btns.length-1;
    btns[j].focus(); e.preventDefault();
  });
  return control;
}

/* Table/Funnel view switch (text 6px above icon) */
function makeViewSwitch(current, onChange){
  const wrap = el('div',{class:'viewSwitch', role:'group', 'aria-label':'View'});
  const mk = (value,label,iconName)=>{
    const isActive = current===value;
    const btn = el('button',{class:'viewBtn'+(isActive?' isActive':''), 'data-value':value, 'aria-pressed': isActive?'true':'false'});
    btn.appendChild(el('div',{class:'label'},[label]));
    btn.appendChild(el('span',{class:'icon'},[icon(iconName)]));
    btn.onclick = ()=>{
      wrap.querySelectorAll('.viewBtn').forEach(b=>{
        const active = b===btn;
        b.classList.toggle('isActive', active);
        b.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
      onChange && onChange(value);
    };
    return btn;
  };
  wrap.appendChild(mk('table','Table','table'));
  wrap.appendChild(mk('funnel','Board','board'));  
  return wrap;
}

function confirmModal(title, message, onConfirm){
  const box = el('div'); box.appendChild(el('p',{},[message]));
  const actions = el('div',{class:'right'});
  const cancel = el('button',{class:'iconbtn'},['Cancel']);
  const yes = el('button',{class:'btn-destructive'},['Delete']);
  cancel.onclick = ()=> modal.close();
  yes.onclick = ()=>{ modal.close(); onConfirm&&onConfirm(); };
  actions.appendChild(cancel); actions.appendChild(yes); box.appendChild(actions);
  modal.open(title, box);
}
function normalizeUrl(u){ if(!u) return ''; const t = String(u).trim(); if(!t) return ''; return /^https?:\/\//i.test(t) ? t : 'https://' + t; }
function today(){ const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
function fmtDate(iso){
  if(!iso) return '—';
  const [y,m,d] = String(iso).split('T')[0].split('-');
  return (y && m && d) ? `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}` : iso;
}
function getRelationText(a){
    if(a.relatedType==='Company'){
      const c = db.companies.find(x=>x.id===a.relatedId); return c? `Company — ${c.name}`:'Company';
    }else if(a.relatedType==='Job'){
      const j = db.jobs.find(x=>x.id===a.relatedId); return j? `Job — ${j.title}`:'Job';
    }else if(a.relatedType==='Coffee chat'){
      const ch = db.chats.find(x=>x.id===a.relatedId);
      const ct = ch ? db.contacts.find(c=>c.id===ch.contactId) : null;
      return ct? `Coffee chat — ${ct.name}` : 'Coffee chat';
    }else if(a.relatedType==='Entrepreneurship'){
      const idea = (db.ideas||[]).find(x=>x.id===a.relatedId); 
      return idea? `Entrepreneurship — ${idea.name}` : 'Entrepreneurship';
    }
    return 'Other';
  }

/* ---------------- Settings (gear) ---------------- */
const gearBtn = $('#gearBtn');
const settingsMenu = $('#settingsMenu');
gearBtn.addEventListener('click', ()=>{
  const open = settingsMenu.classList.contains('open');
  document.querySelectorAll('.actions .menu').forEach(m=> m.classList.remove('open'));
  settingsMenu.classList.toggle('open', !open);
});
document.addEventListener('click', (e)=>{
  if(!e.target.closest('#actionsMenu')) settingsMenu.classList.remove('open');
});
$('#menuExport').addEventListener('click', async ()=>{
  try{
    const logos = [];
    for (const c of (db.companies||[])){
      if (c.logoId){
        const rec = await logosGet(c.logoId);
        if (rec && rec.blob){
          const dataUrl = await blobToDataUrl(rec.blob);
          logos.push({ id: rec.id, type: rec.type || rec.blob.type || 'image/webp', dataUrl });
        }
      }
    }
    const payload = { ...db, images: { logos } };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = el('a', {href:url, download:`rolemap_backup_${new Date().toISOString().slice(0,10)}.json`});
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }catch(err){ alert('Export failed: ' + (err&&err.message || err)); }
});
$('#fileImport').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return; const reader = new FileReader();
  reader.onload = async () => { try{ const data = JSON.parse(String(reader.result)); if(!data.companies||!data.jobs||!data.contacts||!data.chats||!('actions' in data)){ throw new Error('Invalid backup'); }
    if (data.images && data.images.logos && Array.isArray(data.images.logos)){
      for (const L of data.images.logos){ if (L && L.id && L.dataUrl){ const blob = await dataUrlToBlob(L.dataUrl); await logosPut(L.id, blob, L.type || blob.type || 'image/webp'); } }
      delete data.images;
    }
    db = data; save(); render(); alert('Import successful.'); }catch(err){ alert('Import failed: '+(err&&err.message || err)); } };
  reader.readAsText(f);
});

/* ---------------- Modal system ---------------- */
const modal = { back: $('#modalBack'), title: $('#modalTitle'), body: $('#modalBody'), open(title, node){ this.title.textContent = title; this.body.innerHTML=''; this.body.appendChild(node); this.back.style.display='flex'; }, close(){ this.back.style.display='none'; } };
$('#modalClose').onclick = ()=> modal.close();
window.addEventListener('keydown', e=>{ if(e.key==='Escape') modal.close(); });

/* ---------------- Tabs dispatcher ---------------- */
let currentTab = 'companies';
let currentView = 'cards'; // Global view state for Next Actions module

// Global renderIdeas function for modals to call
function renderIdeas() {
  // If we're not in the ideas tab, just call render() to switch to it
  if (currentTab !== 'ideas') {
    render();
    return;
  }
  
  // If the local renderIdeas function is available, use it (preserves state)
  if (window.renderIdeasLocal) {
    window.renderIdeasLocal();
  } else {
    // Fallback to re-render the entire tab
    render();
  }
}
$('#tabs').addEventListener('click', (e)=>{
  const t = e.target.closest('.tab'); if(!t) return; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); currentTab = t.dataset.tab; render();
  
  // Bind toggle functionality when switching to ideas tab
  if(currentTab === 'ideas') {
    setTimeout(() => dash360BindToggle(), 100);
  }
});
function render(){ const mount = $('#view'); mount.innerHTML = '';
  if(currentTab==='companies') return mount.appendChild(viewCompanies());
  if(currentTab==='jobs') return mount.appendChild(viewJobs());
  if(currentTab==='chats') return mount.appendChild(viewChats());
  if(currentTab==='contacts') return mount.appendChild(viewContacts());
  if(currentTab==='actions') return mount.appendChild(viewNextActions());
  if(currentTab==='ideas') return mount.appendChild(viewIdeas());
}

/* ---------------- Companies ---------------- */
function viewCompanies(){
  const wrap = el('div', {});

  // --- state
  let typeFilter = 'All', nameFilter = '', sectorFilter = 'All', priorityFilter = 'All';
  let sortKey = 'name', sortDir = 'ascending';

  // --- toolbar row
  const toolbar = el('div',{class:'toolbarRow'});

  // Search (left)
  let debounce;
  const {wrap: searchWrapCompanies} = makeSearch('Search by company name', v=>{
    nameFilter = v;
    clearTimeout(debounce);
    debounce = setTimeout(()=> drawTable(), 120);
  });
  
  const leftCo = el('div',{class:'toolbarLeft'});
  leftCo.appendChild(searchWrapCompanies);

  // Inline filters (Sector + Priority)
  const filtersBar = el('div',{class:'filters-inline'});

  const fSector = el('div',{class:'field'});
  fSector.appendChild(el('label',{},[icon('filter'),'Sector']));
  const sSel = el('select');
  
  // Add "All" option first
  sSel.appendChild(el('option',{value:'All'},['All']));
  
  // Add comprehensive sector options with optgroups
  const sectorGroups = [
    {
      label: 'Consulting & Professional Services',
      options: ['IT & Digital Consulting', 'Management Consulting', 'Other Advisory Services', 'Strategy Consulting']
    },
    {
      label: 'Consumer & Commerce', 
      options: ['E-commerce', 'Fashion & Lifestyle', 'Food & Beverage', 'Gaming & Entertainment', 'Media, Marketing & Communications', 'Retail', 'Sports & Recreation']
    },
    {
      label: 'Finance & Business',
      options: ['Accounting & Audit', 'Banking', 'Corporate Strategy', 'Insurance', 'Startups & Entrepreneurship', 'Venture Capital & Private Equity']
    },
    {
      label: 'Industry & Infrastructure',
      options: ['Agriculture & FoodTech', 'Chemicals & Materials', 'Construction & Civil Engineering', 'Energy & CleanTech', 'Logistics, Mobility & Transport', 'Manufacturing & Industry 4.0', 'Real Estate & PropTech']
    },
    {
      label: 'Other',
      options: ['Cross-sector roles', 'Unspecified / General']
    },
    {
      label: 'Public & Social Impact',
      options: ['Education & Training', 'Government & Public Policy', 'Healthcare & Social Care', 'Legal & Compliance', 'Non-Profit & Social Impact', 'Security & Defense']
    },
    {
      label: 'Technology & Innovation',
      options: ['Artificial Intelligence & Machine Learning', 'Climate Tech', 'Cybersecurity', 'Data Science & Analytics', 'Edtech', 'Fintech', 'Healthtech & Medtech', 'Software Development & Engineering', 'Space & Aerospace']
    }
  ];
  
  sectorGroups.forEach(group => {
    const optgroup = document.createElement('optgroup');
    optgroup.label = group.label;
    group.options.forEach(option => {
      optgroup.appendChild(el('option',{value:option},[option]));
    });
    sSel.appendChild(optgroup);
  });
  
  sSel.value = sectorFilter;
  sSel.onchange = ()=>{ sectorFilter = sSel.value; drawTable(); };
  fSector.appendChild(sSel);
  filtersBar.appendChild(fSector);

  const fPrio = el('div',{class:'field'});
  fPrio.appendChild(el('label',{},[icon('filter'),'Priority']));
  const pSel = el('select');
  ['All','High','Medium','Low'].forEach(v=> pSel.appendChild(el('option',{value:v},[v])));
  pSel.value = priorityFilter;
  pSel.onchange = ()=>{ priorityFilter = pSel.value; drawTable(); };
  fPrio.appendChild(pSel);
  filtersBar.appendChild(fPrio);

  // Type segmented control (moved to left with filters)
  const typeOptions = [
    {label:'All', value:'All'},
    {label:'Dream', value:'Dream'},
    {label:'Entrepreneurship', value:'Entrepreneurship'},
    {label:'Other', value:'Other'},
  ];
  const typeControl = makeSegControl('Company type', typeOptions, typeFilter, (val)=> {
    typeFilter = val || 'All';
    drawTable();
  });
  const typeField = el('div',{class:'field'});
  typeField.appendChild(el('label',{},[icon('filter'),'Company Type']));
  typeField.appendChild(typeControl);
  filtersBar.appendChild(typeField);

  leftCo.appendChild(filtersBar);
  toolbar.appendChild(leftCo);

  // Right cluster: Add only
  const rightCo = el('div',{class:'toolbarRight'});
  const addBtn = el('button',{class:'btn-teal'},['+ Add company']);
  addBtn.onclick = ()=> openCompanyModal();
  rightCo.appendChild(addBtn);

  toolbar.appendChild(rightCo);
  wrap.appendChild(toolbar);

  // extra spacing before table
  wrap.appendChild(el('div',{style:'height:12px'}));

  // --- table (sortable)
  const table = el('table');
  const thead = el('thead');
  const trh = el('tr');
  const cols = [
    {key:'name',     label:'Name',     sortable:true},
    {key:'type',     label:'Type',     sortable:true},
    {key:'sector',   label:'Sector',   sortable:true},
    {key:'priority', label:'Priority', sortable:true},
    {key:'location', label:'Location', sortable:true},
    {key:'website',  label:'Website',  sortable:false},
    {key:'_actions', label:'Actions',  sortable:false},
  ];

  cols.forEach(c=>{
    const th = el('th',{},[c.label, el('span',{class:'sort-ind'})]);
    if(c.sortable){
      th.classList.add('sortable');
      th.setAttribute('aria-sort', c.key===sortKey ? sortDir : 'none');
      th.onclick = ()=>{
        if(sortKey !== c.key){ sortKey = c.key; sortDir = 'ascending'; }
        else { sortDir = (sortDir==='ascending' ? 'descending' : 'ascending'); }
        updateHeaderSorts();
        drawTable();
      };
    }
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  const tbody = el('tbody');
  table.appendChild(thead); table.appendChild(tbody);
  wrap.appendChild(table);

  function updateHeaderSorts(){
    const ths = thead.querySelectorAll('th');
    ths.forEach((th,i)=>{
      const col = cols[i];
      if(!col.sortable){ th.removeAttribute('aria-sort'); return; }
      th.setAttribute('aria-sort', col.key===sortKey ? sortDir : 'none');
    });
  }

  function filtered(list){
    let L = list.slice();

    if(typeFilter!=='All') L = L.filter(c=> (c.type||'Other')===typeFilter);
    if(sectorFilter!=='All')   L = L.filter(c=> (c.sector||'')===sectorFilter);
    if(priorityFilter!=='All') L = L.filter(c=> (c.priority||'')===priorityFilter);
    if(nameFilter.trim()){
      const q = nameFilter.trim().toLowerCase();
      L = L.filter(c=> (c.name||'').toLowerCase().includes(q));
    }

    if(!sortKey) return L;
    return L.sort((a,b)=>{
      const av = (a[sortKey]||'').toString().toLowerCase();
      const bv = (b[sortKey]||'').toString().toLowerCase();
      if(av < bv) return sortDir==='ascending' ? -1 : 1;
      if(av > bv) return sortDir==='ascending' ?  1 : -1;
      return 0;
    });
  }

  function drawTable(){
    tbody.innerHTML = '';
    filtered(db.companies).forEach(c=>{
      const tr = el('tr');

      // Name + logo
      const nameTd = el('td');
      const nameWrap = el('div',{style:'display:flex;align-items:center;gap:8px'});
      const img = el('img',{alt:'', style:'width:24px;height:24px;object-fit:contain;border-radius:4px;background:#fff'});
      if (c.logoId){
        logosGet(c.logoId).then(rec=>{ if(rec&&rec.blob){ img.src = URL.createObjectURL(rec.blob); } }).catch(()=>{});
      }
      nameWrap.appendChild(img);
      nameWrap.appendChild(el('span',{},[c.name||'—']));
      nameTd.appendChild(nameWrap);
      tr.appendChild(nameTd);
      tr.appendChild(el('td',{},[c.type||'—']));
      tr.appendChild(el('td',{},[c.type||'—']));
      tr.appendChild(el('td',{},[c.priority||'—']));
      tr.appendChild(el('td',{},[c.location||'—']));

      const wtd = el('td');
      if(c.website){
        wtd.appendChild(el('a',{href:normalizeUrl(c.website),target:'_blank',class:'link small'},['open']));
      }else{
        wtd.textContent = '—';
      }
      tr.appendChild(wtd);

      const act = el('td');
      const dropdown = makeActionDropdown(
        () => openCompanyModal(c),
        () => confirmModal('Delete company', `Delete "${c.name}"?`, async ()=>{
          db.jobs     = db.jobs.filter(j=> j.companyId!==c.id);
          db.contacts = db.contacts.filter(ct=> ct.companyId!==c.id);
          db.chats    = db.chats.filter(ch=> ch.companyId!==c.id);
          if (c.logoId) { try{ await logosDelete(c.logoId); }catch(_){} }
          db.companies= db.companies.filter(x=>x.id!==c.id);
          save(); render();
        }),
        { relatedType: 'Company', relatedId: c.id }
      );
      act.appendChild(dropdown);
      tr.appendChild(act);

      tr.addEventListener('click', (ev)=>{ if(ev.target.closest('button,a')) return; openCompanyModal(c); });
      tbody.appendChild(tr);
    });
  }

  updateHeaderSorts();
  drawTable();
  return wrap;
}


/* ---------------- Jobs ---------------- */
const JOB_STATUSES = ["To apply","Applied","Test","Interview","Offer","Rejected"];
function viewJobs(){
  const wrap = el('div',{});
  // View chips
const toolbar = el('div',{class:'toolbarRow'});

// Search (left)
let titleFilter = '';
let searchDebounce;
const {wrap: searchWrapJobs} = makeSearch('Search by job name', v=>{
  titleFilter = v;
  clearTimeout(searchDebounce);
  searchDebounce = setTimeout(()=> syncView(), 120);
});
toolbar.appendChild(searchWrapJobs);

// Filters (left, after search)
let companyFilter = 'All', statusFilter = 'All';
const filtersBar = el('div',{class:'filters-inline'});

// Status
const fStatus = el('div',{class:'field'});
fStatus.appendChild(el('label',{},[icon('filter'),'Status']));
const stSel = el('select',{class:'small-select'});
['All', ...JOB_STATUSES].forEach(v=> stSel.appendChild(el('option',{value:v},[v])));
stSel.onchange = ()=>{ statusFilter = stSel.value; syncView(); };
fStatus.appendChild(stSel);
filtersBar.appendChild(fStatus);

// Company
const fCompany = el('div',{class:'field'});
fCompany.appendChild(el('label',{},[icon('filter'),'Company']));
const companies = ['All', ...Array.from(new Set(db.companies.map(c=>c.name)))];
const coSel = el('select',{class:'small-select'});
companies.forEach(v=> coSel.appendChild(el('option',{value:v},[v])));
coSel.onchange = ()=>{ companyFilter = coSel.value; syncView(); };
fCompany.appendChild(coSel);
filtersBar.appendChild(fCompany);

toolbar.appendChild(filtersBar);

// Right cluster: view icons + Add
const rightJobs = el('div',{class:'toolbarRight'});
let view = window.jobsView || 'funnel';
const viewSwitch = makeViewSwitch(view, (val)=>{ view = val; window.jobsView = val; syncView(); });
rightJobs.appendChild(viewSwitch);

const add = el('button',{class:'btn-teal'},['+ Add job']);
add.onclick = ()=> openJobModal();
rightJobs.appendChild(add);

toolbar.appendChild(rightJobs);
wrap.appendChild(toolbar);

  
  const content = el('div'); wrap.appendChild(content); 
  
  function syncView(){
    content.innerHTML = '';
    content.appendChild(view === 'funnel' ? funnelView() : tableView());
  }
  
  syncView();
  return wrap;

  function applyFilters(list){
    let output = list.slice();
    if(statusFilter!=='All') output = output.filter(j=> j.status===statusFilter);
    if(companyFilter!=='All') { const co = db.companies.find(c=>c.name===companyFilter); output = output.filter(j=> j.companyId && co && j.companyId===co.id); }
    if(titleFilter.trim()) { const q = titleFilter.trim().toLowerCase(); output = output.filter(j=> (j.title||'').toLowerCase().includes(q)); }
    return output;
  }
  function funnelView(){
    window.DND = window.DND || {id:null,type:null};
    const board = el('div',{class:'kanban'});
    JOB_STATUSES.forEach(st=>{
      const col = el('div',{class:'kan-col card'});
      const h = el('div',{class:'colhead'+(st==='Rejected'?' rejected':'')},[st]);
      const body = el('div',{class:'card-body dropzone', 'data-stage':st});
      body.ondragover = e=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; body.classList.add('drop-over'); };
      body.ondragleave = ()=> body.classList.remove('drop-over');
      body.ondrop = e=>{ e.preventDefault(); body.classList.remove('drop-over'); const id = (e.dataTransfer && e.dataTransfer.getData('text/plain')) || window.DND?.id; if(!id || (window.DND?.type && window.DND.type!=='job')) return; const job = db.jobs.find(j=>j.id===id); if(!job){ console.warn('Drop: job not found', id); return; } job.status = st; save(); syncView(); window.DND.id=null; window.DND.type=null; };
      col.ondragover = e=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; body.classList.add('drop-over'); };
      col.ondrop = (e)=>{ e.preventDefault(); body.classList.remove('drop-over'); const id = (e.dataTransfer && e.dataTransfer.getData('text/plain')) || window.DND?.id; if(!id || (window.DND?.type && window.DND.type!=='job')) return; const job = db.jobs.find(j=>j.id===id); if(!job){ console.warn('Drop: job not found', id); return; } job.status = st; save(); syncView(); window.DND.id=null; window.DND.type=null; };
      applyFilters(db.jobs).filter(j=>j.status===st).forEach(j=>{
        const card = el('div',{class:'kan-card', draggable:'true'}); card.dataset.id = j.id;
        card.addEventListener('dragstart', e=>{ window.DND={id:j.id,type:'job'}; e.dataTransfer.effectAllowed='move'; try{ e.dataTransfer.setData('text/plain', j.id); }catch(_){} });
        card.addEventListener('click', (e)=>{ if(e.target.closest('a,button')) return; openJobDetails(j); });
        const act = el('div',{class:'card-actions'});
        const bEdit = el('button',{class:'iconbtn',title:'Edit', draggable:'false'},[icon('edit')]); bEdit.onmousedown = e=> e.stopPropagation(); bEdit.onclick = e=>{ e.stopPropagation(); openJobModal(j); };
        const bAction = el('button',{class:'iconbtn',title:'New Action', draggable:'false'},[icon('plus')]); bAction.onmousedown = e=> e.stopPropagation(); bAction.onclick = e=>{ e.stopPropagation(); openActionCreateModal({ relatedType: 'Job', relatedId: j.id }); };
        const bDel = el('button',{class:'iconbtn',title:'Delete', draggable:'false'},[icon('close')]); bDel.onmousedown = e=> e.stopPropagation(); bDel.onclick = e=>{ e.stopPropagation(); confirmModal('Delete job',`Delete "${j.title}"?`,()=>{ db.jobs = db.jobs.filter(x=>x.id!==j.id); db.chats = db.chats.map(ch=> ch.jobId===j.id? {...ch, jobId:''}: ch); save(); syncView(); }); };
        act.appendChild(bAction); act.appendChild(bEdit); act.appendChild(bDel); card.appendChild(act);
        card.appendChild(el('div',{style:'font-weight:700;color:var(--navy);padding-right:60px'},[j.title]));
        const comp = db.companies.find(c=>c.id===j.companyId);
        card.appendChild(el('div',{class:'muted'},[comp?comp.name:'—']));
        const row = el('div',{style:'display:flex;gap:6px;align-items:center;margin-top:6px'});
        if(j.sourceLink){ const a = el('a',{href:normalizeUrl(j.sourceLink),target:'_blank',class:'link small'},['job description']); a.onclick = e=> e.stopPropagation(); row.appendChild(a); }
        card.appendChild(row);
        body.appendChild(card);
      });
      col.appendChild(h); col.appendChild(body); board.appendChild(col);
    });
    return board;
  }
  function tableView(){
    let sortKey = null, sortDir = 'ascending';
    const tbl = el('table');
    const thead = el('thead'); const trh = el('tr');
    const cols = [
      {key:'title', label:'Title', sortable:true},
      {key:'company', label:'Company', sortable:true},
      {key:'status', label:'Status', sortable:true},
      {key:'location', label:'Location', sortable:true},
      {key:'salary', label:'Salary', sortable:true},
      {key:'source', label:'Job description', sortable:false},
      {key:'_actions', label:'Actions', sortable:false}
    ];
    cols.forEach(c=>{
      const th = el('th',{},[c.label, el('span',{class:'sort-ind'})]);
      if(c.sortable){
        th.classList.add('sortable');
        th.setAttribute('aria-sort','none');
        th.onclick = ()=>{
          if(sortKey !== c.key){ sortKey = c.key; sortDir = 'ascending'; }
          else { sortDir = (sortDir==='ascending' ? 'descending' : 'ascending'); }
          updateHeaderSorts(); drawBody();
        };
      }
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    const tbody = el('tbody');
    tbl.appendChild(thead); tbl.appendChild(tbody);
    function updateHeaderSorts(){ const ths = thead.querySelectorAll('th'); ths.forEach((th,i)=>{ const col = cols[i]; if(!col.sortable){ th.removeAttribute('aria-sort'); return; } if(col.key === sortKey){ th.setAttribute('aria-sort', sortDir); } else { th.setAttribute('aria-sort','none'); } }); }
    function getCompanyName(id){ const c = db.companies.find(x=>x.id===id); return c? c.name: ''; }
    function applyAll(list){
      let L = list.slice();
      // apply filters from view scope
      if(typeof statusFilter !== 'undefined' && statusFilter!=='All') L = L.filter(j=> j.status===statusFilter);
      if(typeof companyFilter !== 'undefined' && companyFilter!=='All') { const co = db.companies.find(c=>c.name===companyFilter); L = L.filter(j=> j.companyId && co && j.companyId===co.id); }
      if(typeof titleFilter !== 'undefined' && titleFilter.trim()) { const q = titleFilter.trim().toLowerCase(); L = L.filter(j=> (j.title||'').toLowerCase().includes(q)); }
      if(!sortKey) return L;
      L = L.slice().sort((a,b)=>{
        let av, bv;
        if(sortKey==='company'){ av = getCompanyName(a.companyId).toLowerCase(); bv = getCompanyName(b.companyId).toLowerCase(); }
        else { av = (a[sortKey]||'').toString().toLowerCase(); bv = (b[sortKey]||'').toString().toLowerCase(); }
        if(av < bv) return sortDir==='ascending' ? -1 : 1;
        if(av > bv) return sortDir==='ascending' ? 1 : -1;
        return 0;
      });
      return L;
    }
    function drawBody(){
      tbody.innerHTML='';
      applyAll(db.jobs).forEach(j=>{
        const tr = el('tr');
        tr.appendChild(el('td',{},[j.title || '—']));
        tr.appendChild(el('td',{},[getCompanyName(j.companyId) || '—']));
        tr.appendChild(el('td',{},[j.status || '—']));
        tr.appendChild(el('td',{},[j.location || '—']));
        tr.appendChild(el('td',{},[j.salary || '—']));
        const s = el('td'); if(j.sourceLink){ const a = el('a',{href:normalizeUrl(j.sourceLink),target:'_blank',class:'link small'},['job description']); s.appendChild(a); } else s.textContent='—'; tr.appendChild(s);
        const act = el('td');
        const dropdown = makeActionDropdown(
          () => openJobModal(j), // Edit action
          () => confirmModal('Delete job',`Delete "${j.title}"?`,()=>{ // Delete action
            db.jobs = db.jobs.filter(x=>x.id!==j.id); 
            db.chats = db.chats.map(ch=> ch.jobId===j.id? {...ch, jobId:''}: ch); 
            save(); syncView(); 
          }),
          { relatedType: 'Job', relatedId: j.id } // New Action data
        );
        act.appendChild(dropdown); tr.appendChild(act);
        tr.addEventListener('click', (ev)=>{ if(ev.target.closest('button,a')) return; openJobDetails(j); });
        tbody.appendChild(tr);
      });
    }
    drawBody(); updateHeaderSorts(); return tbl;
  }
}
function openJobDetails(j){
  const box = el('div');
  const g1 = el('div',{class:'row'});
  const comp = db.companies.find(c=>c.id===j.companyId);
  g1.appendChild(infoField('Title', j.title || '—'));
  g1.appendChild(infoField('Company', comp? comp.name : '—'));
  const g2 = el('div',{class:'row'});
  g2.appendChild(infoField('Status', j.status || '—'));
  g2.appendChild(infoField('Location', j.location || '—'));
  const g3 = el('div',{class:'row'});
  g3.appendChild(infoField('Salary', j.salary || '—'));
  g3.appendChild(infoField('Last follow-up', j.lastFollowUp ? fmtDate(j.lastFollowUp) : '—'));
  const g4 = el('div',{}); g4.appendChild(infoField('Notes', j.notes || '—'));
  if(j.sourceLink){ const url = normalizeUrl(j.sourceLink); const jd = el('div'); jd.appendChild(el('label',{html:'Job description'})); jd.appendChild(el('a',{href:url, target:'_blank', class:'link small'},[url])); box.appendChild(jd); }
  function infoField(lbl, val){ const box = el('div'); box.appendChild(el('label',{html:lbl})); box.appendChild(el('div',{class:'value'},[val])); return box; }
  box.appendChild(g1); box.appendChild(g2); box.appendChild(g3); box.appendChild(g4);
  const actions = el('div',{class:'right', style:'margin-top:10px'});
  const editBtn = el('button',{class:'btn-teal'},['Edit']); editBtn.onclick = ()=>{ modal.close(); openJobModal(j); };
  const closeBtn = el('button',{class:'iconbtn'},['Close']); closeBtn.onclick = ()=> modal.close();
  actions.appendChild(closeBtn); actions.appendChild(editBtn);
  box.appendChild(actions);
  modal.open('Job details', box);
}
function openJobModal(j){
  const isEdit = !!j; const state = j? {...j} : {status:'To apply'};
  const form = el('div');
  const r1 = el('div',{class:'row'});
  r1.appendChild(inputField('Title*','title'));
  const companyOptions = db.companies.map(c=>({label:c.name,value:c.id})).sort((a,b) => a.label.localeCompare(b.label));
  r1.appendChild(selectFieldInit('Company*','companyId', companyOptions));
  const r2 = el('div',{class:'row'});
  r2.appendChild(inputField('Source link','sourceLink'));
  r2.appendChild(selectFieldInit('Status*','status', JOB_STATUSES.map(s=>({label:s,value:s}))));
  const r3 = el('div',{class:'row'});
  r3.appendChild(inputField('Salary','salary'));
  r3.appendChild(inputField('Location','location'));
  const r4 = el('div',{}); r4.appendChild(textField('Notes','notes'));
  function inputField(lbl,key){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n = el('input',{type:'text',value:state[key]||''}); n.oninput=()=> state[key]=n.value; box.appendChild(n); return box; }
  function selectFieldInit(lbl, key, opts){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n = el('select'); opts.forEach(o => n.appendChild(el('option',{value:o.value},[o.label]))); const initial = (state[key]!==undefined && state[key]!==null && state[key]!=='') ? state[key] : (opts[0] ? opts[0].value : ''); n.value = initial; state[key] = initial; n.onchange = () => state[key] = n.value; box.appendChild(n); return box; }
  function textField(lbl,key){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n = el('textarea'); n.value = state[key]||''; n.oninput=()=> state[key]=n.value; box.appendChild(n); return box; }
  form.appendChild(r1); form.appendChild(r2); form.appendChild(r3); form.appendChild(r4);
  const actions = el('div',{class:'right'});
  const saveBtn = el('button',{class:'btn-teal'},[isEdit?'Save':'Add']);
  saveBtn.onclick = ()=>{ if(!state.title || !state.companyId) return alert('Title and Company are required'); if(isEdit){ db.jobs = db.jobs.map(x=> x.id===state.id? {...x, ...state} : x); } else { state.id = uid('job'); db.jobs.unshift(state); } save(); modal.close(); render(); };
  const cancel = el('button',{class:'iconbtn'},['Cancel']); cancel.onclick = ()=> modal.close();
  actions.appendChild(cancel); actions.appendChild(saveBtn); form.appendChild(actions);
  modal.open(isEdit? 'Edit job' : 'Add job', form);
}

/* ---------------- Coffee Chats ---------------- */
function viewChats(){
  const wrap = el('div',{});
const toolbar = el('div',{class:'toolbarRow'});

// Search (left)
let nameFilter = '';
let debounce;
const {wrap: searchWrapChats} = makeSearch('Search by name', v=>{
  nameFilter = v;
  clearTimeout(debounce);
  debounce = setTimeout(()=> syncView(), 120);
});
toolbar.appendChild(searchWrapChats);

// Filters (left, after search) — SAME ROW
let companyFilter = 'All', statusFilter = 'All', typeFilter = window.chatsTypeFilter || 'Job related';
const filtersBar = el('div',{class:'filters-inline'});

// Company
const fCompany = el('div',{class:'field'});
fCompany.appendChild(el('label',{},[icon('filter'),'Company']));
const companies = ['All', ...Array.from(new Set(db.companies.map(c=>c.name)))];
const coSel = el('select',{class:'small-select'});
companies.forEach(v=> coSel.appendChild(el('option',{value:v},[v])));
coSel.onchange=()=>{ companyFilter=coSel.value; syncView(); };
fCompany.appendChild(coSel);
filtersBar.appendChild(fCompany);

// Status
const fStatus = el('div',{class:'field'});
fStatus.appendChild(el('label',{},[icon('filter'),'Status']));
const statuses = ['All','To contact','Contacted','Scheduled','Done','Warm referral given'];
const stSel = el('select',{class:'small-select'});
statuses.forEach(v=> stSel.appendChild(el('option',{value:v},[v])));
stSel.onchange=()=>{ statusFilter=stSel.value; syncView(); };
fStatus.appendChild(stSel);
filtersBar.appendChild(fStatus);

// Type
const fType = el('div',{class:'field'});
fType.appendChild(el('label',{},[icon('filter'),'Type']));
const types = ['All','Job related','Entrepreneurship'];
const tySel = el('select',{class:'small-select'});
types.forEach(v=> tySel.appendChild(el('option',{value:v},[v])));
tySel.value = typeFilter;
tySel.onchange=()=>{ typeFilter=tySel.value; window.chatsTypeFilter = typeFilter; syncView(); };
fType.appendChild(tySel);
filtersBar.appendChild(fType);

// add the filters bar to the toolbar row
toolbar.appendChild(filtersBar);

// Right cluster: view icons + Add
const rightChats = el('div',{class:'toolbarRight'});
let view = window.chatsView || 'funnel';
const viewSwitch = makeViewSwitch(view, (val)=>{ view = val; window.chatsView = val; syncView(); });
rightChats.appendChild(viewSwitch);

const add = el('button',{class:'btn-teal'},['+ Add coffee chat']);
add.onclick = ()=> openChatModal();
rightChats.appendChild(add);

toolbar.appendChild(rightChats);
wrap.appendChild(toolbar);

  const content = el('div'); wrap.appendChild(content);
  function syncView(){
    content.innerHTML = '';
    content.appendChild(view === 'funnel' ? funnelView() : tableView());
  }
  syncView(); return wrap;

  function companyNameForChat(ch){
    const contact = db.contacts.find(c=>c.id===ch.contactId);
    const coFromContact = contact ? db.companies.find(c=>c.id===contact.companyId) : null;
    if(coFromContact) return coFromContact.name;
    const co = db.companies.find(c=>c.id===ch.companyId);
    return co? co.name : '';
  }
  function applyFilters(list){
    let L = list.slice();
    if(nameFilter.trim()){ const q = nameFilter.trim().toLowerCase(); L = L.filter(ch=> (db.contacts.find(c=>c.id===ch.contactId)?.name || '').toLowerCase().includes(q)); }
    if(companyFilter!=='All'){ L = L.filter(ch=> companyNameForChat(ch) === companyFilter); }
    if(statusFilter!=='All'){ L = L.filter(ch=> ch.status === statusFilter); }
    if(typeFilter!=='All'){ L = L.filter(ch=> { const chatType = ch.chatType || (ch.jobId ? 'job' : 'entrepreneurship'); return typeFilter === 'Job related' ? chatType === 'job' : chatType === 'entrepreneurship'; }); }
    return L;
  }
  function funnelView(){
    window.DND = window.DND || {id:null,type:null};
    const stages = ["To contact","Contacted","Scheduled","Done","Warm referral given"];
    const board = el('div',{class:'kanban'});
    stages.forEach(st=>{
      const col = el('div',{class:'kan-col card'});
      const h = el('div',{class:'colhead'},[st]);
      const body = el('div',{class:'card-body dropzone', 'data-stage':st});
      body.ondragover = e=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; body.classList.add('drop-over'); };
      body.ondragleave = ()=> body.classList.remove('drop-over');
      body.ondrop = e=>{ e.preventDefault(); body.classList.remove('drop-over'); const id = (e.dataTransfer && e.dataTransfer.getData('text/plain')) || window.DND?.id; if(!id || (window.DND?.type && window.DND.type!=='chat')) return; const ch = db.chats.find(x=>x.id===id); if(!ch){ console.warn('Drop: chat not found', id); return; } ch.status = st; save(); syncView(); window.DND.id=null; window.DND.type=null; };
      col.ondragover = e=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; body.classList.add('drop-over'); };
      col.ondrop = (e)=>{ e.preventDefault(); body.classList.remove('drop-over'); const id = (e.dataTransfer && e.dataTransfer.getData('text/plain')) || window.DND?.id; if(!id || (window.DND?.type && window.DND.type!=='chat')) return; const ch = db.chats.find(x=>x.id===id); if(!ch){ console.warn('Drop: chat not found', id); return; } ch.status = st; save(); syncView(); window.DND.id=null; window.DND.type=null; };
      applyFilters(db.chats).filter(ch=>ch.status===st).forEach(ch=>{
        const card = el('div',{class:'kan-card', draggable:'true'}); card.dataset.id = ch.id;
        card.addEventListener('dragstart', e=>{ window.DND={id:ch.id,type:'chat'}; e.dataTransfer.effectAllowed='move'; try{ e.dataTransfer.setData('text/plain', ch.id); }catch(_){} });
        card.addEventListener('click', (e)=>{ if(e.target.closest('button,a')) return; openChatDetails(ch); });
        const act = el('div',{class:'card-actions'});
        const bEdit = el('button',{class:'iconbtn',title:'Edit', draggable:'false'},[icon('edit')]); bEdit.onmousedown = e=> e.stopPropagation(); bEdit.onclick = e=>{ e.stopPropagation(); openChatModal(ch); };
        const bAction = el('button',{class:'iconbtn',title:'New Action', draggable:'false'},[icon('plus')]); bAction.onmousedown = e=> e.stopPropagation(); bAction.onclick = e=>{ e.stopPropagation(); openActionCreateModal({ relatedType: 'Coffee chat', relatedId: ch.id }); };
        const bDel = el('button',{class:'iconbtn',title:'Delete', draggable:'false'},[icon('close')]); bDel.onmousedown = e=> e.stopPropagation(); bDel.onclick = e=>{ e.stopPropagation(); confirmModal('Delete coffee chat',`Delete chat with "${(db.contacts.find(c=>c.id===ch.contactId)||{}).name||'contact'}"?`,()=>{ db.chats = db.chats.filter(x=>x.id!==ch.id); save(); syncView(); }); };
        act.appendChild(bAction); act.appendChild(bEdit); act.appendChild(bDel); card.appendChild(act);
        const ct = db.contacts.find(c=>c.id===ch.contactId); const coName = companyNameForChat(ch) || 'No company';
        card.appendChild(el('div',{style:'font-weight:700;color:var(--navy);padding-right:60px'},[ct?ct.name:'Unknown']));
        card.appendChild(el('div',{class:'muted'},[coName]));
        if(ch.dateScheduled){
          card.appendChild(el('div',{class:'muted'},['📅 ', fmtDate(ch.dateScheduled)]));
        }
        body.appendChild(card);
      });
      col.appendChild(h); col.appendChild(body); board.appendChild(col);
    });
    return board;
  }
  function tableView(){
    let sortKey = null, sortDir = 'ascending';
    const tbl = el('table');
    const thead = el('thead'); const trh = el('tr');
    const cols = [
      {key:'contact', label:'Contact', sortable:true},
      {key:'company', label:'Company', sortable:true},
      {key:'job', label:'Job', sortable:true},
      {key:'status', label:'Status', sortable:true},
      {key:'channel', label:'Channel', sortable:true},
      {key:'scheduled', label:'Scheduled', sortable:true},
      {key:'type', label:'Type', sortable:true},
      {key:'notes', label:'Notes', sortable:false},
      {key:'_actions', label:'Actions', sortable:false},
    ];
    cols.forEach(c=>{ const th = el('th',{},[c.label, el('span',{class:'sort-ind'})]); if(c.sortable){ th.classList.add('sortable'); th.setAttribute('aria-sort','none'); th.onclick = ()=>{ if(sortKey !== c.key){ sortKey = c.key; sortDir = 'ascending'; } else { sortDir = (sortDir==='ascending' ? 'descending' : 'ascending'); } updateHeaderSorts(); drawBody(); }; } trh.appendChild(th); });
    thead.appendChild(trh);
    const tbody = el('tbody'); tbl.appendChild(thead); tbl.appendChild(tbody);
    function updateHeaderSorts(){ const ths = thead.querySelectorAll('th'); ths.forEach((th,i)=>{ const col = cols[i]; if(!col.sortable){ th.removeAttribute('aria-sort'); return; } if(col.key === sortKey){ th.setAttribute('aria-sort', sortDir); } else { th.setAttribute('aria-sort','none'); } }); }
    function applyFilters(list){ let L = list.slice(); if(nameFilter.trim()){ const q = nameFilter.trim().toLowerCase(); L = L.filter(ch=> (db.contacts.find(c=>c.id===ch.contactId)?.name || '').toLowerCase().includes(q)); } if(companyFilter!=='All'){ L = L.filter(ch=> (function(){ const contact = db.contacts.find(c=>c.id===ch.contactId); const co = contact ? db.companies.find(c=>c.id===contact.companyId) : null; return (co?co.name:''); })() === companyFilter); } if(statusFilter!=='All'){ L = L.filter(ch=> ch.status === statusFilter); } if(typeFilter!=='All'){ L = L.filter(ch=> { const chatType = ch.chatType || (ch.jobId ? 'job' : 'entrepreneurship'); return typeFilter === 'Job related' ? chatType === 'job' : chatType === 'entrepreneurship'; }); } return L; }
    function applyAll(list){ let L = applyFilters(list); if(!sortKey) return L; return L.slice().sort((a,b)=>{ const get = (ch,k)=>{ if(k==='contact') return (db.contacts.find(c=>c.id===ch.contactId)?.name||'').toLowerCase(); if(k==='company'){ const contact = db.contacts.find(c=>c.id===ch.contactId); const co = contact ? db.companies.find(c=>c.id===contact.companyId) : null; return (co?co.name:'').toLowerCase(); } if(k==='job') return (db.jobs.find(j=>j.id===ch.jobId)?.title||'').toLowerCase(); if(k==='status') return (ch.status||'').toLowerCase(); if(k==='channel') return (ch.channel||'').toLowerCase(); if(k==='scheduled') return (ch.dateScheduled||'').toLowerCase(); if(k==='type'){ const chatType = ch.chatType || (ch.jobId ? 'job' : 'entrepreneurship'); return (chatType === 'job' ? 'job related' : 'entrepreneurship').toLowerCase(); } if(k==='notes') return (ch.notes||'').toLowerCase(); return ''; }; const av = get(a,sortKey), bv = get(b,sortKey); if(av < bv) return sortDir==='ascending' ? -1 : 1; if(av > bv) return sortDir==='ascending' ? 1 : -1; return 0; }); }
    function drawBody(){ tbody.innerHTML=''; applyAll(db.chats).forEach(ch=>{ const contact = db.contacts.find(c=>c.id===ch.contactId); const job = db.jobs.find(j=>j.id===ch.jobId); const company = (function(){ const coFromContact = contact ? db.companies.find(c=>c.id===contact.companyId) : null; return coFromContact ? coFromContact.name : (db.companies.find(c=>c.id===ch.companyId)?.name || ''); })(); const chatType = ch.chatType || (ch.jobId ? 'job' : 'entrepreneurship'); const typeDisplay = chatType === 'job' ? 'Job related' : 'Entrepreneurship'; const tr = el('tr'); tr.appendChild(el('td',{},[ contact? contact.name : '—' ])); tr.appendChild(el('td',{},[ company || '—' ])); tr.appendChild(el('td',{},[ job? job.title : '—' ])); tr.appendChild(el('td',{},[ ch.status || '—' ])); tr.appendChild(el('td',{},[ ch.channel==='other'? (ch.channelOther||'Other') : (ch.channel||'—') ])); tr.appendChild(el('td',{},[ ch.dateScheduled ? fmtDate(ch.dateScheduled) : '—' ])); tr.appendChild(el('td',{},[ typeDisplay ]));
    tr.appendChild(el('td',{},[ ch.notes? (ch.notes.slice(0,40)+(ch.notes.length>40?'…':'')) : '—' ])); 
    const act = el('td');
    const dropdown = makeActionDropdown(
      () => openChatModal(ch), // Edit action
      () => confirmModal('Delete coffee chat','Delete this coffee chat?',()=>{ // Delete action
        db.chats = db.chats.filter(x=>x.id!==ch.id); 
        save(); render(); 
      }),
      { relatedType: 'Coffee chat', relatedId: ch.id } // New Action data
    );
    act.appendChild(dropdown); tr.appendChild(act); tr.addEventListener('click', (ev)=>{ if(ev.target.closest('button,a')) return; openChatDetails(ch); }); tbody.appendChild(tr); }); }
    drawBody(); updateHeaderSorts(); return tbl;
  }
}
function openChatDetails(ch){
  const box = el('div'); const contact = db.contacts.find(c=>c.id===ch.contactId); const job = db.jobs.find(j=>j.id===ch.jobId);
  const company = (function(){ const coFromContact = contact ? db.companies.find(c=>c.id===contact.companyId) : null; return coFromContact ? coFromContact.name : (db.companies.find(c=>c.id===ch.companyId)?.name || '—'); })();
  const g1 = el('div',{class:'row'}); g1.appendChild(infoField('Contact', contact? contact.name : '—')); g1.appendChild(infoField('Company', company));
  const g2 = el('div',{class:'row'}); g2.appendChild(infoField('Job', job? job.title : '—')); g2.appendChild(infoField('Status', ch.status || '—'));
  const g3 = el('div',{class:'row'}); g3.appendChild(infoField('Channel', ch.channel==='other'? (ch.channelOther||'Other') : (ch.channel||'—'))); g3.appendChild(infoField('Scheduled', ch.dateScheduled || '—'));
  const g4 = el('div',{}); g4.appendChild(infoField('Notes', ch.notes || '—'));
  function infoField(lbl, val){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const v = el('div',{class:'value'}); if(typeof val==='string') v.textContent=val; else v.appendChild(val); box.appendChild(v); return box; }
  box.appendChild(g1); box.appendChild(g2); box.appendChild(g3); box.appendChild(g4);
  const actions = el('div',{class:'right', style:'margin-top:10px'}); const editBtn = el('button',{class:'btn-teal'},['Edit']); editBtn.onclick = ()=>{ modal.close(); openChatModal(ch); }; const closeBtn = el('button',{class:'iconbtn'},['Close']); closeBtn.onclick = ()=> modal.close(); actions.appendChild(closeBtn); actions.appendChild(editBtn); box.appendChild(actions); modal.open('Coffee chat details', box);
}
function openChatModal(ch){
  const isEdit = !!ch; 
  const state = ch? {...ch} : {status:'To contact', channel:'email', chatType: 'job'};
  
  // Initialize chatType if not set - default to 'job'
  if (!state.chatType) {
    state.chatType = 'job'; // Always default to job search
  }
  
  const form = el('div');
  
  // Create toggle switch (top right of form)
  const formHeader = el('div', {
    style: 'display:flex;justify-content:space-between;align-items:center;margin-bottom:16px'
  });
  
  const spacer = el('div'); // Empty spacer for left side
  
  const toggleContainer = el('div', {
    style: 'display:flex;align-items:center;gap:12px;font-size:14px;color:#374151;font-weight:500'
  });
  
  const toggleLabel = el('span', {}, ['Job']); // Dynamic label
  
  const toggleSwitch = el('div', {
    style: 'position:relative;width:48px;height:24px;background:#007F7F;border-radius:12px;cursor:pointer;transition:all 0.3s;box-shadow:inset 0 2px 4px rgba(0,0,0,0.1)'
  });
  
  const toggleSlider = el('div', {
    style: 'position:absolute;top:2px;left:2px;width:20px;height:20px;background:#ffffff;border-radius:50%;transition:all 0.3s;transform:translateX(0px);box-shadow:0 2px 4px rgba(0,0,0,0.2)'
  });
  
  toggleSwitch.appendChild(toggleSlider);
  
  toggleContainer.appendChild(toggleLabel);
  toggleContainer.appendChild(toggleSwitch);
  
  formHeader.appendChild(spacer);
  formHeader.appendChild(toggleContainer);
  form.appendChild(formHeader);
  
  // Toggle functionality
  function updateTogglePosition() {
    if (state.chatType === 'job') {
      // ON state - Job (left position, teal background)
      toggleSlider.style.transform = 'translateX(0px)';
      toggleSwitch.style.background = '#007F7F'; // Same as btn-teal
      toggleLabel.textContent = 'Job';
    } else {
      // OFF state - Entrepreneurship (right position, gray background)
      toggleSlider.style.transform = 'translateX(24px)';
      toggleSwitch.style.background = '#9ca3af'; // Gray
      toggleLabel.textContent = 'Entrepreneurship';
    }
  }
  
  toggleSwitch.onclick = () => {
    if (state.chatType === 'job') {
      state.chatType = 'entrepreneurship';
      state.jobId = '';
    } else {
      state.chatType = 'job';
      state.ideaId = '';
    }
    updateTogglePosition();
    updateRelatedField();
  };
  
  // Set initial position
  updateTogglePosition();
  
  const r1 = el('div',{class:'row'});
  r1.appendChild(selectField('Contact*','contactId', db.contacts.map(c=>({label:c.name,value:c.id})).sort((a,b) => a.label.localeCompare(b.label))));
  
  // Related field (Job or Idea)
  const relatedFieldContainer = el('div');
  r1.appendChild(relatedFieldContainer);
  
  function updateRelatedField() {
    relatedFieldContainer.innerHTML = '';
    if (state.chatType === 'job') {
      // Create job select with custom onChange to update company
      const jobBox = el('div');
      jobBox.appendChild(el('label',{html:'Job'}));
      const jobSelect = el('select');
      jobSelect.appendChild(el('option',{value:''},['—']));
      db.jobs.map(j=>({label:j.title,value:j.id})).sort((a,b) => a.label.localeCompare(b.label)).forEach(o=> jobSelect.appendChild(el('option',{value:o.value},[o.label])));
      jobSelect.value = state.jobId||'';
      jobSelect.onchange = () => {
        state.jobId = jobSelect.value;
        // Update company when job changes
        if (state.jobId) {
          const selectedJob = db.jobs.find(j => j.id === state.jobId);
          if (selectedJob && selectedJob.companyId) {
            state.companyId = selectedJob.companyId;
          }
        } else {
          state.companyId = '';
        }
      };
      jobBox.appendChild(jobSelect);
      relatedFieldContainer.appendChild(jobBox);
    } else {
      relatedFieldContainer.appendChild(selectField('Idea','ideaId', (db.ideas||[]).map(i=>({label:i.name||'Untitled',value:i.id})).sort((a,b) => a.label.localeCompare(b.label))));
    }
    
    // Update toggle position
    updateTogglePosition();
  }
  
  updateRelatedField();
  
  const r2 = el('div',{class:'row'});
  r2.appendChild(selectField('Status','status',["To contact","Contacted","Scheduled","Done","Warm referral given"].map(s=>({label:s,value:s}))));
  r2.appendChild(selectField('Channel','channel',[{label:'email',value:'email'},{label:'LinkedIn',value:'LinkedIn'},{label:'intro',value:'intro'},{label:'event',value:'event'},{label:'other',value:'other'}]));
  const r3 = el('div',{class:'row'});
  r3.appendChild(inputField('Scheduled','dateScheduled','date'));
  r3.appendChild(inputField('Channel (if other)','channelOther'));
  const r4 = el('div',{}); r4.appendChild(textField('Notes','notes'));
  function inputField(lbl,key,type='text'){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n = el('input',{type, value:state[key]||''}); n.oninput=()=> state[key]=n.value; box.appendChild(n); return box; }
  function selectField(lbl,key,opts){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n = el('select'); n.appendChild(el('option',{value:''},['—'])); opts.forEach(o=> n.appendChild(el('option',{value:o.value},[o.label]))); n.value = state[key]||''; n.onchange=()=> state[key]=n.value; box.appendChild(n); return box; }
  function textField(lbl,key){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n = el('textarea'); n.value = state[key]||''; n.oninput=()=> state[key]=n.value; box.appendChild(n); return box; }
  form.appendChild(r1); form.appendChild(r2); form.appendChild(r3); form.appendChild(r4);
  const actions = el('div',{class:'right'});
  const saveBtn = el('button',{class:'btn-teal'},[isEdit?'Save':'Add']);
  saveBtn.onclick = ()=>{ if(!state.contactId) return alert('Contact is required'); if(isEdit){ db.chats = db.chats.map(x=> x.id===state.id? {...x, ...state} : x); } else { state.id = uid('chat'); db.chats.unshift(state); } save(); modal.close(); render(); };
  const cancel = el('button',{class:'iconbtn'},['Cancel']); cancel.onclick = ()=> modal.close();
  actions.appendChild(cancel); actions.appendChild(saveBtn); form.appendChild(actions);
  
  modal.open(isEdit? 'Edit coffee chat' : 'Add coffee chat', form);
}

/* ---------------- Contacts ---------------- */
function viewContacts(){
  const wrap = el('div',{});
  let nameFilter = '';
  let companyFilter = 'All';
  let roleFilter = 'All';

  /* === Contacts: unified toolbarRow + inline filters === */
const toolbar = el('div',{class:'toolbarRow'});

// Search at left
let debounce;
const {wrap: searchWrapContacts} = makeSearch('Search by name', v=>{
  nameFilter = v;
  clearTimeout(debounce);
  debounce = setTimeout(()=> tableRefresh(), 120);
});

const leftCt = el('div',{class:'toolbarLeft'});
leftCt.appendChild(searchWrapContacts);

// Inline filters (Company + Role)
const filtersBar = el('div',{class:'filters-inline'});

// Company
const fCompany = el('div',{class:'field'});
fCompany.appendChild(el('label',{},[icon('filter'),'Company']));
const companies = ['All', ...Array.from(new Set(db.companies.map(c=>c.name)))]
const coSel = el('select',{class:'small-select'});
companies.forEach(v=> coSel.appendChild(el('option',{value:v},[v])));
coSel.onchange = ()=>{ companyFilter=coSel.value; tableRefresh(); };
fCompany.appendChild(coSel);
filtersBar.appendChild(fCompany);

// Role
const fRole = el('div',{class:'field'});
fRole.appendChild(el('label',{},[icon('filter'),'Role']));
const roles = ['All', ...Array.from(new Set(db.contacts.map(c=>c.role).filter(Boolean)))]
const rSel = el('select',{class:'small-select'});
roles.forEach(v=> rSel.appendChild(el('option',{value:v},[v])));
rSel.onchange = ()=>{ roleFilter=rSel.value; tableRefresh(); };
fRole.appendChild(rSel);
filtersBar.appendChild(fRole);

leftCt.appendChild(filtersBar);

toolbar.appendChild(leftCt);

// Right: Add
const rightContacts = el('div',{class:'toolbarRight'});
const add = el('button',{class:'btn-teal'},['+ Add contact']);
add.onclick = ()=> openContactModal();
rightContacts.appendChild(add);

toolbar.appendChild(rightContacts);
wrap.appendChild(toolbar);

// extra spacing before table
wrap.appendChild(el('div',{style:'height:12px'}));

  // Sortable & clickable table
  let sortKey=null, sortDir='ascending';
  const table = el('table'); const thead = el('thead'); const trh = el('tr');
  const cols = [
    {key:'name', label:'Name', sortable:true},
    {key:'role', label:'Role', sortable:true},
    {key:'company', label:'Company', sortable:true},
    {key:'relationship', label:'Relationship', sortable:true},
    {key:'email', label:'Email', sortable:true},
    {key:'linkedin', label:'LinkedIn', sortable:false},
    {key:'_actions', label:'Actions', sortable:false},
  ];
  cols.forEach(c=>{ const th = el('th',{},[c.label, el('span',{class:'sort-ind'})]); if(c.sortable){ th.classList.add('sortable'); th.setAttribute('aria-sort','none'); th.onclick = ()=>{ if(sortKey!==c.key){sortKey=c.key;sortDir='ascending';}else{sortDir=(sortDir==='ascending'?'descending':'ascending');} updateHeaderSorts(); tableRefresh(); }; } trh.appendChild(th); });
  thead.appendChild(trh);
  const tbody = el('tbody'); table.appendChild(thead); table.appendChild(tbody);
  function updateHeaderSorts(){ const ths = thead.querySelectorAll('th'); ths.forEach((th,i)=>{ const col = cols[i]; if(!col.sortable){ th.removeAttribute('aria-sort'); return; } if(col.key === sortKey){ th.setAttribute('aria-sort', sortDir); } else { th.setAttribute('aria-sort','none'); } }); }
  function tableRefresh(){
    tbody.innerHTML='';
    let list = db.contacts.slice();
    if(nameFilter.trim()){ const q = nameFilter.trim().toLowerCase(); list = list.filter(c=> (c.name||'').toLowerCase().includes(q)); }
    if(companyFilter!=='All'){ const co = db.companies.find(c=>c.name===companyFilter); list = list.filter(ct=> ct.companyId=== (co?co.id:null)); }
    if(roleFilter!=='All'){ list = list.filter(ct=> (ct.role||'')===roleFilter); }
    if(sortKey){
      list.sort((a,b)=>{
        const get = (ct)=>{ if(sortKey==='name') return (ct.name||'').toLowerCase(); if(sortKey==='role') return ((ct.role||'')+' '+(ct.department||'')).toLowerCase(); if(sortKey==='company'){ const co = db.companies.find(c=>c.id===ct.companyId); return (co?co.name:'').toLowerCase(); } if(sortKey==='relationship') return (ct.relStrength||'').toLowerCase(); if(sortKey==='email') return (ct.email||'').toLowerCase(); return ''; };
        const av = get(a), bv=get(b); if(av < bv) return sortDir==='ascending' ? -1 : 1; if(av > bv) return sortDir==='ascending' ? 1 : -1; return 0;
      });
    }
    list.forEach(ct=>{
      const tr = el('tr');
      tr.appendChild(el('td',{},[ct.name]));
      tr.appendChild(el('td',{},[ (ct.role||'') + (ct.department? ' • '+ct.department : '') ]));
      tr.appendChild(el('td',{},[ (db.companies.find(c=>c.id===ct.companyId)||{}).name || '—' ]));
      tr.appendChild(el('td',{},[ ct.relStrength ]));
      tr.appendChild(el('td',{},[ ct.email || '—' ]));
      const ltd = el('td'); if(ct.linkedIn){ ltd.appendChild(el('a',{href:normalizeUrl(ct.linkedIn),target:'_blank',class:'link'},['Open'])); } else { ltd.textContent='—'; } tr.appendChild(ltd);
    const act = el('td');
    const dropdown = makeActionDropdown(
      () => openContactModal(ct), // Edit action
      () => confirmModal('Delete contact',`Delete ${ct.name}?`,()=>{ // Delete action
        db.contacts = db.contacts.filter(x=>x.id!==ct.id); 
        db.chats = db.chats.filter(ch=> ch.contactId!==ct.id); 
        save(); render(); 
      })
    );
    act.appendChild(dropdown); tr.appendChild(act);
      tr.addEventListener('click', (ev)=>{ if(ev.target.closest('button,a')) return; openContactDetails(ct); });
      tbody.appendChild(tr);
    });
  }
  wrap.appendChild(table); tableRefresh(); updateHeaderSorts(); return wrap;
}
function openContactDetails(ct){
  const box = el('div');
  const g1 = el('div',{class:'row'});
  g1.appendChild(infoField('Name', ct.name || '—'));
  g1.appendChild(infoField('Company', (db.companies.find(c=>c.id===ct.companyId)?.name)||'—'));
  const g2 = el('div',{class:'row'});
  g2.appendChild(infoField('Role', (ct.role||'') + (ct.department? ' • '+ct.department : '')));
  g2.appendChild(infoField('Relationship', ct.relStrength || '—'));
  const g3 = el('div',{class:'row'});
  g3.appendChild(infoField('Email', ct.email || '—'));
  const lk = ct.linkedIn ? el('a',{href:normalizeUrl(ct.linkedIn),target:'_blank',class:'link'},['Open']) : '—';
  g3.appendChild(infoField('LinkedIn', lk));
  const g4 = el('div',{}); g4.appendChild(infoField('Notes', ct.notes || '—'));
  function infoField(lbl, val){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const v = el('div',{class:'value'}); if(typeof val==='string') v.textContent=val; else v.appendChild(val); box.appendChild(v); return box; }
  box.appendChild(g1); box.appendChild(g2); box.appendChild(g3); box.appendChild(g4);
  const actions = el('div',{class:'right', style:'margin-top:10px'});
  const editBtn = el('button',{class:'btn-teal'},['Edit']); editBtn.onclick = ()=>{ modal.close(); openContactModal(ct); };
  const closeBtn = el('button',{class:'iconbtn'},['Close']); closeBtn.onclick = ()=> modal.close();
  actions.appendChild(closeBtn); actions.appendChild(editBtn);
  box.appendChild(actions);
  modal.open('Contact details', box);
}
function openContactModal(ct){
  const isEdit = !!ct; const state = ct? {...ct} : {relStrength:'Cold'};
  const form = el('div');
  const r1 = el('div',{class:'row'});
  r1.appendChild(inputField('Name*','name'));
  r1.appendChild(selectField('Company','companyId', db.companies.map(c=>({label:c.name,value:c.id})).sort((a,b) => a.label.localeCompare(b.label))));
  const r2 = el('div',{class:'row'});
  r2.appendChild(inputField('Role','role'));
  r2.appendChild(inputField('Department','department'));
  const r3 = el('div',{class:'row'});
  r3.appendChild(inputField('Email','email'));
  r3.appendChild(inputField('LinkedIn','linkedIn'));
  const r4 = el('div',{class:'row'});
  r4.appendChild(selectField('Relationship','relStrength',[{label:'Cold',value:'Cold'},{label:'Warm',value:'Warm'},{label:'Strong',value:'Strong'}]));
  r4.appendChild(inputField('How we met','howWeMet'));
  const r5 = el('div',{});
  r5.appendChild(textField('Notes','notes'));
  function inputField(lbl,key,type='text'){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n = el('input',{type, value:state[key]||''}); n.oninput=()=> state[key]=n.value; box.appendChild(n); return box; }
  function selectField(lbl,key,opts){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n = el('select'); n.appendChild(el('option',{value:''},['—'])); opts.forEach(o=> n.appendChild(el('option',{value:o.value},[o.label]))); n.value = state[key]||''; n.onchange=()=> state[key]=n.value; box.appendChild(n); return box; }
  function textField(lbl,key){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n = el('textarea'); n.value = state[key]||''; n.oninput=()=> state[key]=n.value; box.appendChild(n); return box; }
  form.appendChild(r1); form.appendChild(r2); form.appendChild(r3); form.appendChild(r4); form.appendChild(r5);
  const actions = el('div',{class:'right'});
  const saveBtn = el('button',{class:'btn-teal'},[isEdit?'Save':'Add']);
  saveBtn.onclick = ()=>{ if(!state.name) return alert('Name is required'); if(isEdit){ const i = db.contacts.findIndex(x=>x.id===state.id); db.contacts[i] = {...db.contacts[i], ...state}; }
  else { state.id = uid('ctc'); db.contacts.unshift(state); }
  save(); modal.close(); render(); };
  const cancel = el('button',{class:'iconbtn'},['Cancel']); cancel.onclick = ()=> modal.close();
  actions.appendChild(cancel); actions.appendChild(saveBtn); form.appendChild(actions);
  modal.open(isEdit? 'Edit contact' : 'Add contact', form);
}
/* ===== Next Actions modals (create/edit/expand/subtask) ===== */

// Removed old openActionCreateModal - using newer version with parameters support
  
  function openActionEditModal(a){
    const isEdit = !!a;
    const state = a ? {...a} : {
      id: uid('act'),
      title: '',
      relatedType: 'Company',
      relatedId: '',
      description: '',
      createdAt: new Date().toISOString(),
      subactions: []
    };
  
    const form = el('div');
  
    // Title
    const r1 = el('div',{class:'row'});
    r1.appendChild(inputField('Title*','title'));
    form.appendChild(r1);
  
    // Related to (type + picker)
    const r2 = el('div',{class:'row'});
    const typeBox = el('div');
    typeBox.appendChild(el('label',{html:'Related to'}));
    const typeSel = el('select');
    ['Other','Company','Job','Coffee chat','Entrepreneurship'].forEach(v=> typeSel.appendChild(el('option',{value:v},[v])));
    typeSel.value = state.relatedType || 'Company';
    typeSel.onchange = ()=>{ state.relatedType = typeSel.value; buildRelPicker(); };
    typeBox.appendChild(typeSel);
    r2.appendChild(typeBox);
  
    const relBox = el('div');
    relBox.appendChild(el('label',{html:'Pick related item'}));
    const relHolder = el('div'); relBox.appendChild(relHolder);
    r2.appendChild(relBox);
    form.appendChild(r2);
  
    // Description
    const r3 = el('div',{}); r3.appendChild(textField('Description','description')); form.appendChild(r3);
    
    // Subtasks section (only for editing existing actions)
    if(isEdit && state.subactions && state.subactions.length > 0) {
      const subtasksSection = el('div',{class:'subtasks-edit-section'});
      subtasksSection.appendChild(el('h3',{style:'margin:16px 0 8px;font-size:14px;color:#374151;font-weight:600'},['Subtasks']));
      
      state.subactions.forEach((subtask, index) => {
        const subtaskRow = el('div',{class:'subtask-edit-row'});
        
        // Title field
        const titleField = el('div',{class:'subtask-field'});
        titleField.appendChild(el('label',{html:'Title'}));
        const titleInput = el('input',{type:'text',value:subtask.title||''});
        titleInput.oninput = ()=> state.subactions[index].title = titleInput.value;
        titleField.appendChild(titleInput);
        subtaskRow.appendChild(titleField);
        
        // Date field
        const dateField = el('div',{class:'subtask-field'});
        dateField.appendChild(el('label',{html:'Due Date'}));
        const dateInput = el('input',{type:'date',value:subtask.due||''});
        dateInput.oninput = ()=> state.subactions[index].due = dateInput.value;
        dateField.appendChild(dateInput);
        subtaskRow.appendChild(dateField);
        
        // Notes field
        const notesField = el('div',{class:'subtask-field-full'});
        notesField.appendChild(el('label',{html:'Notes'}));
        const notesInput = el('textarea',{style:'min-height:60px'});
        notesInput.value = subtask.notes||'';
        notesInput.oninput = ()=> state.subactions[index].notes = notesInput.value;
        notesField.appendChild(notesInput);
        subtaskRow.appendChild(notesField);
        
        subtasksSection.appendChild(subtaskRow);
      });
      
      form.appendChild(subtasksSection);
    }
  
    // Actions
    const actions = el('div',{class:'right'});
    const saveBtn = el('button',{class:'btn-teal'},[isEdit?'Save':'Add']);
    const cancelBtn = el('button',{class:'iconbtn'},['Cancel']);
    cancelBtn.onclick = ()=> modal.close();
    saveBtn.onclick = ()=>{
      if(!state.title.trim()) return alert('Title is required');
      
      console.log('💾 Dashboard 360: Saving action...', { id: state.id, title: state.title, description: state.description });
      
      if(isEdit){
        const beforeAction = db.actions.find(x => x.id === state.id);
        console.log('💾 Before save:', beforeAction);
        db.actions = db.actions.map(x => x.id===state.id ? {...x, ...state} : x);
        const afterAction = db.actions.find(x => x.id === state.id);
        console.log('💾 After save:', afterAction);
      }else{
        db.actions.unshift(state);
      }
      save(); 
      
      // Update the visible card immediately if it's on screen
      try{
        const updated = db.actions.find(x => x.id === state.id) || state;
        const ok = d360UpdateActionCardInDOM(updated);
        console.log('🔁 Inline card update after save:', ok);
      }catch(_){ }
      
      modal.close(); 
      
      // Use appropriate refresh function based on current module
      if (currentTab === 'ideas') {
        // Store scroll position and open idea cards
        const scrollPosition = window.scrollY;
        const openIdeaIds = [];
        document.querySelectorAll('.idea.open').forEach(idea => {
          openIdeaIds.push(idea.getAttribute('data-idea-id'));
        });
        
        renderIdeas();
        
        // Restore scroll position and open idea cards
        setTimeout(() => {
          window.scrollTo(0, scrollPosition);
          openIdeaIds.forEach(ideaId => {
            const ideaCard = document.querySelector(`[data-idea-id="${ideaId}"]`);
            if (ideaCard) {
              ideaCard.classList.add('open');
              const detailsBtn = ideaCard.querySelector('.details-btn');
              if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
            }
          });
        }, 10);
      } else if (typeof window.d360RefreshActionsForCompanyId === 'function') {
        // Prefer refreshing the exact company's actions section this action belongs to
        setTimeout(() => {
          const companyId = d360GetCompanyIdForActionId(state.id);
          console.log('🔄 Dashboard 360: Precise refresh for company of action:', companyId);
          const ok = companyId && window.d360RefreshActionsForCompanyId(companyId);
          if (!ok && typeof window.dash360RefreshNow === 'function') {
            // Fallback to generic refresh
            window.dash360RefreshNow();
          }
        }, 150);
      } else if (currentTab === 'actions') {
        // Check if calendar is currently visible in Next Actions
        const calendarContainer = document.querySelector('.calendar-container');
        if (calendarContainer && calendarContainer.style.display !== 'none') {
          refreshCalendar();
        } else {
          render();
        }
      } else if (currentView === 'calendar') {
        refreshCalendar();
      } else {
        render();
      }
    };
    actions.appendChild(cancelBtn); actions.appendChild(saveBtn);
    form.appendChild(actions);
  
    // helpers
    function inputField(lbl,key){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n=el('input',{type:'text',value:state[key]||''}); n.oninput=()=> state[key]=n.value; box.appendChild(n); return box; }
    function textField(lbl,key){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n=el('textarea'); n.value=state[key]||''; n.oninput=()=> state[key]=n.value; box.appendChild(n); return box; }
  
    function buildRelPicker(){
      relHolder.innerHTML='';
      if(state.relatedType==='Other'){ state.relatedId=''; relHolder.appendChild(el('div',{},['—'])); return; }
      const sel = el('select');
      let opts = [];
      if(state.relatedType==='Company'){ opts = db.companies.map(c=>({label:c.name, value:c.id})).sort((a,b) => a.label.localeCompare(b.label)); }
      if(state.relatedType==='Job'){ opts = db.jobs.map(j=>({label:j.title + (db.companies.find(c=>c.id===j.companyId)? ` — ${db.companies.find(c=>c.id===j.companyId).name}`:''), value:j.id})).sort((a,b) => a.label.localeCompare(b.label)); }
      if(state.relatedType==='Coffee chat'){
        opts = db.chats.map(ch=>{
          const ct = db.contacts.find(c=>c.id===ch.contactId);
          const co = ct ? db.companies.find(c=>c.id===ct.companyId) : null;
          const label = (ct?ct.name:'Unknown') + (co? ` — ${co.name}`:'');
          return {label, value:ch.id};
        }).sort((a,b) => a.label.localeCompare(b.label));
      }
      if(state.relatedType==='Entrepreneurship'){ 
        opts = (db.ideas||[]).map(idea=>({label:idea.name||'Untitled', value:idea.id})).sort((a,b) => a.label.localeCompare(b.label)); 
      }
      if(!opts.length){ relHolder.appendChild(el('div',{},['No items found'])); state.relatedId=''; return; }
      opts.forEach(o=> sel.appendChild(el('option',{value:o.value},[o.label])));
      sel.value = state.relatedId || opts[0].value;
      state.relatedId = sel.value;
      sel.onchange = ()=> state.relatedId = sel.value;
      relHolder.appendChild(sel);
    }
  
    buildRelPicker();
    modal.open(isEdit? 'Edit action' : 'Add action', form);
  }
  function openActionExpandModal(a){
    const todayStr = ()=> { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; };
    function computeStatus(act){
      const total = act.subactions?.length || 0;
      const done = (act.subactions||[]).filter(s=>!!s.done).length;
      const status = total>0 && done===total ? 'Done' : done>0 ? 'In progress' : 'To do';
      return {status, done, total};
    }
    const hasOverdue = act => (act.subactions||[]).some(s=>!s.done && s.due && s.due < todayStr());
  
    // Build a read-only action card with complete information
    function render(){
      const {status, done, total} = computeStatus(a);
  
      const card = el('div',{class:'action-card na-v16'});
  
      // head - clean layout matching original card
      const head = el('div',{class:'action-head-expanded'});
      
      // Top row: Title (2/3) + Status (1/3)
      const topRow = el('div',{class:'expand-top-row'});
      
      // Title container - 2/3 width
      const titleContainer = el('div',{class:'expand-title-section'});
      const title = el('div',{class:'expand-title'});
      title.textContent = a.title || '';
      titleContainer.appendChild(title);
      topRow.appendChild(titleContainer);
      
      // Status container - 1/3 width, same style as card
      const statusContainer = el('div',{class:'expand-status-section'});
      const statusContent = el('div',{class:'expand-status-content'});
      statusContent.appendChild(el('span',{class:`badge ${status==='Done'?'done':status==='In progress'?'progress':'todo'}`},[status]));
      statusContent.appendChild(el('span',{class:'progress-text'},[`${done} of ${total} completed`]));
      if(hasOverdue(a)) statusContent.appendChild(el('span',{class:'badge overdue'},['Overdue']));
      statusContainer.appendChild(statusContent);
      topRow.appendChild(statusContainer);
      
      head.appendChild(topRow);
      
      // Relation - same style as card
      const relationContainer = el('div',{class:'expand-relation'});
      relationContainer.appendChild(el('div',{class:'relation-line'},[ getRelationText(a) ]));
      head.appendChild(relationContainer);
      
      // Description - full width, complete text
      const fullDesc = (a.description||'').trim();
      if(fullDesc) {
        const descContainer = el('div',{class:'expand-description-section'});
        descContainer.appendChild(el('div',{class:'desc-one'},[
            el('span',{class:'label'},['Description:']),
          el('span',{class:'text'},[fullDesc])
        ]));
        head.appendChild(descContainer);
      }
  
      card.appendChild(head);
  
      // body: subtasks with complete notes
      const body = el('div',{class:'action-body'});
      (a.subactions||[]).forEach(s=>{
        const subtaskContainer = el('div',{class:'subtask-expanded'});
        
        // Main subtask row
        const row = el('div',{class:'sub-row'});
  
        const cb = el('input',{type:'checkbox','aria-label':`Mark "${s.title}" completed`});
        cb.checked = !!s.done;
        cb.disabled = true; // Read-only
        row.appendChild(cb);
  
        const title = el('span',{class:'sub-title'+(s.done?' sub-completed':'')},[s.title||'']);
        row.appendChild(title);
  
        const due = el('span',{class:'due-pill'},[ s.due ? fmtDate(s.due) : '—' ]);
        row.appendChild(due);
  
        const overdue = !s.done && s.due && s.due < todayStr();
        if(overdue){ title.classList.add('sub-overdue'); due.classList.add('sub-overdue'); }
  
        subtaskContainer.appendChild(row);
        
        // Complete notes below each subtask
        const notes = (s.notes||'').trim();
        if(notes) {
          const notesRow = el('div',{class:'subtask-notes'});
          notesRow.appendChild(el('span',{class:'label'},['Notes:']));
          notesRow.appendChild(el('span',{class:'text'},[notes]));
          subtaskContainer.appendChild(notesRow);
        }
        
        body.appendChild(subtaskContainer);
      });
      card.appendChild(body);
  
      // No footer - read-only view
  
      // write into the modal body
      modal.body.innerHTML = '';
      modal.body.appendChild(card);
    }
  
    modal.open('Action — Complete View', el('div')); // open first, then render
    
    // Add data attribute to hide close button
    const modalElement = document.querySelector('.modal');
    if(modalElement) {
      modalElement.setAttribute('data-modal-type', 'expand');
    }
    
    // Add ESC key to close
    const handleEsc = (e) => {
      if(e.key === 'Escape') {
        modal.close();
        document.removeEventListener('keydown', handleEsc);
      }
    };
    document.addEventListener('keydown', handleEsc);
    
    // Add click outside to close
    const backdrop = document.querySelector('.modal-backdrop');
    if(backdrop) {
      backdrop.onclick = (e) => {
        if(e.target === backdrop) {
          modal.close();
          document.removeEventListener('keydown', handleEsc);
        }
      };
    }
    
    render();
  }
    
  
  
  function openSubtaskModal(a, s, onDone){
    const isEdit = !!s;
    const state = s ? {...s} : { id: uid('sub'), title:'', description:'', notes:'', due:'', done:false };
  
    const form = el('div');
    const r1 = el('div',{class:'row'});
    r1.appendChild(inputField('Title*','title'));
    r1.appendChild(inputField('Due date','due','date'));
    const r2 = el('div',{}); r2.appendChild(textField('Notes / description','notes'));
    form.appendChild(r1); form.appendChild(r2);

  

  
    const actions = el('div',{class:'right'});
    const saveBtn = el('button',{class:'btn-teal'},[isEdit?'Save':'Add']);
    const cancel = el('button',{class:'iconbtn'},['Cancel']);
    cancel.onclick = ()=> modal.close();
    saveBtn.onclick = ()=>{
      if(!state.title.trim()) return alert('Title is required');
      const payload = {
        id: state.id,
        title: state.title.trim(),
        description: state.description || state.notes || '',
        notes: state.notes || '',
        due: state.due || '',
        done: !!state.done
      };
      onDone && onDone(payload);
      modal.close();
    };
    actions.appendChild(cancel); actions.appendChild(saveBtn);
    form.appendChild(actions);
  
    // helpers
    function inputField(lbl,key,type='text'){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n=el('input',{type, value:state[key]||''}); n.oninput=()=> state[key]=n.value; box.appendChild(n); return box; }
    function textField(lbl,key){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n=el('textarea'); n.value=state[key]||''; n.oninput=()=> state[key]=n.value; box.appendChild(n); return box; }
    function checkField(lbl,key){ const box = el('div'); const lab=el('label',{},[]); const n=el('input',{type:'checkbox'}); n.checked=!!state[key]; n.onchange=()=> state[key]=n.checked; lab.appendChild(n); lab.appendChild(document.createTextNode(' '+lbl)); box.appendChild(lab); return box; }
  
    modal.open(isEdit? 'Edit subtask' : 'Add subtask', form);
  }
  
/* ---------------- Next Actions (cards) ---------------- */

// ---------------- Next Actions (v16-style UI) ----------------
/* Drag state (scoped) */
const DND = { type:null, aid:null, sid:null, fromIndex:null };

function viewNextActions(){
  const wrap = el('div',{class:'na-v16'});
  let filter = 'Not done', sort = 'due', searchText = '';

  /* toolbar (chips + search/sort + add) */
  /* === Next Actions: unified toolbarRow === */
const toolbar = el('div',{class:'toolbarRow'});

// Search at left
let deb;
const {wrap: searchWrapNA} = makeSearch('Search actions or subtasks', v=>{
  searchText = v;
  clearTimeout(deb);
  deb = setTimeout(()=> {
    if (currentView === 'calendar') drawCalendar();
    else draw();
  }, 120);
});

toolbar.appendChild(searchWrapNA);

// Filters bar for left side (Related + Status + Sort)
const filtersBarNA = el('div',{class:'filters-inline'});

// Relation filter (first after search)
const relField = el('div',{class:'field'});
relField.appendChild(el('label',{},[icon('filter'),'Related to']));
const relSel = el('select',{class:'small-select'});
['All','Coffee chat','Company','Entrepreneurship','Job','Other'].forEach(v=> relSel.appendChild(el('option',{value:v},[v])));
let relationFilter = 'All';
relSel.value = relationFilter;
relSel.onchange = ()=>{ 
  relationFilter = relSel.value; 
  if (currentView === 'calendar') refreshCalendar();
  else draw();
};
relField.appendChild(relSel);
filtersBarNA.appendChild(relField);

// Status segmented control (second)
const statusOpts = [
  {label:'All', value:'All'},
  {label:'Not done', value:'Not done'},
  {label:'Overdue', value:'Overdue'},
  {label:'Done', value:'Done'}
];
const statusControl = makeSegControl('Status', statusOpts, filter, (val)=> applyStatusFilter(val));
const statusField = el('div',{class:'field'});
statusField.appendChild(el('label',{},[icon('filter'),'Status of Action']));
statusField.appendChild(statusControl);
filtersBarNA.appendChild(statusField);

// Sort select (last)
const sortWrap = el('div',{class:'field'});
sortWrap.appendChild(el('label',{},[icon('sort'),'Sort by']));
const sortSel = el('select',{class:'small-select'});
[['created','Created date'],['due','Earliest subtask due'],['overdue','Most overdue first'],['alpha','Alphabetical']]
  .forEach(([v,l])=> sortSel.appendChild(el('option',{value:v},[l])));
// default to created
sort = 'created';
sortSel.value = sort;
sortSel.onchange = ()=>{ sort=sortSel.value; draw(); };
sortWrap.appendChild(sortSel);
filtersBarNA.appendChild(sortWrap);

toolbar.appendChild(filtersBarNA);

// Right cluster: View toggle + Add
const rightNA = el('div',{class:'toolbarRight'});

// View toggle (Cards/Calendar)
// currentView is now global
const viewSwitch = el('div',{class:'viewSwitch'});
const cardsBtn = el('button',{class:'viewBtn'+(currentView==='cards'?' isActive':'')});
cardsBtn.appendChild(el('div',{class:'label'},['CARDS']));
cardsBtn.appendChild(el('div',{class:'icon'},[icon('table')]));
cardsBtn.onclick = ()=> switchView('cards');

const calendarBtn = el('button',{class:'viewBtn'+(currentView==='calendar'?' isActive':'')});
calendarBtn.appendChild(el('div',{class:'label'},['CALENDAR']));
calendarBtn.appendChild(el('div',{class:'icon'},[icon('calendar')]));
calendarBtn.onclick = ()=> switchView('calendar');

viewSwitch.appendChild(cardsBtn);
viewSwitch.appendChild(calendarBtn);
rightNA.appendChild(viewSwitch);

const add = el('button',{class:'btn-teal'},['+ New action']);
add.onclick = ()=> openActionCreateModal();
rightNA.appendChild(add);

toolbar.appendChild(rightNA);
wrap.appendChild(toolbar);


  /* content containers */
  const grid = el('div',{class:'actions-grid'}); 
  const calendarContainer = el('div',{class:'calendar-container',style:'display:none'});
  wrap.appendChild(grid);
  wrap.appendChild(calendarContainer);

  /* helpers */
  const todayStr = ()=> { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; };
  function computeStatus(a){
    const total = a.subactions?.length || 0;
    const done = (a.subactions||[]).filter(s=>!!s.done).length;
    const status = total>0 && done===total ? 'Done' : done>0 ? 'In progress' : 'To do';
    return {status, done, total};
  }
  const hasOverdue = a => (a.subactions||[]).some(s=>!s.done && s.due && s.due < todayStr());
  function earliestDue(a){
    const p=(a.subactions||[]).filter(s=>!s.done && s.due);
    if(!p.length) return null;
    return p.map(s=>s.due).sort()[0];
  }
  function matches(a){
    // filter chip
    const cs = computeStatus(a).status;
    if(filter==='Done' && cs!=='Done') return false;
    if(filter==='Not done' && cs==='Done') return false;
    if(filter==='Overdue' && !hasOverdue(a)) return false;
    // relation filter
    if(typeof relationFilter!=='undefined' && relationFilter!=='All'){
      const rt = a.relatedType || 'Other';
      if(rt !== relationFilter) return false;
    }
    // search
    if(!searchText.trim()) return true;
    const q = searchText.trim().toLowerCase();
    if((a.title||'').toLowerCase().includes(q) || (a.description||'').toLowerCase().includes(q)) return true;
    return (a.subactions||[]).some(s=> (s.title||'').toLowerCase().includes(q) || (s.notes||s.description||'').toLowerCase().includes(q));
  }

  /* view switching */
  function switchView(view) {
    currentView = view;
    
    // Update button states
    cardsBtn.classList.toggle('isActive', view === 'cards');
    calendarBtn.classList.toggle('isActive', view === 'calendar');
    
    // Show/hide sort filter
    sortWrap.style.display = view === 'calendar' ? 'none' : 'flex';
    
    // Show/hide containers
    grid.style.display = view === 'cards' ? 'grid' : 'none';
    calendarContainer.style.display = view === 'calendar' ? 'block' : 'none';
    
    // Render appropriate view
    if (view === 'cards') {
      draw();
    } else {
      drawCalendar();
    }
  }

  /* renderers */
  function draw(){
    grid.innerHTML='';
    let list = db.actions.slice().filter(matches);

    if(sort==='alpha'){ list.sort((a,b)=> (a.title||'').localeCompare(b.title||'')); }
    else if(sort==='overdue'){ list.sort((a,b)=> (hasOverdue(b)?1:0) - (hasOverdue(a)?1:0)); }
    else if(sort==='created'){ list.sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||'')); }
    else { list.sort((a,b)=> (earliestDue(a)||'9999-99-99').localeCompare(earliestDue(b)||'9999-99-99')); }

    list.forEach(a=> grid.appendChild(renderActionCard(a)));
  }
  
  /* calendar view */
  let calendarView = 'month'; // day, week, month, year
  let currentDate = new Date();
  
  // Function to refresh calendar while preserving scroll position
  function refreshCalendar() {
    // Store current scroll position
    const scrollTop = calendarContainer.scrollTop;
    const scrollLeft = calendarContainer.scrollLeft;
    
    // Re-draw calendar
    drawCalendar();
    
    // Restore scroll position
    setTimeout(() => {
      calendarContainer.scrollTop = scrollTop;
      calendarContainer.scrollLeft = scrollLeft;
    }, 0);
  }
  
  // Make refreshCalendar globally accessible for modal refresh handlers
  window.refreshCalendar = refreshCalendar;

  function drawCalendar() {
    calendarContainer.innerHTML = '';
    
    // Calendar header with view options
    const calendarHeader = el('div', {class: 'calendar-header'});
    
    // View toggle buttons
    const viewToggle = el('div', {class: 'calendar-view-toggle'});
    ['week', 'month'].forEach(v => {
      const btn = el('button', {class: `calendar-view-btn ${v === calendarView ? 'active' : ''}`}, [v.toUpperCase()]);
      btn.onclick = () => {
        calendarView = v;
        drawCalendar();
      };
      viewToggle.appendChild(btn);
    });
    calendarHeader.appendChild(viewToggle);
    
    // Navigation
    const nav = el('div', {class: 'calendar-nav'});
    const prevBtn = el('button', {class: 'calendar-nav-btn'}, ['‹']);
    const nextBtn = el('button', {class: 'calendar-nav-btn'}, ['›']);
    const titleEl = el('div', {class: 'calendar-title'});
    
    prevBtn.onclick = () => navigateCalendar(-1);
    nextBtn.onclick = () => navigateCalendar(1);
    
    nav.appendChild(prevBtn);
    nav.appendChild(titleEl);
    nav.appendChild(nextBtn);
    calendarHeader.appendChild(nav);
    
    calendarContainer.appendChild(calendarHeader);
    
    // Calendar content
    const calendarContent = el('div', {class: 'calendar-content'});
    
    if (calendarView === 'month') {
      drawMonthView(calendarContent, titleEl);
    } else if (calendarView === 'week') {
      drawWeekView(calendarContent, titleEl);
    }
    
    calendarContainer.appendChild(calendarContent);
  }
  
  function drawMonthView(container, titleEl) {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    titleEl.textContent = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentDate);
    
    // Month grid
    const monthGrid = el('div', {class: 'month-grid'});
    
    // Day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
      monthGrid.appendChild(el('div', {class: 'day-header'}, [day]));
    });
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    // Generate calendar days
    for (let i = 0; i < 42; i++) { // 6 weeks max
      const date = new Date(startDate.getTime() + i * 24 * 60 * 60 * 1000);
      
      const dayEl = el('div', {class: `calendar-day ${date.getMonth() !== month ? 'other-month' : ''}`});
      
      // Day header with number and expand button
      const dayHeader = el('div', {class: 'day-header-row'});
      dayHeader.appendChild(el('div', {class: 'day-number'}, [date.getDate().toString()]));
      
      // Add expand button for current month days only
      if (date.getMonth() === month) {
        const expandBtn = el('button', {class: 'day-expand-btn'}, ['⌄']);
        expandBtn.onclick = () => expandDayView(new Date(date));
        dayHeader.appendChild(expandBtn);
      }
      
      dayEl.appendChild(dayHeader);
      
      // Add subtasks for this date
      const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      const subtasksForDay = getSubtasksForDate(dateStr);
      
      subtasksForDay.forEach(({action, subtask}) => {
        const card = createSubtaskCard(action, subtask);
        dayEl.appendChild(card);
      });
      
      monthGrid.appendChild(dayEl);
    }
    
    container.appendChild(monthGrid);
    
    // No date section
    const noDateSection = el('div', {class: 'no-date-section'});
    noDateSection.appendChild(el('h3', {}, ['No Due Date']));
    const noDateSubtasks = getSubtasksForDate(null);
    noDateSubtasks.forEach(({action, subtask}) => {
      const card = createSubtaskCard(action, subtask);
      noDateSection.appendChild(card);
    });
    
    if (noDateSubtasks.length > 0) {
      container.appendChild(noDateSection);
    }
  }
  
  function drawWeekView(container, titleEl) {
    // Get start of week (Sunday)
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
    
    // Set title to week range
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    titleEl.textContent = `${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()}`;
    
    // Week grid
    const weekGrid = el('div', {class: 'week-grid'});
    
    // Day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
      weekGrid.appendChild(el('div', {class: 'day-header'}, [day]));
    });
    
    // Generate week days
    for (let i = 0; i < 7; i++) {
      const date = new Date(startOfWeek);
      date.setDate(startOfWeek.getDate() + i);
      
      const dayEl = el('div', {class: 'calendar-day week-day'});
      
      // Day header with number and expand button
      const dayHeader = el('div', {class: 'day-header-row'});
      dayHeader.appendChild(el('div', {class: 'day-number'}, [date.getDate().toString()]));
      
      const expandBtn = el('button', {class: 'day-expand-btn'}, ['⌄']);
      expandBtn.onclick = () => expandDayView(date);
      dayHeader.appendChild(expandBtn);
      
      dayEl.appendChild(dayHeader);
      
      // Add subtasks for this date
      const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      const subtasksForDay = getSubtasksForDate(dateStr);
      
      subtasksForDay.forEach(({action, subtask}) => {
        const card = createSubtaskCard(action, subtask);
        dayEl.appendChild(card);
      });
      
      weekGrid.appendChild(dayEl);
    }
    
    container.appendChild(weekGrid);
    
    // No date section
    const noDateSection = el('div', {class: 'no-date-section'});
    noDateSection.appendChild(el('h3', {}, ['No Due Date']));
    const noDateSubtasks = getSubtasksForDate(null);
    noDateSubtasks.forEach(({action, subtask}) => {
      const card = createSubtaskCard(action, subtask);
      noDateSection.appendChild(card);
    });
    
    if (noDateSubtasks.length > 0) {
      container.appendChild(noDateSection);
    }
  }
  
  function expandDayView(date) {
    // Create a modal showing expanded view of a single day
    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    const subtasksForDay = getSubtasksForDate(dateStr);
    
    const content = el('div', {class: 'day-expand-content'});
    
    // Day title
    const dayTitle = el('h2', {class: 'day-expand-title'}, [
      date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })
    ]);
    content.appendChild(dayTitle);
    
    if (subtasksForDay.length === 0) {
      content.appendChild(el('p', {class: 'no-tasks'}, ['No tasks for this day']));
    } else {
      const tasksList = el('div', {class: 'day-tasks-list'});
      subtasksForDay.forEach(({action, subtask}) => {
        const expandedCard = createExpandedSubtaskCard(action, subtask);
        tasksList.appendChild(expandedCard);
      });
      content.appendChild(tasksList);
    }
    
    modal.open(`Day View — ${date.toLocaleDateString()}`, content);
  }
  
  function createExpandedSubtaskCard(action, subtask) {
    const card = el('div', {class: 'expanded-subtask-card'});
    
    // Header with action and subtask titles
    const header = el('div', {class: 'expanded-card-header'});
    header.appendChild(el('div', {class: 'expanded-action-title'}, [action.title || '']));
    header.appendChild(el('div', {class: 'expanded-subtask-title'}, [subtask.title || '']));
    card.appendChild(header);
    
    // Content with checkbox and actions
    const cardContent = el('div', {class: 'expanded-card-content'});
    
    // Checkbox
    const checkbox = el('input', {type: 'checkbox'});
    checkbox.checked = !!subtask.done;
    checkbox.onchange = () => {
      subtask.done = checkbox.checked;
      save();
      if (currentView === 'calendar') refreshCalendar();
      else draw();
    };
    cardContent.appendChild(checkbox);
    
    // Actions
    const actions = el('div', {class: 'expanded-card-actions'});
    
    const editBtn = el('button', {class: 'btn-small'}, ['Edit']);
    editBtn.onclick = () => {
      modal.close();
      openSubtaskEditModal(action, subtask);
    };
    
    const deleteBtn = el('button', {class: 'btn-small danger'}, ['Delete']);
    deleteBtn.onclick = () => {
      if (confirm(`Delete subtask "${subtask.title}"?`)) {
        action.subactions = action.subactions.filter(s => s.id !== subtask.id);
        save();
        modal.close();
        if (currentView === 'calendar') refreshCalendar();
        else draw();
      }
    };
    
    const expandBtn = el('button', {class: 'btn-small'}, ['Expand']);
    expandBtn.onclick = () => {
      modal.close();
      openActionExpandModal(action);
    };
    
    actions.appendChild(editBtn);
    actions.appendChild(expandBtn);
    actions.appendChild(deleteBtn);
    cardContent.appendChild(actions);
    
    card.appendChild(cardContent);
    
    return card;
  }
  
  function navigateCalendar(direction) {
    if (calendarView === 'month') {
      currentDate.setMonth(currentDate.getMonth() + direction);
    } else if (calendarView === 'week') {
      currentDate.setDate(currentDate.getDate() + (direction * 7));
    }
    drawCalendar();
  }
  
  function getSubtasksForDate(dateStr) {
    const result = [];
    const list = db.actions.slice().filter(matches);
    
    list.forEach(action => {
      (action.subactions || []).forEach(subtask => {
        if (dateStr === null ? !subtask.due : subtask.due === dateStr) {
          result.push({action, subtask});
        }
      });
    });
    
    return result;
  }
  
  function createSubtaskCard(action, subtask) {
    const card = el('div', {class: `subtask-calendar-card ${subtask.done ? 'completed' : ''}`});
    
    // Content
    const content = el('div', {class: 'card-content'});
    const actionTitle = el('div', {class: 'action-title'}, [action.title || '']);
    const subtaskTitle = el('div', {class: 'subtask-title'}, [subtask.title || '']);
    content.appendChild(actionTitle);
    content.appendChild(subtaskTitle);
    
    card.appendChild(content);
    
    // Click to open context menu
    card.onclick = (e) => {
      e.preventDefault();
      showContextMenu(e, action, subtask);
    };
    
    return card;
  }
  
  function showContextMenu(event, action, subtask) {
    // Remove any existing context menu
    const existing = document.querySelector('.context-menu');
    if (existing) existing.remove();
    
    // Create context menu
    const menu = el('div', {class: 'context-menu'});
    
    // Add new subtask option (FIRST)
    const addSubtaskItem = el('button', {class: 'context-menu-item'});
    addSubtaskItem.appendChild(icon('plus'));
    addSubtaskItem.appendChild(el('span', {}, ['Add New Subtask']));
    addSubtaskItem.onclick = () => {
      menu.remove();
      openAddSubtaskModal(action);
    };
    menu.appendChild(addSubtaskItem);
    
    // Expand option
    const expandItem = el('button', {class: 'context-menu-item'});
    expandItem.appendChild(icon('expand'));
    expandItem.appendChild(el('span', {}, ['Expand']));
    expandItem.onclick = () => {
      menu.remove();
      openActionExpandModal(action);
    };
    menu.appendChild(expandItem);
    
    // Mark as complete/incomplete option
    const completeItem = el('button', {class: 'context-menu-item'});
    const isCompleted = !!subtask.done;
    completeItem.appendChild(icon(isCompleted ? 'close' : 'check'));
    completeItem.appendChild(el('span', {}, [isCompleted ? 'Mark as Incomplete' : 'Mark as Complete']));
    completeItem.onclick = () => {
      subtask.done = !subtask.done;
      save();
      menu.remove();
      if (currentView === 'calendar') refreshCalendar();
      else draw();
    };
    menu.appendChild(completeItem);
    
    // Edit option
    const editItem = el('button', {class: 'context-menu-item'});
    editItem.appendChild(icon('edit'));
    editItem.appendChild(el('span', {}, ['Edit']));
    editItem.onclick = () => {
      menu.remove();
      openSubtaskEditModal(action, subtask);
    };
    menu.appendChild(editItem);
    
    // Delete option
    const deleteItem = el('button', {class: 'context-menu-item danger'});
    deleteItem.appendChild(icon('trash'));
    deleteItem.appendChild(el('span', {}, ['Delete']));
    deleteItem.onclick = () => {
      menu.remove();
      if (confirm(`Delete subtask "${subtask.title}"?`)) {
        action.subactions = action.subactions.filter(s => s.id !== subtask.id);
        save();
        if (currentView === 'calendar') refreshCalendar();
        else draw();
      }
    };
    menu.appendChild(deleteItem);
    
    // Position menu
    document.body.appendChild(menu);
    
    const rect = menu.getBoundingClientRect();
    let x = event.clientX;
    let y = event.clientY;
    
    // Adjust position if menu would go off screen
    if (x + rect.width > window.innerWidth) {
      x = window.innerWidth - rect.width - 5;
    }
    if (y + rect.height > window.innerHeight) {
      y = window.innerHeight - rect.height - 5;
    }
    
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    
    // Close menu when clicking elsewhere
    const closeMenu = (e) => {
      if (!menu.contains(e.target)) {
        menu.remove();
        document.removeEventListener('click', closeMenu);
      }
    };
    setTimeout(() => document.addEventListener('click', closeMenu), 0);
  }

  function applyStatusFilter(val){
    filter = val || 'All';
    if (currentView === 'calendar') drawCalendar();
    else draw();
  }  

  function renderActionCard(a){
    const {status, done, total} = computeStatus(a);
    const card = el('div',{class:'action-card'});

    /* head */
    const head = el('div',{class:'action-head'});

    // TOP ROW: Title + Status + Actions (all on same line)
    const topRow = el('div',{class:'action-top-row'});
    
    // contenteditable title (left side)
    const title = el('div',{class:'action-title','aria-label':'Action title', contenteditable:'true'});
    title.textContent = a.title || '';
    title.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); } }); // keep a single paragraph
    let tdeb;
    title.oninput = ()=>{
        clearTimeout(tdeb);
        title.classList.add('editing');
        const v = title.textContent;
        tdeb = setTimeout(()=>{ a.title = v; save(); title.classList.remove('editing'); },150);
    };
    topRow.appendChild(title);

    // Status and actions (right side)
    const right = el('div',{class:'head-right'});
    right.appendChild(el('span',{class:`badge ${status==='Done'?'done':status==='In progress'?'progress':'todo'}`},[status]));
    right.appendChild(el('span',{class:'progress-text'},[`${done} of ${total} completed`]));
    if(hasOverdue(a)) right.appendChild(el('span',{class:'badge overdue'},['Overdue']));

    const icons = el('span',{class:'head-icons'});
    const bEdit = el('button',{class:'iconbtn tiny',title:'Edit'},[icon('edit')]); bEdit.onclick = ()=> openActionEditModal(a);
    const bExpand = el('button',{class:'iconbtn tiny',title:'Expand'},[icon('expand')]); bExpand.onclick = ()=> openActionExpandModal(a);
    const bDel = el('button',{class:'iconbtn tiny',title:'Delete'},[icon('close')]); bDel.onclick = ()=> confirmModal('Delete action', `Delete "${a.title||'Untitled'}"?`, ()=>{ db.actions=db.actions.filter(x=>x.id!==a.id); save(); draw(); });
    [bEdit,bExpand,bDel].forEach(b=> icons.appendChild(b));
    right.appendChild(icons);
    topRow.appendChild(right);
    
    head.appendChild(topRow);

    // RELATION ROW (below title)
    const relationRow = el('div',{class:'relation-line'},[ getRelationText(a) ]);
    head.appendChild(relationRow);

    // DESCRIPTION ROW (below relation)
    const descRow = el('div',{class:'desc-one'},[
        el('span',{class:'label'},['Description:']),
        el('span',{class:'text'},[(a.description||'').trim()||'—'])
      ])
    head.appendChild(descRow);
    
    card.appendChild(head);

    /* body (subtasks) */
    const body = el('div',{class:'action-body'});
    (a.subactions||[]).forEach((s,idx)=> body.appendChild(renderSubRow(a,s,idx)));
    card.appendChild(body);

    /* foot */
    const foot = el('div',{class:'action-foot'});
    const addBtn = el('button',{class:'btn','aria-label':'Add new subtask'},['Add new subtask']);
    addBtn.onclick = ()=> openSubtaskModal(a, null, (created)=>{ a.subactions=a.subactions||[]; a.subactions.push(created); save(); if (currentView === 'calendar') refreshCalendar(); else draw(); });
    foot.appendChild(addBtn);
    card.appendChild(foot);

    return card;
  }

  function renderSubRow(a,s,idx){
    const row = el('div',{class:'sub-row', draggable:'true'});
    row.dataset.sid = s.id;

    // drag reorder (same action)
    row.addEventListener('dragstart', e=>{ DND.type='sub'; DND.aid=a.id; DND.sid=s.id; DND.fromIndex=idx; e.dataTransfer.effectAllowed='move'; try{ e.dataTransfer.setData('text/plain', s.id); }catch(_){} });
    row.addEventListener('dragover', e=>{ if(DND.type==='sub' && DND.aid===a.id){ e.preventDefault(); row.classList.add('drag-over'); } });
    row.addEventListener('dragleave', ()=> row.classList.remove('drag-over'));
    row.addEventListener('drop', e=>{
      row.classList.remove('drag-over');
      if(!(DND.type==='sub' && DND.aid===a.id)) return;
      e.preventDefault();
      const toIndex = Array.from(row.parentNode.children).indexOf(row);
      const fromIndex = DND.fromIndex;
      if(fromIndex===toIndex || fromIndex==null) return;
      const arr = a.subactions||[];
      const [moved] = arr.splice(fromIndex,1);
      arr.splice(toIndex,0,moved);
      save(); onActionChange(a, row.closest('.action-card'));
      DND.type=DND.aid=DND.sid=DND.fromIndex=null;
    });

    // click row -> edit modal (ignore controls)
    row.addEventListener('click', (e)=>{
      if (e.target.closest('input[type="checkbox"], .sub-check, .iconbtn')) return;
      openSubtaskModal(a, s, (updated)=>{ Object.assign(s, updated); onActionChange(a, row.closest('.action-card')); });
    });
    

    // checkbox with bigger invisible hit area via <label>
    const cb = el('input', {
      type: 'checkbox',
      id: uid('chk'),
      'aria-label': `Mark "${s.title}" completed`
    });
    cb.checked = !!s.done;
    cb.addEventListener('click', e => e.stopPropagation());
    cb.onchange = () => { s.done = cb.checked; onActionChange(a, row.closest('.action-card')); };
    
    const cbWrap = el('label', { class: 'sub-check', for: cb.id, title: 'Mark complete' });
    cbWrap.appendChild(cb);
    row.appendChild(cbWrap);
    

    const title = el('span',{class:'sub-title'+(s.done?' sub-completed':'')},[s.title||'']);
    row.appendChild(title);

    const due = el('span',{class:'due-pill'},[ s.due ? fmtDate(s.due) : '—' ]);
    row.appendChild(due);

    const icons = el('div',{class:'sub-icons'});
    const dBtn = el('button',{class:'iconbtn tiny',title:'Delete'},[icon('close')]);
    dBtn.addEventListener('click', ev=>{ ev.stopPropagation(); confirmModal('Delete subtask', `Delete "${s.title||'subtask'}"?`, ()=>{ a.subactions=(a.subactions||[]).filter(x=>x.id!==s.id); save(); if (currentView === 'calendar') refreshCalendar(); else draw(); }); });
    icons.appendChild(dBtn);
    row.appendChild(icons);

    const overdue = !s.done && s.due && s.due < todayStr();
    if(overdue){ title.classList.add('sub-overdue'); due.classList.add('sub-overdue'); }

    return row;
  }

  function onActionChange(a, cardEl){
    save();
    const fresh = renderActionCard(a);
    cardEl.replaceWith(fresh);
  }

  // Initialize view
  if (currentView === 'cards') {
  draw();
  } else {
    drawCalendar();
  }
  
  return wrap;
}

/* ---------------- Entrepreneurship (Ideas) ---------------- */
function viewIdeas(){
  const wrap = el('div',{class:'ideas-v1'});
  
  // Toolbar
  const toolbar = el('div',{class:'toolbarRow'});
  
  // Search
  const searchDiv = el('div',{class:'search-wrap'});
  const searchIcon = el('div',{class:'search-icon'},['🔍']);
  const searchInput = el('input',{type:'search',placeholder:"Search by idea's title, description and investigation notes…"});
  searchDiv.appendChild(searchIcon);
  searchDiv.appendChild(searchInput);
  
  // Show favorite toggle
  const switchLabel = el('label',{class:'switch ideas-switch'});
  const favoriteCheckbox = el('input',{type:'checkbox', class:'ideas-checkbox'});
  switchLabel.appendChild(favoriteCheckbox);
  switchLabel.appendChild(el('span',{},['Show Favorite']));
  
  // Add idea button
  const addBtn = el('button',{class:'btn-teal'},['+ New idea']);
  
  toolbar.appendChild(searchDiv);
  toolbar.appendChild(switchLabel);
  toolbar.appendChild(addBtn);
  wrap.appendChild(toolbar);
  
  // Ideas list
  const ideasList = el('div',{class:'list'});
  wrap.appendChild(ideasList);
  
  // Event handlers
  let searchText = '';
  let showFavoriteOnly = false;
  
  searchInput.oninput = () => {
    searchText = searchInput.value;
    renderIdeas();
  };
  
  favoriteCheckbox.onchange = () => {
    showFavoriteOnly = favoriteCheckbox.checked;
    renderIdeas();
  };
  
  addBtn.onclick = () => openIdeaModal();
  
  // Render function with state preservation
  function renderIdeas(scrollToNewItem = null) {
    // Store scroll position and open idea cards
    const scrollPosition = window.scrollY;
    const openIdeaIds = [];
    document.querySelectorAll('.idea.open').forEach(idea => {
      openIdeaIds.push(idea.getAttribute('data-idea-id'));
    });
    
    ideasList.innerHTML = '';
    const query = searchText.toLowerCase();
    
    let filteredIdeas = (db.ideas || [])
      .filter(i => showFavoriteOnly ? i.starred : true)
      .filter(i => !query ? true : (
        (i.name||'').toLowerCase().includes(query) || 
        (i.description||'').toLowerCase().includes(query) || 
        ((i.investigations||[]).map(x=>x.text).join(' ').toLowerCase()).includes(query)
      ))
      .sort((a,b) => (b.updatedAt||'').localeCompare(a.updatedAt||''));
    
    if (!filteredIdeas.length) {
      ideasList.appendChild(el('div',{class:'muted',style:'text-align:center;padding:30px'},[
        'No ideas yet. Click ', 
        el('span',{style:'font-weight:800'},['"➕ New idea"']), 
        ' to start. 💡'
      ]));
      
      // Restore scroll position even when empty
      setTimeout(() => {
        window.scrollTo(0, scrollPosition);
      }, 10);
      return;
    }
    
    filteredIdeas.forEach(idea => {
      ideasList.appendChild(createIdeaCard(idea));
    });
    
    // Restore scroll position and open idea cards
    setTimeout(() => {
      // First restore open states
      openIdeaIds.forEach(ideaId => {
        const ideaCard = document.querySelector(`[data-idea-id="${ideaId}"]`);
        if (ideaCard) {
          ideaCard.classList.add('open');
          const detailsBtn = ideaCard.querySelector('.details-btn');
          if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
        }
      });
      
      // Then restore scroll position - use scrollIntoView for better behavior
      if (openIdeaIds.length > 0) {
        const firstOpenCard = document.querySelector(`[data-idea-id="${openIdeaIds[0]}"]`);
        if (firstOpenCard) {
          // Try to find the "Next steps" section specifically
          const sectionTitles = firstOpenCard.querySelectorAll('.section-title');
          let nextStepsSection = null;
          sectionTitles.forEach(title => {
            if (title.textContent.includes('Next steps')) {
              nextStepsSection = title;
            }
          });
          
          if (nextStepsSection) {
            // Use scrollIntoView with 'nearest' to minimize scroll changes
            nextStepsSection.scrollIntoView({ 
              behavior: 'instant', 
              block: 'nearest',
              inline: 'nearest'
            });
          } else {
            // Fallback: use scrollIntoView on the card itself
            firstOpenCard.scrollIntoView({ 
              behavior: 'instant', 
              block: 'nearest',
              inline: 'nearest'
            });
          }
        } else {
          // Final fallback to original scroll position
          window.scrollTo(0, scrollPosition);
        }
      } else {
        // No open cards, use original scroll position
        window.scrollTo(0, scrollPosition);
      }
      
      // If we have a new item to scroll to, do it after scroll restoration
      if (scrollToNewItem) {
        setTimeout(() => {
          // Look for the newly created action or subtask
          const newActionCard = document.querySelector(`[data-action-id="${scrollToNewItem}"]`);
          const newSubtaskRow = document.querySelector(`[data-subtask-id="${scrollToNewItem}"]`);
          
          if (newActionCard) {
            newActionCard.scrollIntoView({ block: 'center', behavior: 'instant' });
          } else if (newSubtaskRow) {
            newSubtaskRow.scrollIntoView({ block: 'center', behavior: 'instant' });
          }
        }, 50);
      }
      
      // Bind the toggle functionality after rendering
      dash360BindToggle();
    }, 100);
  }
  
  // Create idea card
  function createIdeaCard(idea) {
    const card = el('div',{class:'idea' + (idea.archived ? ' archived' : ''), 'data-idea-id': idea.id});
    
    // Header
    const head = el('div',{class:'idea-head-new'});
    
    // Emoji button
    const emojiBtn = el('button',{class:'emoji-btn',title:'Change emoji'},[idea.icon||'💡']);
    emojiBtn.onclick = () => openEmojiModal(idea);
    
    // Title input
    const titleInput = el('input',{class:'title-description',value:idea.name||'',placeholder:'Untitled idea…'});
    titleInput.oninput = () => {
      idea.name = titleInput.value;
      touch(idea);
    };
    titleInput.onblur = () => {
      if (!titleInput.value.trim()) {
        titleInput.value = 'Untitled idea';
        idea.name = 'Untitled idea';
        touch(idea);
      }
    };
    
    // Details button
    const detailsBtn = el('button',{class:'details-btn',title:'Show/Hide Details'},['Details ▼']);
    detailsBtn.onclick = () => {
      card.classList.toggle('open');
      detailsBtn.innerHTML = card.classList.contains('open') ? 'Hide ▲' : 'Details ▼';
    };
    
    // Star
    const star = el('span',{class:'star-big',title:'Favorite'},[idea.starred ? '⭐' : '☆']);
    star.onclick = (e) => {
      e.stopPropagation();
      idea.starred = !idea.starred;
      star.textContent = idea.starred ? '⭐' : '☆';
      touch(idea);
    };
    
    // Delete button
    const deleteBtn = el('button',{class:'delete-x',title:'Delete idea'},['×']);
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      if (confirm('Delete this idea?')) {
        db.ideas = db.ideas.filter(i => i.id !== idea.id);
        save();
        renderIdeas();
      }
    };
    
    head.appendChild(emojiBtn);
    head.appendChild(titleInput);
    head.appendChild(detailsBtn);
    head.appendChild(star);
    head.appendChild(deleteBtn);
    card.appendChild(head);
    
    // Expandable body
    const body = el('div',{class:'idea-body'});
    
    // Description section
    const descSection = createSection('📝 Description');
    const descCard = el('div', {class: 'input-card'});
    const descArea = el('textarea',{placeholder:'Write freely. What is the idea? Why now? Who cares?', style: 'width: 100%; min-height: 80px; border: none; outline: none; resize: vertical; font-family: inherit;'});
    descArea.value = idea.description||'';
    descArea.oninput = () => {
      idea.description = descArea.value;
      touch(idea);
    };
    descCard.appendChild(descArea);
    descSection.appendChild(descCard);
    body.appendChild(descSection);
    
    // Next steps section
    const nextStepsSection = createSection('✅ Next steps');
    const actionsForIdea = (db.actions || []).filter(a => a.relatedType === 'Entrepreneurship' && a.relatedId === idea.id);
    
    if (actionsForIdea.length > 0) {
      actionsForIdea.forEach(action => {
        nextStepsSection.appendChild(createIdeaActionCard(action, idea));
      });
    }
    
    // Add next step button
    const addNextStepBtn = el('button', {class: 'btn-outline'}, ['+ Next step']);
    addNextStepBtn.onclick = () => {
      openActionCreateModal({
        relatedType: 'Entrepreneurship',
        relatedId: idea.id
      });
    };
    nextStepsSection.appendChild(addNextStepBtn);
    body.appendChild(nextStepsSection);
    
    card.appendChild(body);
    return card;
  }
  
  // Create action card for idea
  function createIdeaActionCard(action, idea) {
    const card = el('div', {class: 'action-card-simple', 'data-action-id': action.id});
    
    // Header with title and date
    const head = el('div', {class: 'action-head-simple'});
    const title = el('div', {class: 'action-title-simple'}, [action.title || 'Untitled']);
    const date = el('div', {class: 'action-date-simple'}, [
      action.due ? new Date(action.due).toLocaleDateString() : 'No date'
    ]);
    head.appendChild(title);
    head.appendChild(date);
    card.appendChild(head);
    
    // Notes
    if (action.description) {
      const notes = el('div', {class: 'action-notes-simple'}, [action.description]);
      card.appendChild(notes);
    }
    
    // Subtasks
    const body = el('div', {class: 'action-body-simple'});
    (action.subactions || []).forEach((subtask, idx) => {
      body.appendChild(createIdeaSubRow(action, subtask, idx, idea, card));
    });
    card.appendChild(body);
    
    // Footer with add subtask button
    const foot = el('div', {class: 'action-foot-simple'});
    const hasSubtasks = action.subactions && action.subactions.length > 0;
    const addBtn = el('button', {class: 'btn-small'}, [hasSubtasks ? 'Add another subtask' : 'Add new subtask']);
    addBtn.onclick = () => openAddSubtaskModal(action);
    foot.appendChild(addBtn);
    card.appendChild(foot);
    
    return card;
  }
  
  // Create subtask row for idea
  function createIdeaSubRow(action, subtask, idx, idea, card) {
    const row = el('div', {class: 'sub-row-simple'});
    row.dataset.sid = subtask.id;
    
    // Checkbox
    const cb = el('input', {
      type: 'checkbox',
      id: uid('chk'),
      'aria-label': `Mark "${subtask.title}" completed`
    });
    cb.checked = !!subtask.done;
    cb.addEventListener('click', e => e.stopPropagation());
    cb.onchange = () => {
      subtask.done = cb.checked;
      save();
      
      // Preserve state when checking subtask
      const scrollPosition = window.scrollY;
      const openIdeaIds = [];
      document.querySelectorAll('.idea.open').forEach(idea => {
        openIdeaIds.push(idea.getAttribute('data-idea-id'));
      });
      
      renderIdeas();
      
      setTimeout(() => {
        window.scrollTo(0, scrollPosition);
        openIdeaIds.forEach(ideaId => {
          const ideaCard = document.querySelector(`[data-idea-id="${ideaId}"]`);
          if (ideaCard) {
            ideaCard.classList.add('open');
            const detailsBtn = ideaCard.querySelector('.details-btn');
            if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
          }
        });
      }, 10);
    };
    
    // Title and date
    const content = el('div', {class: 'sub-content-simple'});
    const title = el('span', {class: subtask.done ? 'done' : ''}, [subtask.title || 'Untitled subtask']);
    content.appendChild(title);
    
    if (subtask.due) {
      const date = el('span', {class: 'sub-date-simple'}, [` (${new Date(subtask.due).toLocaleDateString()})`]);
      content.appendChild(date);
    }
    
    // Delete button
    const deleteBtn = el('button', {class: 'sub-delete-btn', title: 'Delete subtask'}, ['×']);
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      if (confirm('Delete this subtask?')) {
        action.subactions = action.subactions.filter(s => s.id !== subtask.id);
        save();
        
        // Preserve state when deleting subtask
        const scrollPosition = window.scrollY;
        const openIdeaIds = [];
        document.querySelectorAll('.idea.open').forEach(idea => {
          openIdeaIds.push(idea.getAttribute('data-idea-id'));
        });
        
        renderIdeas();
        
        setTimeout(() => {
          window.scrollTo(0, scrollPosition);
          openIdeaIds.forEach(ideaId => {
            const ideaCard = document.querySelector(`[data-idea-id="${ideaId}"]`);
            if (ideaCard) {
              ideaCard.classList.add('open');
              const detailsBtn = ideaCard.querySelector('.details-btn');
              if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
            }
          });
        }, 10);
      }
    };
    
    row.appendChild(cb);
    row.appendChild(content);
    row.appendChild(deleteBtn);
    return row;
  }
  
  // Helper functions
  function createSection(title) {
    const section = el('div', {class: 'idea-section'});
    const header = el('h3', {class: 'section-title'}, [title]);
    section.appendChild(header);
    return section;
  }
  
  function touch(idea) {
    idea.updatedAt = new Date().toISOString();
    save();
  }
  
  function openEmojiModal(idea) {
    const emojis = ['💡', '🚀', '💰', '🎯', '⭐', '🔥', '💎', '🌟', '⚡', '🎨', '🔮', '🏆'];
    const form = el('div', {class: 'emoji-grid'});
    
    emojis.forEach(emoji => {
      const btn = el('button', {class: 'emoji-option'}, [emoji]);
      btn.onclick = () => {
        idea.icon = emoji;
        touch(idea);
        renderIdeas();
        modal.close();
      };
      form.appendChild(btn);
    });
    
    modal.open('Choose emoji', form);
  }
  
  function openIdeaModal(idea = null) {
    const isEdit = !!idea;
    const state = idea ? {...idea} : {
      name: '',
      description: '',
      icon: '💡',
      starred: false,
      archived: false,
      investigations: []
    };
    
    const form = el('div');
    
    // Name
    const nameWrap = el('div');
    nameWrap.appendChild(el('label', {html: 'Name*'}));
    const nameInput = el('input', {type: 'text', value: state.name, placeholder: 'Enter idea name'});
    nameInput.oninput = () => state.name = nameInput.value;
    nameWrap.appendChild(nameInput);
    form.appendChild(nameWrap);
    
    // Description
    const descWrap = el('div');
    descWrap.appendChild(el('label', {html: 'Description'}));
    const descTextarea = el('textarea', {placeholder: 'Describe your idea...', style: 'min-height: 100px'});
    descTextarea.value = state.description || '';
    descTextarea.oninput = () => state.description = descTextarea.value;
    descWrap.appendChild(descTextarea);
    form.appendChild(descWrap);
    
    // Actions
    const actions = el('div', {class: 'right'});
    const saveBtn = el('button', {class: 'btn-teal'}, [isEdit ? 'Save' : 'Add']);
    saveBtn.onclick = () => {
      if (!state.name.trim()) return alert('Name is required');
      
      if (isEdit) {
        const index = db.ideas.findIndex(i => i.id === idea.id);
        if (index !== -1) {
          db.ideas[index] = {...db.ideas[index], ...state, updatedAt: new Date().toISOString()};
        }
      } else {
        state.id = uid('idea');
        state.createdAt = new Date().toISOString();
        state.updatedAt = new Date().toISOString();
        db.ideas = db.ideas || [];
        db.ideas.unshift(state);
      }
      
      save();
      modal.close();
      renderIdeas();
    };
    
    const cancelBtn = el('button', {class: 'iconbtn'}, ['Cancel']);
    cancelBtn.onclick = () => modal.close();
    
    actions.appendChild(cancelBtn);
    actions.appendChild(saveBtn);
    form.appendChild(actions);
    
    modal.open(isEdit ? 'Edit idea' : 'New idea', form);
  }
  
  // Expose local renderIdeas function globally for modals
  window.renderIdeasLocal = renderIdeas;
  
  // Initial render
  renderIdeas();
  
  // Bind the toggle functionality after the view is rendered
  setTimeout(() => dash360BindToggle(), 0);
  
  return wrap;
}

/* ---------------- Action and Subtask Modals ---------------- */
function openActionCreateModal(prefilledData = {}) {
  const state = {
    title: '',
    due: '',
    description: '',
    relatedType: prefilledData.relatedType || 'Other',
    relatedId: prefilledData.relatedId || ''
  };
  
  const form = el('div');
  
  // Title field
  const titleWrap = el('div');
  titleWrap.appendChild(el('label', {html: 'Title*'}));
  const titleInput = el('input', {type: 'text', placeholder: 'Enter action title'});
  titleInput.oninput = () => state.title = titleInput.value;
  titleWrap.appendChild(titleInput);
  form.appendChild(titleWrap);
  
  // Date field
  const dateWrap = el('div');
  dateWrap.appendChild(el('label', {html: 'Date'}));
  const dateInput = el('input', {type: 'date', value: ''});
  dateInput.oninput = () => state.due = dateInput.value;
  dateWrap.appendChild(dateInput);
  form.appendChild(dateWrap);
  
  // Notes field
  const notesWrap = el('div');
  notesWrap.appendChild(el('label', {html: 'Notes'}));
  const notesTextarea = el('textarea');
  notesTextarea.oninput = () => state.description = notesTextarea.value;
  notesWrap.appendChild(notesTextarea);
  form.appendChild(notesWrap);
  
  const actions = el('div', {class: 'right'});
  const saveBtn = el('button', {class: 'btn-teal'}, ['Add']);
  
  saveBtn.onclick = () => {
    if (!state.title.trim()) return alert('Title is required');
    
    const newAction = {
      id: uid('action'),
      title: state.title.trim(),
      due: state.due || '',
      description: state.description || '',
      relatedType: state.relatedType,
      relatedId: state.relatedId,
      createdAt: new Date().toISOString(),
      subactions: []
    };
    
    db.actions = db.actions || [];
    db.actions.unshift(newAction);
    save();
    
    // Inline update: append a subtask row to the visible card if present
    try{
      const card = document.querySelector(`.action-card[data-action-id="${action.id}"]`);
      if (card){
        const body = card.querySelector('.action-body .subs');
        // Fallback: create container if not present
        const container = body || card.querySelector('.action-body') || card;
        const row = document.createElement('div');
        row.className = 'sub-row';
        row.innerHTML = `<input type="checkbox" ${newSubtask.done?'checked':''} disabled><span class="sub-title">${newSubtask.title}</span><span class="due-pill">${newSubtask.due||'—'}</span>`;
        container.appendChild(row);
      }
    }catch(_){ }
    
    modal.close();
    
    // Use appropriate refresh function based on current module
    if (currentTab === 'ideas') {
      // Store scroll position and open idea cards
      const scrollPosition = window.scrollY;
      const openIdeaIds = [];
      document.querySelectorAll('.idea.open').forEach(idea => {
        openIdeaIds.push(idea.getAttribute('data-idea-id'));
      });
      
      renderIdeas();
      
      // Restore scroll position and open idea cards
      setTimeout(() => {
        window.scrollTo(0, scrollPosition);
        openIdeaIds.forEach(ideaId => {
          const ideaCard = document.querySelector(`[data-idea-id="${ideaId}"]`);
          if (ideaCard) {
            ideaCard.classList.add('open');
            const detailsBtn = ideaCard.querySelector('.details-btn');
            if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
          }
        });
      }, 10);
    } else if (currentTab === 'actions') {
      // Check if calendar is currently visible in Next Actions
      const calendarContainer = document.querySelector('.calendar-container');
      if (calendarContainer && calendarContainer.style.display !== 'none') {
        refreshCalendar();
      } else {
        render();
      }
    } else if (currentView === 'calendar') {
      refreshCalendar();
    } else {
      // Switch to Next Actions tab for other modules
      const actionTab = document.querySelector('[data-tab="actions"]');
      if (actionTab) {
        actionTab.click();
      }
    }
  };
  
  const cancel = el('button', {class: 'iconbtn'}, ['Cancel']);
  cancel.onclick = () => modal.close();
  actions.appendChild(cancel);
  actions.appendChild(saveBtn);
  form.appendChild(actions);
  
  modal.open('New action', form);
}

function openAddSubtaskModal(action) {
  const form = el('div');
  
  // Title field
  const titleWrap = el('div');
  titleWrap.appendChild(el('label', {html: 'Title*'}));
  const titleInput = el('input', {type: 'text', placeholder: 'Enter subtask title'});
  titleWrap.appendChild(titleInput);
  form.appendChild(titleWrap);
  
  // Date field
  const dateWrap = el('div');
  dateWrap.appendChild(el('label', {html: 'Due Date'}));
  const dateInput = el('input', {type: 'date'});
  dateWrap.appendChild(dateInput);
  form.appendChild(dateWrap);
  
  // Notes field
  const notesWrap = el('div');
  notesWrap.appendChild(el('label', {html: 'Notes'}));
  const notesInput = el('textarea', {placeholder: 'Add notes...'});
  notesWrap.appendChild(notesInput);
  form.appendChild(notesWrap);
  
  const actions = el('div', {class: 'right'});
  const saveBtn = el('button', {class: 'btn-teal'}, ['Add Subtask']);
  const cancelBtn = el('button', {class: 'iconbtn'}, ['Cancel']);
  
  saveBtn.onclick = () => {
    if (!titleInput.value.trim()) return alert('Title is required');
    
    const newSubtask = {
      id: uid('sub'),
      title: titleInput.value.trim(),
      due: dateInput.value || '',
      done: false,
      notes: notesInput.value.trim()
    };
    
    // Add to action
    action.subactions = action.subactions || [];
    action.subactions.push(newSubtask);
    
    save();
    
    // Inline DOM update: inject the new subtask row into the visible card (if present)
    try{
      const card = document.querySelector(`.action-card[data-action-id="${action.id}"]`);
      if (card){
        const body = card.querySelector('.action-body');
        if (body){
          const row = document.createElement('div');
          row.className = 'sub-row';
          const prettyDue = (typeof fmtDate==='function' && newSubtask.due) ? fmtDate(newSubtask.due) : (newSubtask.due||'—');
          row.innerHTML = `<label class="sub-check"><input type="checkbox" ${newSubtask.done?'checked':''} disabled></label><span class="sub-title">${newSubtask.title||''}</span><span class="due-pill">${prettyDue}</span>`;
          body.appendChild(row);
          // Update header progress text if present
          const meta = typeof computeActionStatus==='function' ? computeActionStatus(action) : null;
          if (meta){
            const progress = card.querySelector('.progress-text');
            if (progress) progress.textContent = `${meta.done} of ${meta.total} completed`;
          }
        }
      }
    }catch(_){ }

    modal.close();
    
    // Use appropriate refresh function based on current module
    if (currentTab === 'ideas') {
      // Store scroll position and open idea cards
      const scrollPosition = window.scrollY;
      const openIdeaIds = [];
      document.querySelectorAll('.idea.open').forEach(idea => {
        openIdeaIds.push(idea.getAttribute('data-idea-id'));
      });
      
      renderIdeas();
      
      // Restore scroll position and open idea cards
      setTimeout(() => {
        window.scrollTo(0, scrollPosition);
        openIdeaIds.forEach(ideaId => {
          const ideaCard = document.querySelector(`[data-idea-id="${ideaId}"]`);
          if (ideaCard) {
            ideaCard.classList.add('open');
            const detailsBtn = ideaCard.querySelector('.details-btn');
            if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
          }
        });
      }, 10);
    } else if (typeof window.d360RefreshActionsForCompanyId === 'function') {
      const companyId = d360GetCompanyIdForActionId(action.id);
      const ok = companyId && window.d360RefreshActionsForCompanyId(companyId);
      if (!ok && typeof window.dash360RefreshNow === 'function') window.dash360RefreshNow();
    } else if (typeof window.d360RefreshActionsForCompanyId === 'function') {
      const companyId = d360GetCompanyIdForActionId(action.id);
      const ok = companyId && window.d360RefreshActionsForCompanyId(companyId);
      if (!ok && typeof window.dash360RefreshNow === 'function') window.dash360RefreshNow();
    } else if (currentView === 'calendar') {
      refreshCalendar();
    } else if (currentTab === 'actions') {
      render();
    } else {
      render();
    }
  };
  
  cancelBtn.onclick = () => modal.close();
  
  actions.appendChild(cancelBtn);
  actions.appendChild(saveBtn);
  form.appendChild(actions);
  
  modal.open('Add New Subtask', form);
}

/* ---------------- Calendar Subtask Modals ---------------- */
function openSubtaskEditModal(action, subtask) {
  // Edit modal with action data + only this subtask
  const isEdit = true;
  const state = {
    ...action,
    subactions: [subtask] // Only this subtask
  };
  
  const form = el('div');

  // Title
  const r1 = el('div',{class:'row'});
  r1.appendChild(inputField('Title*','title'));
  form.appendChild(r1);

  // Related to (type + picker) - same as regular edit
  const r2 = el('div',{class:'row'});
  const typeBox = el('div');
  typeBox.appendChild(el('label',{html:'Related to'}));
  const typeSel = el('select');
  ['Other','Company','Job','Coffee chat','Entrepreneurship'].forEach(v=> typeSel.appendChild(el('option',{value:v},[v])));
  typeSel.value = state.relatedType || 'Other';
  typeSel.onchange = ()=>{ state.relatedType = typeSel.value; buildRelPicker(); };
  typeBox.appendChild(typeSel);
  r2.appendChild(typeBox);

  const relBox = el('div');
  relBox.appendChild(el('label',{html:'Pick related item'}));
  const relHolder = el('div'); relBox.appendChild(relHolder);
  r2.appendChild(relBox);
  form.appendChild(r2);

  // Description
  const r3 = el('div',{}); r3.appendChild(textField('Description','description')); form.appendChild(r3);
  
  // Single subtask editing
  const subtaskSection = el('div',{class:'subtasks-edit-section'});
  subtaskSection.appendChild(el('h3',{style:'margin:16px 0 8px;font-size:14px;color:#374151;font-weight:600'},['Subtask']));
  
  const subtaskRow = el('div',{class:'subtask-edit-row'});
  
  // Title field
  const titleField = el('div',{class:'subtask-field'});
  titleField.appendChild(el('label',{html:'Title'}));
  const titleInput = el('input',{type:'text',value:subtask.title||''});
  titleInput.oninput = ()=> state.subactions[0].title = titleInput.value;
  titleField.appendChild(titleInput);
  subtaskRow.appendChild(titleField);
  
  // Date field
  const dateField = el('div',{class:'subtask-field'});
  dateField.appendChild(el('label',{html:'Due Date'}));
  const dateInput = el('input',{type:'date',value:subtask.due||''});
  dateInput.oninput = ()=> state.subactions[0].due = dateInput.value;
  dateField.appendChild(dateInput);
  subtaskRow.appendChild(dateField);
  
  // Completed field
  const completedField = el('div',{class:'subtask-field'});
  completedField.appendChild(el('label',{html:'Status'}));
  const completedWrapper = el('div',{class:'checkbox-wrapper'});
  const completedInput = el('input',{type:'checkbox',checked:!!subtask.done,id:'subtask-completed'});
  completedInput.onchange = ()=> state.subactions[0].done = completedInput.checked;
  const completedLabel = el('label',{for:'subtask-completed',class:'checkbox-label'});
  completedLabel.appendChild(completedInput);
  completedLabel.appendChild(el('span',{class:'checkbox-text'},['Completed']));
  completedWrapper.appendChild(completedLabel);
  completedField.appendChild(completedWrapper);
  subtaskRow.appendChild(completedField);
  
  // Notes field
  const notesField = el('div',{class:'subtask-field-full'});
  notesField.appendChild(el('label',{html:'Notes'}));
  const notesInput = el('textarea',{style:'min-height:60px'});
  notesInput.value = subtask.notes||'';
  notesInput.oninput = ()=> state.subactions[0].notes = notesInput.value;
  notesField.appendChild(notesInput);
  subtaskRow.appendChild(notesField);
  
  subtaskSection.appendChild(subtaskRow);
  form.appendChild(subtaskSection);

  // Actions
  const actions = el('div',{class:'right'});
  const saveBtn = el('button',{class:'btn-teal'},['Save']);
  const cancelBtn = el('button',{class:'iconbtn'},['Cancel']);
  cancelBtn.onclick = ()=> modal.close();
  saveBtn.onclick = ()=>{
    if(!state.title.trim()) return alert('Title is required');
    
    // Update the original action and subtask
    Object.assign(action, {
      title: state.title,
      relatedType: state.relatedType,
      relatedId: state.relatedId,
      description: state.description
    });
    Object.assign(subtask, state.subactions[0]);
    
    save(); modal.close(); 
    if (currentView === 'calendar') refreshCalendar();
    else render();
  };
  actions.appendChild(cancelBtn); actions.appendChild(saveBtn);
  form.appendChild(actions);

  // helpers
  function inputField(lbl,key){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n=el('input',{type:'text',value:state[key]||''}); n.oninput=()=> state[key]=n.value; box.appendChild(n); return box; }
  function textField(lbl,key){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const n=el('textarea'); n.value=state[key]||''; n.oninput=()=> state[key]=n.value; box.appendChild(n); return box; }

  function buildRelPicker(){
    relHolder.innerHTML='';
    if(state.relatedType==='Other'){ state.relatedId=''; relHolder.appendChild(el('div',{},['—'])); return; }
    const sel = el('select');
    let opts = [];
    if(state.relatedType==='Company'){ opts = db.companies.map(c=>({label:c.name, value:c.id})).sort((a,b) => a.label.localeCompare(b.label)); }
    if(state.relatedType==='Job'){ opts = db.jobs.map(j=>({label:j.title + (db.companies.find(c=>c.id===j.companyId)? ` — ${db.companies.find(c=>c.id===j.companyId).name}`:''), value:j.id})).sort((a,b) => a.label.localeCompare(b.label)); }
    if(state.relatedType==='Coffee chat'){
      opts = db.chats.map(ch=>{
        const ct = db.contacts.find(c=>c.id===ch.contactId);
        const co = ct ? db.companies.find(c=>c.id===ct.companyId) : null;
        const label = (ct?ct.name:'Unknown') + (co? ` — ${co.name}`:'');
        return {label, value:ch.id};
      }).sort((a,b) => a.label.localeCompare(b.label));
    }
    if(state.relatedType==='Entrepreneurship'){ 
      opts = (db.ideas||[]).map(idea=>({label:idea.name||'Untitled', value:idea.id})).sort((a,b) => a.label.localeCompare(b.label)); 
    }
    if(!opts.length){ relHolder.appendChild(el('div',{},['No items found'])); state.relatedId=''; return; }
    opts.forEach(o=> sel.appendChild(el('option',{value:o.value},[o.label])));
    sel.value = state.relatedId || opts[0].value;
    state.relatedId = sel.value;
    sel.onchange = ()=> state.relatedId = sel.value;
    relHolder.appendChild(sel);
  }

  buildRelPicker();
  modal.open('Edit Action & Subtask', form);
}

function openAddSubtaskModal(action) {
  const form = el('div');
  
  // Show action info (read-only)
  const actionInfo = el('div', {class: 'action-info-section'});
  actionInfo.appendChild(el('h3', {style: 'margin:0 0 8px;font-size:14px;color:#374151;font-weight:600'}, ['Adding subtask to:']));
  actionInfo.appendChild(el('div', {style: 'padding:12px;background:#f8fafc;border-radius:6px;color:#6b7280;font-size:14px'}, [action.title || 'Untitled Action']));
  form.appendChild(actionInfo);
  
  // Subtask fields
  const subtaskSection = el('div', {class: 'subtasks-edit-section'});
  subtaskSection.appendChild(el('h3', {style: 'margin:16px 0 8px;font-size:14px;color:#374151;font-weight:600'}, ['New Subtask']));
  
  const subtaskRow = el('div', {class: 'subtask-edit-row'});
  
  // Title field
  const titleField = el('div', {class: 'subtask-field'});
  titleField.appendChild(el('label', {html: 'Title*'}));
  const titleInput = el('input', {type: 'text', placeholder: 'Enter subtask title'});
  titleField.appendChild(titleInput);
  subtaskRow.appendChild(titleField);
  
  // Date field
  const dateField = el('div', {class: 'subtask-field'});
  dateField.appendChild(el('label', {html: 'Due Date'}));
  const dateInput = el('input', {type: 'date'});
  dateField.appendChild(dateInput);
  subtaskRow.appendChild(dateField);
  
  // Notes field
  const notesField = el('div', {class: 'subtask-field-full'});
  notesField.appendChild(el('label', {html: 'Notes'}));
  const notesInput = el('textarea', {style: 'min-height:60px', placeholder: 'Add any notes or details...'});
  notesField.appendChild(notesInput);
  subtaskRow.appendChild(notesField);
  
  subtaskSection.appendChild(subtaskRow);
  form.appendChild(subtaskSection);
  
  // Actions
  const actions = el('div', {class: 'right'});
  const saveBtn = el('button', {class: 'btn-teal'}, ['Add Subtask']);
  const cancelBtn = el('button', {class: 'iconbtn'}, ['Cancel']);
  
  cancelBtn.onclick = () => modal.close();
  saveBtn.onclick = () => {
    if (!titleInput.value.trim()) {
      alert('Subtask title is required');
      return;
    }
    
    // Create new subtask
    const newSubtask = {
      id: uid('sub'),
      title: titleInput.value.trim(),
      due: dateInput.value || '',
      done: false, // Default to not completed
      notes: notesInput.value.trim()
    };
    
    // Add to action
    action.subactions = action.subactions || [];
    action.subactions.push(newSubtask);
    
    save();
    
    // Inline DOM: inject new subtask row using canonical builder so interactions work
    try{
      const card = document.querySelector(`.action-card[data-action-id="${action.id}"]`);
      if (card){
        let body = card.querySelector('.action-body');
        if (!body){ body = document.createElement('div'); body.className = 'action-body'; card.appendChild(body); }
        const companyId = (typeof d360GetCompanyIdForActionId==='function') ? d360GetCompanyIdForActionId(action.id) : (String(action.relatedType||'').toLowerCase()==='company' ? action.relatedId : '');
        const rowEl = (typeof d360_makeSubRow==='function') ? d360_makeSubRow(action, newSubtask, { id: companyId }) : null;
        if (rowEl) body.appendChild(rowEl);
        // Update header progress text
        if (typeof computeActionStatus==='function'){
          const meta = computeActionStatus(action);
          const progress = card.querySelector('.progress-text');
          if (progress) progress.textContent = `${meta.done} of ${meta.total} completed`;
        }
      }
    }catch(_){ }
    
    modal.close();
    
    // Avoid global render; keep page stable
    if (currentTab === 'ideas') {
      // Store scroll position and open idea cards
      const scrollPosition = window.scrollY;
      const openIdeaIds = [];
      document.querySelectorAll('.idea.open').forEach(idea => {
        openIdeaIds.push(idea.getAttribute('data-idea-id'));
      });
      
      renderIdeas();
      
      // Restore scroll position and open idea cards
      setTimeout(() => {
        window.scrollTo(0, scrollPosition);
        openIdeaIds.forEach(ideaId => {
          const ideaCard = document.querySelector(`[data-idea-id="${ideaId}"]`);
          if (ideaCard) {
            ideaCard.classList.add('open');
            const detailsBtn = ideaCard.querySelector('.details-btn');
            if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
          }
        });
      }, 10);
    } else if (currentView === 'calendar') {
      refreshCalendar();
    } else if (currentTab === 'actions') {
      render();
    } else {
      render();
    }
  };
  
  actions.appendChild(cancelBtn);
  actions.appendChild(saveBtn);
  form.appendChild(actions);
  
  modal.open('Add New Subtask', form);
}

function openSubtaskExpandModal(action, subtask) {
  // Expand modal showing action + only this subtask
  const todayStr = ()=> { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; };
  function computeStatus(act){
    const total = 1; // Only this subtask
    const done = subtask.done ? 1 : 0;
    const status = done === total ? 'Done' : done > 0 ? 'In progress' : 'To do';
    return {status, done, total};
  }
  const hasOverdue = () => !subtask.done && subtask.due && subtask.due < todayStr();

  function render(){
    const {status, done, total} = computeStatus(action);

    const card = el('div',{class:'action-card'});

    // head - clean layout matching original card
    const head = el('div',{class:'action-head-expanded'});
    
    // Top row: Title (2/3) + Status (1/3)
    const topRow = el('div',{class:'expand-top-row'});
    
    // Title container - 2/3 width
    const titleContainer = el('div',{class:'expand-title-section'});
    const title = el('div',{class:'expand-title'});
    title.textContent = action.title || '';
    titleContainer.appendChild(title);
    topRow.appendChild(titleContainer);
    
    // Status container - 1/3 width, same style as card
    const statusContainer = el('div',{class:'expand-status-section'});
    const statusContent = el('div',{class:'expand-status-content'});
    statusContent.appendChild(el('span',{class:`badge ${status==='Done'?'done':status==='In progress'?'progress':'todo'}`},[status]));
    statusContent.appendChild(el('span',{class:'progress-text'},[`${done} of ${total} completed`]));
    if(hasOverdue()) statusContent.appendChild(el('span',{class:'badge overdue'},['Overdue']));
    statusContainer.appendChild(statusContent);
    topRow.appendChild(statusContainer);
    
    head.appendChild(topRow);
    
    // Relation - same style as card
    const relationContainer = el('div',{class:'expand-relation'});
    relationContainer.appendChild(el('div',{class:'relation-line'},[ getRelationText(action) ]));
    head.appendChild(relationContainer);
    
    // Description - full width, complete text
    const fullDesc = (action.description||'').trim();
    if(fullDesc) {
      const descContainer = el('div',{class:'expand-description-section'});
      descContainer.appendChild(el('div',{class:'desc-one'},[
        el('span',{class:'label'},['Description:']),
        el('span',{class:'text'},[fullDesc])
      ]));
      head.appendChild(descContainer);
    }

    card.appendChild(head);

    // body: only this subtask
    const body = el('div',{class:'action-body'});
    const subtaskContainer = el('div',{class:'subtask-expanded'});
    
    // Main subtask row
    const row = el('div',{class:'sub-row'});

    const cb = el('input',{type:'checkbox','aria-label':`Mark "${subtask.title}" completed`});
    cb.checked = !!subtask.done;
    cb.disabled = true; // Read-only
    row.appendChild(cb);

    const titleEl = el('span',{class:'sub-title'+(subtask.done?' sub-completed':'')},[subtask.title||'']);
    row.appendChild(titleEl);

    const due = el('span',{class:'due-pill'},[ subtask.due ? fmtDate(subtask.due) : '—' ]);
    row.appendChild(due);

    const overdue = !subtask.done && subtask.due && subtask.due < todayStr();
    if(overdue){ titleEl.classList.add('sub-overdue'); due.classList.add('sub-overdue'); }

    subtaskContainer.appendChild(row);
    
    // Complete notes below subtask
    const notes = (subtask.notes||'').trim();
    if(notes) {
      const notesRow = el('div',{class:'subtask-notes'});
      notesRow.appendChild(el('span',{class:'label'},['Notes:']));
      notesRow.appendChild(el('span',{class:'text'},[notes]));
      subtaskContainer.appendChild(notesRow);
    }
    
    body.appendChild(subtaskContainer);
    card.appendChild(body);

    // write into the modal body
    modal.body.innerHTML = '';
    modal.body.appendChild(card);
  }

  // Add data attribute to hide close button
  modal.open('Subtask — Complete View', el('div'));
  const modalElement = document.querySelector('.modal');
  if(modalElement) {
    modalElement.setAttribute('data-modal-type', 'expand');
  }
  
  // Add ESC key to close
  const handleEsc = (e) => {
    if(e.key === 'Escape') {
      modal.close();
      document.removeEventListener('keydown', handleEsc);
    }
  };
  document.addEventListener('keydown', handleEsc);
  
  // Add click outside to close
  const backdrop = document.querySelector('.modal-backdrop');
  if(backdrop) {
    backdrop.onclick = (e) => {
      if(e.target === backdrop) {
        modal.close();
        document.removeEventListener('keydown', handleEsc);
      }
    };
  }
  
  render();
}

/* ---------------- Entrepreneurship Ideas Module ---------------- */
function viewIdeas(){
  const wrap = el('div',{class:'ideas-module'});
  
  // Initialize ideas if not exists
  if (!db.ideas) {
    db.ideas = [];
    save();
  }
  
  // Module header with toggle
  const moduleHeader = el('div',{class:'module-header'});
  
  // Dashboard 360 toggle - positioned at top-right
  const dash360Toggle = el('div',{id:'dash360-toggle',class:'dash360-toggle','aria-label':'Dashboard view switch'});
  const companyBtn = el('button',{id:'dash360-toggle-company',class:'dash360-tab is-active',type:'button'},['Company Dashboard']);
  const entreBtn = el('button',{id:'dash360-toggle-entre',class:'dash360-tab',type:'button'},['Entrepreneurship Dashboard']);
  dash360Toggle.appendChild(companyBtn);
  dash360Toggle.appendChild(entreBtn);
  
  moduleHeader.appendChild(dash360Toggle);
  wrap.appendChild(moduleHeader);
  
  // Toolbar matching the HTML example
  const toolbar = el('div',{class:'toolbar'});
  
  // Search with icon
  const searchDiv = el('div',{class:'search'});
  const searchIcon = el('span',{class:'ico'},['🔎']);
  const searchInput = el('input',{type:'search',placeholder:"Search by idea's title, description and investigation notes…"});
  searchDiv.appendChild(searchIcon);
  searchDiv.appendChild(searchInput);
  
  // Show favorite toggle
  const switchLabel = el('label',{class:'switch ideas-switch'});
  const favoriteCheckbox = el('input',{type:'checkbox', class:'ideas-checkbox'});
  switchLabel.appendChild(favoriteCheckbox);
  switchLabel.appendChild(el('span',{},['Show Favorite']));
  
  // Add idea button
  const addBtn = el('button',{class:'btn-teal'},['+ New idea']);
  
  toolbar.appendChild(searchDiv);
  toolbar.appendChild(switchLabel);
  toolbar.appendChild(addBtn);
  wrap.appendChild(toolbar);
  
  // Ideas list
  const ideasList = el('div',{class:'list'});
  wrap.appendChild(ideasList);
  
  // Event handlers
  let searchText = '';
  let showFavoriteOnly = false;
  
  searchInput.oninput = () => {
    searchText = searchInput.value;
    renderIdeas();
  };
  
  favoriteCheckbox.onchange = () => {
    showFavoriteOnly = favoriteCheckbox.checked;
    renderIdeas();
  };
  
  addBtn.onclick = () => openNewIdea();
  
  // Touch function to update timestamps
  function touch(idea) {
    idea.updatedAt = new Date().toISOString();
    save();
  }
  
  // Render function
  function renderIdeas() {
    const scrollPosition = window.scrollY;
    const openIdeaIds = Array.from(document.querySelectorAll('.idea.open')).map(el => el.getAttribute('data-idea-id'));
    ideasList.innerHTML = '';
    const query = searchText.toLowerCase();
    
    let filteredIdeas = db.ideas
      .filter(i => showFavoriteOnly ? i.starred : true)
      .filter(i => !query ? true : (
        (i.name||'').toLowerCase().includes(query) || 
        (i.description||'').toLowerCase().includes(query) || 
        ((i.investigations||[]).map(x=>x.text).join(' ').toLowerCase()).includes(query)
      ))
      .sort((a,b) => (b.updatedAt||'').localeCompare(a.updatedAt||''));
    
    if (!filteredIdeas.length) {
      ideasList.appendChild(el('div',{class:'muted',style:'text-align:center;padding:30px'},[
        'No ideas yet. Click ', 
        el('span',{style:'font-weight:800'},['"➕ New idea"']), 
        ' to start. 💡'
      ]));
      setTimeout(() => { window.scrollTo(0, scrollPosition); }, 0);
      return;
    }
    
    filteredIdeas.forEach(idea => {
      ideasList.appendChild(createIdeaCard(idea));
    });
    setTimeout(() => {
      openIdeaIds.forEach(ideaId => {
        const ideaCard = document.querySelector(`[data-idea-id="${ideaId}"]`);
        if (ideaCard) {
          ideaCard.classList.add('open');
          const detailsBtn = ideaCard.querySelector('.details-btn');
          if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
        }
      });
      window.scrollTo(0, scrollPosition);
    }, 0);
  }
  
  // Make local Ideas renderer available to global helpers (prevents full-page re-render)
  window.renderIdeasLocal = renderIdeas;
  
  // Create idea card matching the HTML example
  function createIdeaCard(idea) {
    const card = el('div',{class:'idea' + (idea.archived ? ' archived' : ''), 'data-idea-id': idea.id});
    
    // Header - restructured as requested
    const head = el('div',{class:'idea-head-new'});
    
    // 1. Emoji button with better modal
    const emojiBtn = el('button',{class:'emoji-btn',title:'Change emoji'},[idea.icon||'💡']);
    emojiBtn.onclick = () => openEmojiModal(idea);
    
    // 2. Description (title) input - editable inline
    const titleInput = el('input',{class:'title-description',value:idea.name||'',placeholder:'Untitled idea…'});
    titleInput.oninput = () => {
      idea.name = titleInput.value;
      touch(idea);
    };
    titleInput.onblur = () => {
      if (!titleInput.value.trim()) {
        titleInput.value = 'Untitled idea';
        idea.name = 'Untitled idea';
        touch(idea);
      }
    };
    
    // 3. Details button with down arrow
    const detailsBtn = el('button',{class:'details-btn',title:'Show/Hide Details'},['Details ▼']);
    detailsBtn.onclick = () => {
      card.classList.toggle('open');
      detailsBtn.innerHTML = card.classList.contains('open') ? 'Hide ▲' : 'Details ▼';
    };
    
    // 4. Star (bigger) - fix star bug with unique handler
    const star = el('span',{class:'star-big',title:'Favorite'},[idea.starred ? '⭐' : '☆']);
    star.onclick = (e) => {
      e.stopPropagation();
      idea.starred = !idea.starred;
      star.textContent = idea.starred ? '⭐' : '☆';
      touch(idea);
    };
    
    // 5. Delete X button (top right) - positioned absolutely
    const deleteBtn = el('button',{class:'delete-x',title:'Delete idea'},['×']);
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      openDeleteModal(idea);
    };
    
    head.appendChild(emojiBtn);
    head.appendChild(titleInput);
    head.appendChild(detailsBtn);
    head.appendChild(star);
    head.appendChild(deleteBtn);
    
    card.appendChild(head);
    
    // Expandable body
    const body = el('div',{class:'idea-body'});
    
    // Description section
    const descSection = createSection('📝 Description');
    const descCard = el('div', {class: 'input-card'});
    const descArea = el('textarea',{placeholder:'Write freely. What is the idea? Why now? Who cares?', style: 'width: 100%; min-height: 80px; border: none; outline: none; resize: vertical; font-family: inherit;'});
    descArea.value = idea.description||'';
    descArea.oninput = () => {
      idea.description = descArea.value;
      touch(idea);
    };
    descCard.appendChild(descArea);
    descSection.appendChild(descCard);
    body.appendChild(descSection);
    
    // Investigation log
    const invSection = createSection('🔎 Investigation log');
    const invList = el('div',{class:'stack'});
    
    // Show default blank investigation note if no data
    if (!(idea.investigations||[]).length) {
      if (!idea.investigations) idea.investigations = [];
      const defaultItem = {id:uid('inv'), date:new Date().toISOString().slice(0,10), text:'', link:''};
      idea.investigations.push(defaultItem);
    }
    
    (idea.investigations||[]).forEach(x => invList.appendChild(createInvRow(idea, x, card)));
    invSection.appendChild(invList);
    const addInvBtn = el('button',{class:'add-inv-btn'},['+ Add investigation note']);
    addInvBtn.onclick = (e) => {
      e.stopPropagation();
      const item = {id:uid('inv'), date:new Date().toISOString().slice(0,10), text:'', link:''};
      idea.investigations = idea.investigations || [];
      idea.investigations.unshift(item);
      touch(idea);
      
      // Add the new investigation note directly to the DOM for natural feel
      const newRow = createInvRow(idea, item, card);
      invList.insertBefore(newRow, invList.firstChild);
      
      // Focus on the new textarea immediately
      const newTextarea = newRow.querySelector('.inv-text-compact');
      if (newTextarea) {
        newTextarea.focus();
      }
    };
    invSection.appendChild(addInvBtn);
    body.appendChild(invSection);
    
    // Contacts section (associations only)
    const contactsSection = createSection('👥 Contacts');
    const contactsList = el('div',{class:'stack'});
    
    // Ensure storage
    idea.contactIds = idea.contactIds || [];
    
    function renderContactsList(){
      contactsList.innerHTML = '';
      if(!(idea.contactIds||[]).length){
        contactsList.appendChild(el('div',{class:'muted'},['No contacts linked']));
      } else {
        idea.contactIds.forEach(cid=>{
          const c = db.contacts.find(x=>x.id===cid);
          const co = c ? db.companies.find(co=>co.id===c.companyId) : null;
          
          const card = el('div',{
            class:'input-card',
            style:'background:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);border-left:4px solid #0ea5e9;padding:16px;margin-bottom:8px;display:flex;gap:20px;position:relative'
          });

          // Remove button (top right corner)
          const removeBtn = el('button',{
            class:'delete-btn',
            title:'Remove from this idea',
            style:'position:absolute;top:8px;right:8px;background:none;border:none;color:#6b7280;font-size:16px;cursor:pointer;width:20px;height:20px;display:flex;align-items:center;justify-content:center'
          },['×']);
          removeBtn.onclick = (e)=>{
            e.stopPropagation();
            idea.contactIds = (idea.contactIds||[]).filter(id=>id!==cid);
            touch(idea);
            save();
            // Re-render preserving open card
            const wasOpen = card.classList.contains('open');
            renderIdeas();
            if (wasOpen) {
              setTimeout(()=>{
                const newCard = document.querySelector(`[data-idea-id="${idea.id}"]`);
                if(newCard){
                  newCard.classList.add('open');
                  const detailsBtn = newCard.querySelector('.details-btn');
                  if(detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
                }
              },10);
            }
          };
          card.appendChild(removeBtn);

          // Left column (1/3) - Contact info
          const leftColumn = el('div',{
            style:'flex:0 0 33.33%;min-width:0'
          });

          // Contact name (bold, large)
          const contactName = el('div',{
            style:'font-weight:700;font-size:16px;color:#1e293b;margin-bottom:8px'
          },[c? (c.name||'Unknown contact') : 'Unknown contact']);
          leftColumn.appendChild(contactName);

          // Role with icon
          const roleRow = el('div',{
            style:'display:flex;align-items:center;margin-bottom:6px'
          });
          roleRow.appendChild(el('span',{style:'color:#64748b;margin-right:6px'},['👔']));
          roleRow.appendChild(el('span',{style:'font-weight:600;color:#475569'},[c?.role || '—']));
          leftColumn.appendChild(roleRow);

          // Company with icon
          const companyRow = el('div',{
            style:'display:flex;align-items:center;margin-bottom:6px'
          });
          companyRow.appendChild(el('span',{style:'color:#64748b;margin-right:6px'},['🏢']));
          companyRow.appendChild(el('span',{style:'font-weight:600;color:#475569'},[co? co.name : '—']));
          leftColumn.appendChild(companyRow);

          // Relationship with icon
          const relationshipRow = el('div',{
            style:'display:flex;align-items:center;margin-bottom:6px'
          });
          relationshipRow.appendChild(el('span',{style:'color:#64748b;margin-right:6px'},['🤝']));
          relationshipRow.appendChild(el('span',{style:'font-weight:600;color:#475569'},[c?.relationship || '—']));
          leftColumn.appendChild(relationshipRow);

          // LinkedIn with icon
          const linkedinRow = el('div',{
            style:'display:flex;align-items:center'
          });
          linkedinRow.appendChild(el('span',{style:'color:#64748b;margin-right:6px'},['💼']));
          if(c?.linkedin && c.linkedin.trim()){
            const linkedinLink = el('a',{
              href: c.linkedin.startsWith('http') ? c.linkedin : `https://linkedin.com/in/${c.linkedin}`,
              target: '_blank',
              style:'font-weight:600;color:#0ea5e9;text-decoration:none'
            },[c.linkedin]);
            linkedinRow.appendChild(linkedinLink);
          } else {
            linkedinRow.appendChild(el('span',{style:'font-weight:600;color:#475569'},['—']));
          }
          leftColumn.appendChild(linkedinRow);

          card.appendChild(leftColumn);

          // Right column (2/3) - Notes
          const rightColumn = el('div',{
            style:'flex:1;min-width:0;border-left:1px solid #e2e8f0;padding-left:20px'
          });

          // Notes title
          const notesTitle = el('div',{
            style:'font-weight:700;font-size:14px;color:#1e293b;margin-bottom:8px'
          },['Notes']);
          rightColumn.appendChild(notesTitle);

          // Notes content
          const notesContent = el('div',{
            style:'color:#475569;line-height:1.5;font-size:14px;white-space:pre-wrap'
          },[c?.notes || 'No notes available']);
          rightColumn.appendChild(notesContent);

          card.appendChild(rightColumn);

          contactsList.appendChild(card);
        });
      }
    }
    renderContactsList();
    contactsSection.appendChild(contactsList);
    
    const addContactBtn = el('button',{class:'add-link-btn'},['+ Add contact']);
    addContactBtn.onclick = (e)=>{
      e.stopPropagation();
      const box = el('div');
      box.appendChild(el('div',{class:'muted',style:'margin-bottom:8px'},['Select a contact to associate with this idea']));
      const sel = el('select',{style:'width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px'});
      const available = db.contacts.filter(c=>!(idea.contactIds||[]).includes(c.id));
      if(!available.length){
        box.appendChild(el('div',{class:'muted'},['All contacts are already linked']));
      } else {
        available.map(c=>({label:c.name||'—', value:c.id}))
          .sort((a,b)=> a.label.localeCompare(b.label))
          .forEach(o=> sel.appendChild(el('option',{value:o.value},[o.label])));
        box.appendChild(sel);
      }
      const actions = el('div',{style:'display:flex;gap:8px;justify-content:flex-end;margin-top:12px'});
      const cancel = el('button',{class:'iconbtn'},['Cancel']); cancel.onclick = ()=> modal.close();
      const addBtn = el('button',{class:'btn-teal'},['Add']);
      addBtn.onclick = ()=>{
        if(!available.length) return modal.close();
        const chosen = sel.value;
        if(chosen){
          idea.contactIds = idea.contactIds || [];
          if(!idea.contactIds.includes(chosen)) idea.contactIds.push(chosen);
          touch(idea); save();
          // Re-render preserving open state
          const wasOpen = card.classList.contains('open');
          renderIdeas();
          if (wasOpen) {
            setTimeout(()=>{
              const newCard = document.querySelector(`[data-idea-id="${idea.id}"]`);
              if(newCard){
                newCard.classList.add('open');
                const detailsBtn = newCard.querySelector('.details-btn');
                if(detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
              }
            },10);
          }
        }
        modal.close();
      };
      actions.appendChild(cancel); actions.appendChild(addBtn); box.appendChild(actions);
      modal.open('Add contact to idea', box);
    };
    contactsSection.appendChild(addContactBtn);
    body.appendChild(contactsSection);
    
    // Coffee chats (read-only)
    const chatsSection = createSection('☕ Coffee chats');
    const chatsList = el('div',{class:'stack'});
    const ideaChats = (db.chats||[]).filter(ch=> (ch.chatType==='entrepreneurship') && ch.ideaId===idea.id);

    function createChatInfoCard(chat){
      const contact = db.contacts.find(c=>c.id===chat.contactId);
      const company = (function(){
        const co = contact ? db.companies.find(c=>c.id===contact.companyId) : null;
        return co ? co.name : '—';
      })();
      const scheduled = chat.dateScheduled ? fmtDate(chat.dateScheduled) : '—';
      const channel = chat.channel==='other' ? (chat.channelOther||'Other') : (chat.channel||'—');
      const status = chat.status || '—';

      const card = el('div',{
        class:'input-card',
        style:'background:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);border-left:4px solid #0ea5e9;padding:16px;margin-bottom:8px;display:flex;gap:20px'
      });

      // Left column (1/3) - Contact info
      const leftColumn = el('div',{
        style:'flex:0 0 33.33%;min-width:0'
      });

      // Contact name (bold, large)
      const contactName = el('div',{
        style:'font-weight:700;font-size:16px;color:#1e293b;margin-bottom:8px'
      },[contact? (contact.name||'Unknown contact') : 'Unknown contact']);
      leftColumn.appendChild(contactName);

      // Company row with icon
      const companyRow = el('div',{
        style:'display:flex;align-items:center;margin-bottom:6px'
      });
      companyRow.appendChild(el('span',{style:'color:#64748b;margin-right:6px'},['🏢']));
      companyRow.appendChild(el('span',{style:'font-weight:600;color:#475569'},[company]));
      leftColumn.appendChild(companyRow);

      // Status with colored pill
      const statusRow = el('div',{
        style:'display:flex;align-items:center;margin-bottom:6px'
      });
      statusRow.appendChild(el('span',{style:'color:#64748b;margin-right:6px'},['📊']));
      const statusColor = status === 'Completed' ? '#10b981' : status === 'Scheduled' ? '#f59e0b' : '#6b7280';
      const statusPill = el('span',{
        style:`background:${statusColor};color:white;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:600`
      },[status]);
      statusRow.appendChild(statusPill);
      leftColumn.appendChild(statusRow);

      // Schedule with icon
      const scheduleRow = el('div',{
        style:'display:flex;align-items:center;margin-bottom:6px'
      });
      scheduleRow.appendChild(el('span',{style:'color:#64748b;margin-right:6px'},['📅']));
      scheduleRow.appendChild(el('span',{style:'font-weight:600;color:#475569'},[scheduled]));
      leftColumn.appendChild(scheduleRow);

      // Channel with icon
      const channelRow = el('div',{
        style:'display:flex;align-items:center'
      });
      const channelIcon = channel.toLowerCase().includes('zoom') ? '💻' : 
                         channel.toLowerCase().includes('phone') ? '📞' : 
                         channel.toLowerCase().includes('person') ? '🤝' : '💬';
      channelRow.appendChild(el('span',{style:'color:#64748b;margin-right:6px'},[channelIcon]));
      channelRow.appendChild(el('span',{style:'font-weight:600;color:#475569'},[channel]));
      leftColumn.appendChild(channelRow);

      card.appendChild(leftColumn);

      // Right column (2/3) - Notes
      const rightColumn = el('div',{
        style:'flex:1;min-width:0;border-left:1px solid #e2e8f0;padding-left:20px'
      });

      // Notes title
      const notesTitle = el('div',{
        style:'font-weight:700;font-size:14px;color:#1e293b;margin-bottom:8px'
      },['Notes']);
      rightColumn.appendChild(notesTitle);

      // Notes content
      const notesContent = el('div',{
        style:'color:#475569;line-height:1.5;font-size:14px;white-space:pre-wrap'
      },[chat.notes || 'No notes available']);
      rightColumn.appendChild(notesContent);

      card.appendChild(rightColumn);

      return card;
    }

    if(!ideaChats.length){
      chatsList.appendChild(el('div',{class:'muted'},['No coffee chats for this idea']));
    } else {
      ideaChats.slice()
        .sort((a,b)=> (b.dateScheduled||'').localeCompare(a.dateScheduled||''))
        .forEach(ch=> chatsList.appendChild(createChatInfoCard(ch)));
    }

    chatsSection.appendChild(chatsList);
    body.appendChild(chatsSection);
    
    // Next steps - integrated with next action module
    const stepsSection = createSection('✅ Next steps');
    
    // Info note about Next Actions integration
    const infoNote = el('div', {class: 'info-note'}, [
      '💡 These actions are also visible in the ',
      el('strong', {}, ['Next Actions']),
      ' module'
    ]);
    stepsSection.appendChild(infoNote);
    
    // Container for action cards (same design as Next Actions)
    const actionsContainer = el('div', {class: 'idea-actions-container na-v16'});
    
    // Show related actions from the next action module
    const relatedActions = (db.actions||[]).filter(a => 
      a.relatedType === 'Entrepreneurship' && a.relatedId === idea.id
    );
    
    if (relatedActions.length > 0) {
      relatedActions.forEach(action => {
        // Create action card using the same function as Next Actions module
        const actionCard = createIdeaActionCard(action, idea);
        actionsContainer.appendChild(actionCard);
      });
    } else {
      const emptyState = el('div', {class: 'empty-state'}, [
        el('div', {class: 'empty-icon'}, ['📋']),
        el('div', {class: 'empty-text'}, ['No next steps yet']),
        el('div', {class: 'empty-subtext'}, ['Add your first step below to get started'])
      ]);
      actionsContainer.appendChild(emptyState);
    }
    
    stepsSection.appendChild(actionsContainer);
    
    // Add new action button - opens the same modal as other modules
    const addActionBtn = el('button',{class:'add-action-btn'},['+ Add next action']);
    
    // Open action creation modal with entrepreneurship relationship
    addActionBtn.onclick = (e) => {
      e.stopPropagation();
      openActionCreateModal({
        relatedType: 'Entrepreneurship',
        relatedId: idea.id
      });
    };
    
    stepsSection.appendChild(addActionBtn);
    body.appendChild(stepsSection);
    
    // Follow up section - REMOVED per requirements
    
    // Links
    const linksSection = createSection('🔗 Useful links');
    linksSection.classList.add('links-section');
    const linksList = el('div',{class:'stack'});
    
    // Show default blank link if no data
    if (!(idea.links||[]).length) {
      if (!idea.links) idea.links = [];
      const defaultLink = {id:uid('link'), label:'', url:''};
      idea.links.push(defaultLink);
    }
    
    (idea.links||[]).forEach(L => linksList.appendChild(createLinkRow(idea, L, card)));
    linksSection.appendChild(linksList);
    const addLinkBtn = el('button',{class:'add-link-btn'},['+ Add useful link']);
    addLinkBtn.onclick = (e) => {
      e.stopPropagation();
      const L = {id:uid('lnk'), label:'', url:''};
      idea.links = idea.links || [];
      idea.links.push(L);
      touch(idea);
      
      // Re-render without closing the details
      const wasOpen = card.classList.contains('open');
      renderIdeas();
      if (wasOpen) {
        setTimeout(() => {
          const newCard = document.querySelector(`[data-idea-id="${idea.id}"]`);
          if (newCard) {
            newCard.classList.add('open');
            const detailsBtn = newCard.querySelector('.details-btn');
            if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
            
            // Focus on the new link input
            const linkInputs = newCard.querySelectorAll('.links-section input[placeholder*="Label"]');
            if (linkInputs.length > 0) {
              linkInputs[linkInputs.length - 1].focus();
            }
          }
        }, 10);
      }
    };
    linksSection.appendChild(addLinkBtn);
    body.appendChild(linksSection);
    
    card.appendChild(body);
    return card;
  }
  
  // Helper functions
  function createSection(title) {
    const box = el('div',{class:'section'});
    box.appendChild(el('h4',{},[title]));
    return box;
  }
  
  function createInvRow(idea, item, card) {
    const row = el('div',{class:'inv-row'});
    
    // Define createUrlInput function first
    function createUrlInput() {
      const linkInput = el('input',{type:'url',placeholder:'Optional URL (https://...)', class:'inv-link-compact'});
      linkInput.value = item.link||'';
      linkInput.onblur = () => {
        item.link = linkInput.value;
        touch(idea);
        // Update display without full re-render to avoid scroll jump
        if (linkInput.value.trim()) {
          urlContainer.innerHTML = '';
          const linkDisplay = el('a',{
            href: item.link,
            target: '_blank',
            class: 'inv-link-display',
            title: item.link
          }, [item.link.length > 30 ? item.link.substring(0, 30) + '...' : item.link]);
          
          const editBtn = el('button',{class:'inv-edit-url',title:'Edit URL'},['✏️']);
          editBtn.onclick = (e) => {
            e.stopPropagation();
            urlContainer.innerHTML = '';
            urlContainer.appendChild(createUrlInput());
          };
          
          urlContainer.appendChild(linkDisplay);
          urlContainer.appendChild(editBtn);
        }
      };
      linkInput.oninput = () => {
        item.link = linkInput.value;
        touch(idea);
      };
      return linkInput;
    }
    
    // Single content area with all fields in compact layout
    const content = el('div',{class:'inv-content-compact'});
    
    // Top row with date and URL
    const topRow = el('div',{class:'inv-top-row'});
    
    // Date input (narrow)
    const dateInput = el('input',{type:'date',value:item.date||'', class:'inv-date-compact'});
    dateInput.onchange = () => {
      item.date = dateInput.value;
      touch(idea);
    };
    
    // URL display/input combo
    const urlContainer = el('div',{class:'inv-url-container'});
    
    if (item.link && item.link.trim()) {
      // Show clickable link if URL exists
      const linkDisplay = el('a',{
        href: item.link,
        target: '_blank',
        class: 'inv-link-display',
        title: item.link
      }, [item.link.length > 30 ? item.link.substring(0, 30) + '...' : item.link]);
      
      const editBtn = el('button',{class:'inv-edit-url',title:'Edit URL'},['✏️']);
      editBtn.onclick = (e) => {
        e.stopPropagation();
        urlContainer.innerHTML = '';
        urlContainer.appendChild(createUrlInput());
      };
      
      urlContainer.appendChild(linkDisplay);
      urlContainer.appendChild(editBtn);
    } else {
      // Show input if no URL
      urlContainer.appendChild(createUrlInput());
    }
    
    topRow.appendChild(dateInput);
    topRow.appendChild(urlContainer);
    
    // Text area (full width)
    const textArea = el('textarea',{placeholder:'What did you read/watch/learn? Add notes here…', class:'inv-text-compact'});
    textArea.value = item.text||'';
    textArea.oninput = () => {
      item.text = textArea.value;
      touch(idea);
    };
    
    // Delete button
    const deleteBtn = el('button',{class:'inv-delete',title:'Delete note'},['×']);
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      openDeleteInvestigationModal(idea, item, card);
    };
    
    content.appendChild(topRow);
    content.appendChild(textArea);
    row.appendChild(content);
    row.appendChild(deleteBtn);
    
    return row;
  }
  
  // createStepRow function removed - now using integrated actions
  
  function createLinkRow(idea, link, card) {
    const row = el('div',{class:'link-row'});
    
    // Define createUrlInput function first
    function createUrlInput() {
      const urlInput = el('input',{type:'url',placeholder:'https://…', class:'link-url-compact'});
      urlInput.value = link.url||'';
      urlInput.onblur = () => {
        link.url = urlInput.value;
        touch(idea);
        // Update display without full re-render
        if (urlInput.value.trim()) {
          urlContainer.innerHTML = '';
          const linkDisplay = el('a',{
            href: link.url,
            target: '_blank',
            class: 'link-url-display',
            title: link.url
          }, [link.url.length > 30 ? link.url.substring(0, 30) + '...' : link.url]);
          
          const editBtn = el('button',{class:'link-edit-url',title:'Edit URL'},['✏️']);
          editBtn.onclick = (e) => {
            e.stopPropagation();
            urlContainer.innerHTML = '';
            urlContainer.appendChild(createUrlInput());
          };
          
          urlContainer.appendChild(linkDisplay);
          urlContainer.appendChild(editBtn);
        }
      };
      urlInput.oninput = () => {
        link.url = urlInput.value;
        touch(idea);
      };
      return urlInput;
    }
    
    // Single content area with compact layout
    const content = el('div',{class:'link-content-compact'});
    
    // Top row with label and URL
    const topRow = el('div',{class:'link-top-row'});
    
    // Label input (smaller)
    const labelInput = el('input',{type:'text',placeholder:'Label', class:'link-label-compact'});
    labelInput.value = link.label||'';
    labelInput.oninput = () => {
      link.label = labelInput.value;
      touch(idea);
    };
    
    // URL display/input combo
    const urlContainer = el('div',{class:'link-url-container'});
    
    if (link.url && link.url.trim()) {
      // Show clickable link if URL exists
      const linkDisplay = el('a',{
        href: link.url,
        target: '_blank',
        class: 'link-url-display',
        title: link.url
      }, [link.url.length > 30 ? link.url.substring(0, 30) + '...' : link.url]);
      
      const editBtn = el('button',{class:'link-edit-url',title:'Edit URL'},['✏️']);
      editBtn.onclick = (e) => {
        e.stopPropagation();
        urlContainer.innerHTML = '';
        urlContainer.appendChild(createUrlInput());
      };
      
      urlContainer.appendChild(linkDisplay);
      urlContainer.appendChild(editBtn);
    } else {
      // Show input if no URL
      urlContainer.appendChild(createUrlInput());
    }
    
    topRow.appendChild(labelInput);
    topRow.appendChild(urlContainer);
    
    // Delete button
    const deleteBtn = el('button',{class:'link-delete',title:'Delete link'},['×']);
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      openDeleteLinkModal(idea, link, card);
    };
    
    content.appendChild(topRow);
    row.appendChild(content);
    row.appendChild(deleteBtn);
    
    return row;
  }
  
  function openNewIdea() {
    const idea = {
      id: uid('idea'),
      icon: '💡',
      name: 'New idea',
      description: '',
      investigations: [],
      steps: [],
      links: [],
      archived: false,
      starred: false,
      followUp: '',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    db.ideas.unshift(idea);
    save();
    renderIdeas();
  }
  
  // Emoji selection modal
  function openEmojiModal(idea) {
    const availableEmojis = [
      '💡', '🚀', '🤖', '📚', '🎯', '⚡', '🔥', '💎', '🌟', '🎨',
      '🏆', '🔮', '🌈', '⭐', '💰', '🎪', '🎭', '🎵', '🎬', '🎮',
      '🔧', '⚙️', '🔬', '🧪', '💻', '📱', '🖥️', '⌚', '📡', '🛸'
    ];
    
    let selectedEmoji = idea.icon || '💡';
    
    const modalContent = el('div', {class: 'emoji-modal'});
    modalContent.appendChild(el('h3', {style: 'margin: 0 0 16px; color: #374151;'}, ['Choose an emoji for your idea']));
    
    const emojiGrid = el('div', {class: 'emoji-grid'});
    availableEmojis.forEach(emoji => {
      const emojiBtn = el('button', {class: 'emoji-option' + (emoji === selectedEmoji ? ' selected' : '')}, [emoji]);
      emojiBtn.onclick = () => {
        // Remove selected class from all buttons
        emojiGrid.querySelectorAll('.emoji-option').forEach(btn => btn.classList.remove('selected'));
        // Add selected class to clicked button
        emojiBtn.classList.add('selected');
        selectedEmoji = emoji;
      };
      emojiGrid.appendChild(emojiBtn);
    });
    
    modalContent.appendChild(emojiGrid);
    
    const actions = el('div', {class: 'right', style: 'margin-top: 16px;'});
    const acceptBtn = el('button', {class: 'btn-teal'}, ['Accept']);
    acceptBtn.onclick = () => {
      idea.icon = selectedEmoji;
      touch(idea);
      renderIdeas();
      modal.close();
    };
    actions.appendChild(acceptBtn);
    modalContent.appendChild(actions);
    
    modal.open('Select Emoji', modalContent);
  }
  
  // Create action card for ideas (same design as Next Actions module)
  function createIdeaActionCard(action, idea) {
    const {status, done, total} = computeActionStatus(action);
    const card = el('div',{class:'action-card idea-action-card'});

    /* head */
    const head = el('div',{class:'action-head'});

    // TOP ROW: Title + Status + Actions (all on same line)
    const topRow = el('div',{class:'action-top-row'});
    
    // contenteditable title (left side)
    const title = el('div',{class:'action-title','aria-label':'Action title', contenteditable:'true'});
    title.textContent = action.title || '';
    title.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); } }); 
    let tdeb;
    title.oninput = ()=>{
        clearTimeout(tdeb);
        title.classList.add('editing');
        const v = title.textContent;
        tdeb = setTimeout(()=>{ action.title = v; save(); title.classList.remove('editing'); },150);
    };
    topRow.appendChild(title);

    // Status and actions (right side)
    const right = el('div',{class:'head-right'});
    right.appendChild(el('span',{class:`badge ${status==='Done'?'done':status==='In progress'?'progress':'todo'}`},[status]));
    right.appendChild(el('span',{class:'progress-text'},[`${done} of ${total} completed`]));
    if(hasActionOverdue(action)) right.appendChild(el('span',{class:'badge overdue'},['Overdue']));

    const icons = el('span',{class:'head-icons'});
    const bEdit = el('button',{class:'iconbtn tiny',title:'Edit'},[icon('edit')]); 
    bEdit.onclick = ()=> openActionEditModal(action);
    const bExpand = el('button',{class:'iconbtn tiny',title:'Expand'},[icon('expand')]); 
    bExpand.onclick = ()=> openActionExpandModal(action);
    const bDel = el('button',{class:'iconbtn tiny',title:'Delete'},[icon('close')]); 
    bDel.onclick = (e)=> {
      e.stopPropagation();
      confirmModal('Delete action', `Delete "${action.title||'Untitled'}"?`, ()=>{ 
        db.actions=db.actions.filter(x=>x.id!==action.id); 
        save(); 
        // Keep idea card open when deleting action
        const ideaCardEl = card.closest('[data-idea-id]');
        const wasOpen = ideaCardEl ? ideaCardEl.classList.contains('open') : false;
        renderIdeas();
        if (wasOpen) {
          setTimeout(() => {
            const ideaCard = document.querySelector(`[data-idea-id="${idea.id}"]`);
            if (ideaCard) {
              ideaCard.classList.add('open');
              const detailsBtn = ideaCard.querySelector('.details-btn');
              if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
            }
          }, 10);
        }
      });
    };
    [bEdit,bExpand,bDel].forEach(b=> icons.appendChild(b));
    right.appendChild(icons);
    topRow.appendChild(right);
    
    head.appendChild(topRow);

    // RELATION ROW (below title) - will show "Entrepreneurship — [idea name]"
    const relationRow = el('div',{class:'relation-line'},[ getRelationText(action) ]);
    head.appendChild(relationRow);

    // DESCRIPTION ROW (below relation)
    const descRow = el('div',{class:'desc-one'},[
        el('span',{class:'label'},['Description:']),
        el('span',{class:'text'},[(action.description||'').trim()||'—'])
      ])
    head.appendChild(descRow);
    
    card.appendChild(head);

    /* body (subtasks) */
    const body = el('div',{class:'action-body'});
    (action.subactions||[]).forEach((s,idx)=> body.appendChild(createIdeaSubRow(action,s,idx,idea,card)));
    card.appendChild(body);

    /* foot */
    const foot = el('div',{class:'action-foot'});
    const addBtn = el('button',{class:'btn','aria-label':'Add new subtask'},['Add new subtask']);
    addBtn.onclick = ()=> openAddSubtaskModal(action);
    foot.appendChild(addBtn);
    card.appendChild(foot);

    return card;
  }

  // Helper functions for idea action cards
  function computeActionStatus(action) {
    const total = action.subactions?.length || 0;
    const done = (action.subactions||[]).filter(s=>!!s.done).length;
    const status = total>0 && done===total ? 'Done' : done>0 ? 'In progress' : 'To do';
    return {status, done, total};
  }

  function hasActionOverdue(action) {
    const d = new Date(); const todayStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    return (action.subactions||[]).some(s=>!s.done && s.due && s.due < todayStr);
  }

  function createIdeaSubRow(action,s,idx,idea,card) {
    const row = el('div',{class:'sub-row'});
    row.dataset.sid = s.id;

    // checkbox
    const cb = el('input', {
      type: 'checkbox',
      id: uid('chk'),
      'aria-label': `Mark "${s.title}" completed`
    });
    cb.checked = !!s.done;
    cb.addEventListener('click', e => e.stopPropagation());
    cb.onchange = () => { 
      s.done = cb.checked; 
      save();
      // Keep idea card open when checking subtask
      const ideaCard = card.closest('.idea-card');
      const wasOpen = ideaCard.classList.contains('open');
      renderIdeas();
      if (wasOpen) {
        setTimeout(() => {
          const newIdeaCard = document.querySelector(`[data-idea-id="${idea.id}"]`);
          if (newIdeaCard) {
            newIdeaCard.classList.add('open');
            const detailsBtn = newIdeaCard.querySelector('.details-btn');
            if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
          }
        }, 10);
      }
    };
    
    const cbWrap = el('label', { class: 'sub-check', for: cb.id, title: 'Mark complete' });
    cbWrap.appendChild(cb);
    row.appendChild(cbWrap);

    const title = el('span',{class:'sub-title'+(s.done?' sub-completed':'')},[s.title||'']);
    row.appendChild(title);

    const due = el('span',{class:'due-pill'},[ s.due ? fmtDate(s.due) : '—' ]);
    row.appendChild(due);

    const icons = el('div',{class:'sub-icons'});
    const dBtn = el('button',{class:'iconbtn tiny',title:'Delete'},[icon('close')]);
    dBtn.addEventListener('click', ev=>{ 
      ev.stopPropagation(); 
      confirmModal('Delete subtask', `Delete "${s.title||'subtask'}"?`, ()=>{ 
        // Filter out the subtask from the action
        action.subactions = (action.subactions||[]).filter(x=>x.id!==s.id); 
        
        // Also update the action in the database
        const dbAction = db.actions.find(a => a.id === action.id);
        if (dbAction) {
          dbAction.subactions = (dbAction.subactions||[]).filter(x=>x.id!==s.id);
          dbAction.updatedAt = new Date().toISOString();
        }
        
        save();
        touch(idea);
        
        // Remove the subtask row directly from DOM without full re-render
        const subtaskRow = row;
        subtaskRow.remove();
        
        // Update the action status display
        const actionCard = card;
        const statusBadge = actionCard.querySelector('.badge');
        const progressText = actionCard.querySelector('.progress-text');
        
        if (statusBadge && progressText) {
          const {status, done, total} = computeActionStatus(action);
          statusBadge.textContent = status;
          statusBadge.className = `badge ${status==='Done'?'done':status==='In progress'?'progress':'todo'}`;
          progressText.textContent = `${done} of ${total} completed`;
          
          // Update overdue badge
          const existingOverdue = actionCard.querySelector('.badge.overdue');
          if (hasActionOverdue(action)) {
            if (!existingOverdue) {
              const overdueBadge = el('span',{class:'badge overdue'},['Overdue']);
              progressText.parentNode.insertBefore(overdueBadge, progressText.nextSibling);
            }
          } else if (existingOverdue) {
            existingOverdue.remove();
          }
        }
      }); 
    });
    icons.appendChild(dBtn);
    row.appendChild(icons);

    const d = new Date(); const todayStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    const overdue = !s.done && s.due && s.due < todayStr;
    if(overdue){ title.classList.add('sub-overdue'); due.classList.add('sub-overdue'); }

    return row;
  }

  // Add next step function - creates action and subtask
  function addNextStep(idea, stepText, dueDate) {
    // Initialize actions array if it doesn't exist
    if (!db.actions) {
      db.actions = [];
    }
    
    // Look for existing action for this idea
    let existingAction = db.actions.find(a => 
      a.relatedType === 'Entrepreneurship' && 
      a.relatedId === idea.id
    );
    
    if (existingAction) {
      // Add subtask to existing action
      if (!existingAction.subactions) {
        existingAction.subactions = [];
      }
      existingAction.subactions.push({
        id: uid('subtask'),
        title: stepText,
        due: dueDate,
        done: false,
        createdAt: new Date().toISOString()
      });
      existingAction.updatedAt = new Date().toISOString();
    } else {
      // Create new action with subtask
      const newAction = {
        id: uid('action'),
        title: idea.name || 'Untitled Idea',
        relatedType: 'Entrepreneurship',
        relatedId: idea.id,
        description: '',
        subactions: [{
          id: uid('subtask'),
          title: stepText,
          due: dueDate,
          done: false,
          createdAt: new Date().toISOString()
        }],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      db.actions.push(newAction);
    }
    
    save();
    touch(idea);
  }

  // Delete confirmation modal
  function openDeleteModal(idea) {
    const modalContent = el('div', {class: 'delete-modal'});
    modalContent.appendChild(el('p', {style: 'margin: 0 0 16px; color: #374151;'}, [
      `Are you sure you want to delete "${idea.name || 'Untitled idea'}"?`
    ]));
    modalContent.appendChild(el('p', {style: 'margin: 0 0 16px; color: #6b7280; font-size: 14px;'}, [
      'This action cannot be undone.'
    ]));
    
    const actions = el('div', {class: 'right', style: 'gap: 8px;'});
    const cancelBtn = el('button', {class: 'iconbtn'}, ['Cancel']);
    const deleteBtn = el('button', {class: 'btn-destructive'}, ['Delete']);
    
    cancelBtn.onclick = () => modal.close();
    deleteBtn.onclick = () => {
      db.ideas = db.ideas.filter(x => x.id !== idea.id);
      save();
      renderIdeas();
      modal.close();
    };
    
    actions.appendChild(cancelBtn);
    actions.appendChild(deleteBtn);
    modalContent.appendChild(actions);
    
    modal.open('Delete Idea', modalContent);
  }

  // Delete investigation note modal
  function openDeleteInvestigationModal(idea, item, card) {
    const modalContent = el('div', {class: 'delete-modal'});
    modalContent.appendChild(el('p', {style: 'margin: 0 0 16px; color: #374151;'}, [
      'Are you sure you want to delete this investigation note?'
    ]));
    modalContent.appendChild(el('p', {style: 'margin: 0 0 16px; color: #6b7280; font-size: 14px;'}, [
      'This action cannot be undone.'
    ]));
    
    const actions = el('div', {class: 'right', style: 'gap: 8px;'});
    const cancelBtn = el('button', {class: 'iconbtn'}, ['Cancel']);
    const deleteBtn = el('button', {class: 'btn-destructive'}, ['Delete']);
    
    cancelBtn.onclick = () => modal.close();
    deleteBtn.onclick = () => {
      idea.investigations = idea.investigations.filter(x => x.id !== item.id);
      touch(idea);
      
      // Re-render without closing the details
      const wasOpen = card.classList.contains('open');
      renderIdeas();
      if (wasOpen) {
        setTimeout(() => {
          const newCard = document.querySelector(`[data-idea-id="${idea.id}"]`);
          if (newCard) {
            newCard.classList.add('open');
            const detailsBtn = newCard.querySelector('.details-btn');
            if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
          }
        }, 10);
      }
      modal.close();
    };
    
    actions.appendChild(cancelBtn);
    actions.appendChild(deleteBtn);
    modalContent.appendChild(actions);
    
    modal.open('Delete Investigation Note', modalContent);
  }

  // Delete useful link modal
  function openDeleteLinkModal(idea, link, card) {
    const modalContent = el('div', {class: 'delete-modal'});
    modalContent.appendChild(el('p', {style: 'margin: 0 0 16px; color: #374151;'}, [
      'Are you sure you want to delete this useful link?'
    ]));
    modalContent.appendChild(el('p', {style: 'margin: 0 0 16px; color: #6b7280; font-size: 14px;'}, [
      'This action cannot be undone.'
    ]));
    
    const actions = el('div', {class: 'right', style: 'gap: 8px;'});
    const cancelBtn = el('button', {class: 'iconbtn'}, ['Cancel']);
    const deleteBtn = el('button', {class: 'btn-destructive'}, ['Delete']);
    
    cancelBtn.onclick = () => modal.close();
    deleteBtn.onclick = () => {
      idea.links = idea.links.filter(x => x.id !== link.id);
      touch(idea);
      
      // Re-render without closing the details
      const wasOpen = card.classList.contains('open');
      renderIdeas();
      if (wasOpen) {
        setTimeout(() => {
          const newCard = document.querySelector(`[data-idea-id="${idea.id}"]`);
          if (newCard) {
            newCard.classList.add('open');
            const detailsBtn = newCard.querySelector('.details-btn');
            if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
          }
        }, 10);
      }
      modal.close();
    };
    
    actions.appendChild(cancelBtn);
    actions.appendChild(deleteBtn);
    modalContent.appendChild(actions);
    
    modal.open('Delete Useful Link', modalContent);
  }

  // Seed demo idea if empty
  if(!(db.ideas||[]).length) {
    db.ideas.push({
      id: uid('idea'),
      icon: '🤖',
      name: 'AI résumé screener extension',
      description: 'A tiny browser extension that scores résumés against a JD for indie recruiters. Keep it delightful + transparent.',
      investigations: [{
        id: uid('inv'),
        date: new Date().toISOString().slice(0,10),
        text: 'Watched YC video on validation loops',
        link: ''
      }],
      steps: [{
        id: uid('step'),
        title: 'Write 10-question user interview script',
        due: '',
        done: false
      }],
      links: [],
      archived: false,
      starred: true,
      followUp: '',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });
    save();
  }
  
  // Initial render
  renderIdeas();
  
  return wrap;
}



/* ---------------- Action Create Modal ---------------- */
function openActionCreateModal(prefilledData = {}) {
  const state = {
    title: '',
    description: '',
    relatedType: prefilledData.relatedType || 'Other',
    relatedId: prefilledData.relatedId || ''
  };
  
  const form = el('div');
  
  // Title field
  const titleWrap = el('div');
  titleWrap.appendChild(el('label', {html: 'Title*'}));
  const titleInput = el('input', {type: 'text', value: ''});
  titleInput.oninput = () => state.title = titleInput.value;
  titleWrap.appendChild(titleInput);
  form.appendChild(titleWrap);
  
  // Related field (only disabled when pre-filled from other modules)
  const relatedWrap = el('div');
  relatedWrap.appendChild(el('label', {html: 'Related'}));
  
  const isPrefilled = prefilledData.relatedType && prefilledData.relatedId;
  
  if (isPrefilled) {
    // Pre-filled and disabled (from other modules)
    let relatedItemName = '';
    if (state.relatedType === 'Company') {
      const company = db.companies.find(c => c.id === state.relatedId);
      relatedItemName = company ? company.name : 'Unknown Company';
    } else if (state.relatedType === 'Job') {
      const job = db.jobs.find(j => j.id === state.relatedId);
      const company = job ? db.companies.find(c => c.id === job.companyId) : null;
      relatedItemName = job ? `${job.title} (${company ? company.name : 'No company'})` : 'Unknown Job';
    } else if (state.relatedType === 'Coffee chat') {
      const chat = db.chats.find(ch => ch.id === state.relatedId);
      const contact = chat ? db.contacts.find(c => c.id === chat.contactId) : null;
      const company = contact ? db.companies.find(c => c.id === contact.companyId) : null;
      relatedItemName = contact ? `${contact.name} (${company ? company.name : 'No company'})` : 'Unknown Chat';
    } else if (state.relatedType === 'Entrepreneurship') {
      const idea = (db.ideas||[]).find(i => i.id === state.relatedId);
      relatedItemName = idea ? idea.name : 'Unknown Idea';
    }
    
    const relatedInput = el('input', {
      type: 'text', 
      value: `${state.relatedType} — ${relatedItemName}`,
      disabled: true,
      style: 'background:#f8fafc;color:#6b7280;cursor:not-allowed'
    });
    relatedWrap.appendChild(relatedInput);
  } else {
    // Normal dropdown for manual selection
    const relatedSelect = el('select');
    ['Other', 'Company', 'Job', 'Coffee chat', 'Entrepreneurship'].forEach(option => {
      relatedSelect.appendChild(el('option', {value: option}, [option]));
    });
    relatedSelect.value = state.relatedType;
    relatedSelect.onchange = () => {
      state.relatedType = relatedSelect.value;
      buildRelPicker();
    };
    relatedWrap.appendChild(relatedSelect);
    
    // Pick related item section
    const relBox = el('div');
    relBox.appendChild(el('label', {html: 'Pick related item'}));
    const relHolder = el('div');
    relBox.appendChild(relHolder);
    relatedWrap.appendChild(relBox);
    
    // Build relation picker function
    function buildRelPicker() {
      relHolder.innerHTML = '';
      if (state.relatedType === 'Other') {
        state.relatedId = '';
        relHolder.appendChild(el('div', {}, ['—']));
        return;
      }
      
      const sel = el('select');
      let opts = [];
      
      if (state.relatedType === 'Company') {
        opts = db.companies.map(c => ({label: c.name, value: c.id})).sort((a,b) => a.label.localeCompare(b.label));
      }
      if (state.relatedType === 'Job') {
        opts = db.jobs.map(j => ({
          label: j.title + (db.companies.find(c => c.id === j.companyId) ? ` — ${db.companies.find(c => c.id === j.companyId).name}` : ''),
          value: j.id
        })).sort((a,b) => a.label.localeCompare(b.label));
      }
      if (state.relatedType === 'Coffee chat') {
        opts = db.chats.map(ch => {
          const ct = db.contacts.find(c => c.id === ch.contactId);
          const co = ct ? db.companies.find(c => c.id === ct.companyId) : null;
          const label = (ct ? ct.name : 'Unknown') + (co ? ` — ${co.name}` : '');
          return {label, value: ch.id};
        }).sort((a,b) => a.label.localeCompare(b.label));
      }
      if (state.relatedType === 'Entrepreneurship') {
        opts = (db.ideas || []).map(idea => ({label: idea.name || 'Untitled', value: idea.id})).sort((a,b) => a.label.localeCompare(b.label));
      }
      
      if (!opts.length) {
        relHolder.appendChild(el('div', {}, ['No items found']));
        state.relatedId = '';
        return;
      }
      
      opts.forEach(o => sel.appendChild(el('option', {value: o.value}, [o.label])));
      sel.value = state.relatedId || opts[0].value;
      state.relatedId = sel.value;
      sel.onchange = () => state.relatedId = sel.value;
      relHolder.appendChild(sel);
    }
    
    // Initialize the picker
    buildRelPicker();
  }
  
  form.appendChild(relatedWrap);
  
  // Description field
  const descWrap = el('div');
  descWrap.appendChild(el('label', {html: 'Description'}));
  const descTextarea = el('textarea');
  descTextarea.oninput = () => state.description = descTextarea.value;
  descWrap.appendChild(descTextarea);
  form.appendChild(descWrap);
  
  // Subtasks section
  const subtasksSection = el('div', {class: 'subtasks-create-section'});
  subtasksSection.appendChild(el('h3', {style: 'margin:20px 0 12px;font-size:14px;color:#374151;font-weight:600'}, ['Subtasks (Optional)']));
  
  const subtasksList = el('div', {class: 'subtasks-list'});
  state.subtasks = [];
  
  // Function to render subtasks
  function renderSubtasks() {
    subtasksList.innerHTML = '';
    state.subtasks.forEach((subtask, index) => {
      const subtaskRow = el('div', {class: 'subtask-create-row'});
      
      // Title field
      const titleField = el('div', {class: 'subtask-field'});
      titleField.appendChild(el('label', {html: 'Title'}));
      const titleInput = el('input', {type: 'text', value: subtask.title, placeholder: 'Subtask title'});
      titleInput.oninput = () => state.subtasks[index].title = titleInput.value;
      titleField.appendChild(titleInput);
      subtaskRow.appendChild(titleField);
      
      // Date field
      const dateField = el('div', {class: 'subtask-field'});
      dateField.appendChild(el('label', {html: 'Due Date'}));
      const dateInput = el('input', {type: 'date', value: subtask.due});
      dateInput.oninput = () => state.subtasks[index].due = dateInput.value;
      dateField.appendChild(dateInput);
      subtaskRow.appendChild(dateField);
      
      // Remove button (X in top-right)
      const removeBtn = el('button', {type: 'button', class: 'subtask-remove-x', title: 'Remove subtask'}, ['×']);
      removeBtn.onclick = () => {
        state.subtasks.splice(index, 1);
        renderSubtasks();
      };
      subtaskRow.appendChild(removeBtn);
      
      // Notes field (full width)
      const notesField = el('div', {class: 'subtask-field-full'});
      notesField.appendChild(el('label', {html: 'Notes'}));
      const notesInput = el('textarea', {style: 'min-height:50px', value: subtask.notes, placeholder: 'Add notes...'});
      notesInput.oninput = () => state.subtasks[index].notes = notesInput.value;
      notesField.appendChild(notesInput);
      subtaskRow.appendChild(notesField);
      
      subtasksList.appendChild(subtaskRow);
    });
  }
  
  subtasksSection.appendChild(subtasksList);
  
  // Add subtask button
  const addSubtaskBtn = el('button', {type: 'button', class: 'btn-outline'}, ['+ Add Subtask']);
  addSubtaskBtn.onclick = () => {
    state.subtasks.push({
      id: uid('sub'),
      title: '',
      due: '',
      done: false,
      notes: ''
    });
    renderSubtasks();
  };
  subtasksSection.appendChild(addSubtaskBtn);
  
  form.appendChild(subtasksSection);
  
  const actions = el('div', {class: 'right'});
  const saveBtn = el('button', {class: 'btn-teal'}, ['Add']);
  saveBtn.onclick = () => {
    if (!state.title.trim()) return alert('Title is required');
    
    const newAction = {
      id: uid('action'),
      title: state.title.trim(),
      description: state.description || '',
      relatedType: state.relatedType,
      relatedId: state.relatedId,
      createdAt: new Date().toISOString(),
      subactions: state.subtasks.filter(s => s.title.trim()) // Only include subtasks with titles
    };
    
    db.actions = db.actions || [];
    db.actions.unshift(newAction);
    save();
    modal.close();
    
    // Use appropriate refresh function based on current module
    if (currentTab === 'ideas') {
      // Store scroll position and open idea cards
      const scrollPosition = window.scrollY;
      const openIdeaIds = [];
      document.querySelectorAll('.idea.open').forEach(idea => {
        openIdeaIds.push(idea.getAttribute('data-idea-id'));
      });
      
      renderIdeas();
      
      // Restore scroll position and open idea cards
      setTimeout(() => {
        window.scrollTo(0, scrollPosition);
        openIdeaIds.forEach(ideaId => {
          const ideaCard = document.querySelector(`[data-idea-id="${ideaId}"]`);
          if (ideaCard) {
            ideaCard.classList.add('open');
            const detailsBtn = ideaCard.querySelector('.details-btn');
            if (detailsBtn) detailsBtn.innerHTML = 'Hide ▲';
          }
        });
      }, 10);
    } else if (currentTab === 'actions') {
      if (currentView === 'calendar') refreshCalendar();
      else render();
    } else {
      // Switch to Next Actions tab for other modules
      const actionTab = document.querySelector('[data-tab="actions"]');
      if (actionTab) {
        actionTab.click();
      }
    }
  };
  
  const cancel = el('button', {class: 'iconbtn'}, ['Cancel']);
  cancel.onclick = () => modal.close();
  actions.appendChild(cancel);
  actions.appendChild(saveBtn);
  form.appendChild(actions);
  
  modal.open('New action', form);
}

/* ---------------- Company Modal ---------------- */
function openCompanyModal(c){
  const isEdit = !!c;
  const state = c ? {...c} : {type:'Other', priority:'Medium'};
  state.logoId = state.logoId || (state.id ? ('logo-'+state.id) : '');
  
  // 🔁 Ensure both notes and description are synchronized when opening modal
  if (isEdit) {
    const v = String(state.description ?? state.notes ?? '');
    state.description = v;
    state.notes = v;
  }
  
  const form = el('div');
  const r1 = el('div',{class:'row'});
  r1.appendChild(inputField('Name*','name'));
  r1.appendChild(inputField('Website','website'));
  
  const r2 = el('div',{class:'row'});
  r2.appendChild(inputField('Location','location'));
  r2.appendChild(selectField('Priority','priority',['Low','Medium','High']));
  
  // Logo row: left controls (Upload/Link), right preview — single line layout
  let pendingLogo = null;
  const rLogo = el('div',{style:'display:flex;align-items:flex-end;gap:16px;width:100%'});

  const leftControls = el('div',{style:'flex:1;min-width:0'});
  const controlsLabel = el('label',{html:'Logo'}); leftControls.appendChild(controlsLabel);
  // Tabs: Upload | Link
  const tabWrap = el('div',{style:'display:flex;gap:8px;margin:6px 0'});
  const uploadTab = el('div',{class:'type-chip selected', style:'padding:6px 10px;border:1px solid #e5e7eb;border-radius:20px;cursor:pointer;background:#f3cf8d;border-color:#d4a853;font-size:11px;font-weight:600'},['Upload']);
  const linkTab = el('div',{class:'type-chip', style:'padding:6px 10px;border:1px solid #e5e7eb;border-radius:20px;cursor:pointer;background:#fff;font-size:11px'},['Link']);
  tabWrap.appendChild(uploadTab); tabWrap.appendChild(linkTab);
  leftControls.appendChild(tabWrap);

  const uploadPanel = el('div');
  const fileInput = el('input',{type:'file', accept:'image/*'});
  uploadPanel.appendChild(fileInput);

  const linkPanel = el('div',{style:'display:none'});
  const linkRow = el('div',{style:'display:flex;align-items:center;gap:8px;width:100%'});
  const urlInput = el('input',{type:'url', placeholder:"Paste image URL (right-click → Copy Image Address)", style:'flex:1;font-size:12px;padding:8px 10px'});
  const fetchBtn = el('button',{class:'iconbtn', type:'button', style:'padding:6px 10px'},['Submit']);
  linkRow.appendChild(urlInput);
  linkRow.appendChild(fetchBtn);
  linkPanel.appendChild(linkRow);

  leftControls.appendChild(uploadPanel);
  leftControls.appendChild(linkPanel);
  rLogo.appendChild(leftControls);

  const logoBox = el('div',{style:'display:flex;flex-direction:column;gap:6px;align-items:flex-end;justify-content:center'});
  const previewLabel = el('label',{html:"Logo's Preview"}); logoBox.appendChild(previewLabel);
  const preview = el('img',{alt:'', style:'width:96px;height:96px;object-fit:contain;border:1px solid #e5e7eb;border-radius:8px;background:#fff;display:block;margin-left:auto'});
  if (state.logoId){ logosGet(state.logoId).then(rec=>{ if(rec&&rec.blob) preview.src = URL.createObjectURL(rec.blob); }).catch(()=>{}); }
  logoBox.appendChild(preview);
  rLogo.appendChild(logoBox);

  function setActiveTab(which){
    if (which==='upload'){
      uploadPanel.style.display='block'; linkPanel.style.display='none';
      uploadTab.classList.add('selected'); uploadTab.style.background='#f3cf8d'; uploadTab.style.borderColor='#d4a853'; uploadTab.style.fontWeight='600';
      linkTab.classList.remove('selected'); linkTab.style.background='#fff'; linkTab.style.borderColor='#e5e7eb'; linkTab.style.fontWeight='normal';
    } else {
      uploadPanel.style.display='none'; linkPanel.style.display='block';
      linkTab.classList.add('selected'); linkTab.style.background='#f3cf8d'; linkTab.style.borderColor='#d4a853'; linkTab.style.fontWeight='600';
      uploadTab.classList.remove('selected'); uploadTab.style.background='#fff'; uploadTab.style.borderColor='#e5e7eb'; uploadTab.style.fontWeight='normal';
    }
  }
  setActiveTab('upload');
  uploadTab.onclick = ()=> setActiveTab('upload');
  linkTab.onclick = ()=> setActiveTab('link');

  fileInput.onchange = async ()=>{
    const file = fileInput.files && fileInput.files[0]; if(!file) return;
    try{ const out = await processImage(file); pendingLogo = out; preview.src = URL.createObjectURL(out.blob); }
    catch(err){ alert(err&&err.message?err.message:'Failed to process image'); fileInput.value=''; pendingLogo=null; }
  };
  fetchBtn.onclick = async ()=>{
    const u = (urlInput.value||'').trim(); if(!u) return alert('Please paste an image URL');
    try{
      const res = await fetch(u, {mode:'cors'});
      if (!res.ok) throw new Error('Failed to fetch image');
      const blob = await res.blob();
      const file = new File([blob], 'remote', {type: blob.type||'image/jpeg'});
      const out = await processImage(file);
      pendingLogo = out; preview.src = URL.createObjectURL(out.blob);
    }catch(err){ alert(err&&err.message?err.message:'Could not fetch/process that URL'); }
  };

  const r3 = el('div',{class:'row'});
  
  // Sector dropdown with comprehensive options
  const sectorWrap = el('div');
  sectorWrap.appendChild(el('label',{html:'Sector'}));
  const sectorSel = el('select');
  sectorSel.appendChild(el('option',{value:''},['Select a sector…']));
  
  const sectorGroups = [
    {
      label: 'Consulting & Professional Services',
      options: ['IT & Digital Consulting', 'Management Consulting', 'Other Advisory Services', 'Strategy Consulting']
    },
    {
      label: 'Consumer & Commerce', 
      options: ['E-commerce', 'Fashion & Lifestyle', 'Food & Beverage', 'Gaming & Entertainment', 'Media, Marketing & Communications', 'Retail', 'Sports & Recreation']
    },
    {
      label: 'Finance & Business',
      options: ['Accounting & Audit', 'Banking', 'Corporate Strategy', 'Insurance', 'Startups & Entrepreneurship', 'Venture Capital & Private Equity']
    },
    {
      label: 'Industry & Infrastructure',
      options: ['Agriculture & FoodTech', 'Chemicals & Materials', 'Construction & Civil Engineering', 'Energy & CleanTech', 'Logistics, Mobility & Transport', 'Manufacturing & Industry 4.0', 'Real Estate & PropTech']
    },
    {
      label: 'Other',
      options: ['Cross-sector roles', 'Unspecified / General']
    },
    {
      label: 'Public & Social Impact',
      options: ['Education & Training', 'Government & Public Policy', 'Healthcare & Social Care', 'Legal & Compliance', 'Non-Profit & Social Impact', 'Security & Defense']
    },
    {
      label: 'Technology & Innovation',
      options: ['Artificial Intelligence & Machine Learning', 'Climate Tech', 'Cybersecurity', 'Data Science & Analytics', 'Edtech', 'Fintech', 'Healthtech & Medtech', 'Software Development & Engineering', 'Space & Aerospace']
    }
  ];
  
  sectorGroups.forEach(group => {
    const optgroup = document.createElement('optgroup');
    optgroup.label = group.label;
    group.options.forEach(option => {
      optgroup.appendChild(el('option',{value:option},[option]));
    });
    sectorSel.appendChild(optgroup);
  });
  
  sectorSel.value = state.sector || '';
  sectorSel.onchange = () => state.sector = sectorSel.value;
  sectorWrap.appendChild(sectorSel);
  r3.appendChild(sectorWrap);
  
  // Company type with improved chips UI
  const typeWrap = el('div');
  typeWrap.appendChild(el('label',{html:'Type*'}));
  const typeContainer = el('div',{style:'display:flex;gap:8px;margin-top:6px'});
  
  const typeOptions = ['Dream','Entrepreneurship','Other'];
  typeOptions.forEach(opt => {
    const chip = el('div',{
      class:'type-chip' + (state.type === opt ? ' selected' : ''),
      style:'padding:8px 16px;border:1px solid #e5e7eb;border-radius:20px;cursor:pointer;background:#fff;font-size:12px;transition:all 0.2s'
    },[opt]);
    
    chip.onclick = () => {
      state.type = opt;
      typeContainer.querySelectorAll('.type-chip').forEach(c => c.classList.remove('selected'));
      chip.classList.add('selected');
      // Update selected styling
      typeContainer.querySelectorAll('.type-chip').forEach(c => {
        if(c.classList.contains('selected')) {
          c.style.background = '#f3cf8d';
          c.style.borderColor = '#d4a853';
          c.style.fontWeight = '600';
        } else {
          c.style.background = '#fff';
          c.style.borderColor = '#e5e7eb';
          c.style.fontWeight = 'normal';
        }
      });
    };
    typeContainer.appendChild(chip);
  });
  
  // Set initial selected state
  typeContainer.querySelectorAll('.type-chip').forEach(c => {
    if(c.textContent === state.type) {
      c.style.background = '#f3cf8d';
      c.style.borderColor = '#d4a853';
      c.style.fontWeight = '600';
    }
  });
  
  typeWrap.appendChild(typeContainer);
  r3.appendChild(typeWrap);
  
  const r4 = el('div',{});
  r4.appendChild(textField('Notes','notes'));
  
  function inputField(lbl,key){ 
    const box = el('div'); 
    box.appendChild(el('label',{html:lbl})); 
    const n = el('input',{type:'text',value:state[key]||''}); 
    n.oninput=()=> state[key]=n.value; 
    box.appendChild(n); 
    return box; 
  }
  
  function selectField(lbl,key,opts){ 
    const box = el('div'); 
    box.appendChild(el('label',{html:lbl})); 
    const n = el('select'); 
    opts.forEach(o => n.appendChild(el('option',{value:o},[o]))); 
    n.value = state[key] || opts[0]; 
    state[key] = n.value;
    n.onchange = () => state[key] = n.value; 
    box.appendChild(n); 
    return box; 
  }
  
  function textField(lbl,key){ 
    const box = el('div'); 
    box.appendChild(el('label',{html:lbl})); 
    const n = el('textarea'); 
    // For notes field, prefer description if notes is empty
    const value = key === 'notes' ? (state[key] || state.description || '') : (state[key] || '');
    n.value = value; 
    n.oninput=()=> state[key]=n.value; 
    box.appendChild(n); 
    return box; 
  }
  
  form.appendChild(r1); form.appendChild(r2); form.appendChild(rLogo); form.appendChild(r3); form.appendChild(r4);
  
  const actions = el('div',{class:'right'});
  const saveBtn = el('button',{class:'btn-teal'},[isEdit?'Save':'Add']);
  saveBtn.onclick = async ()=>{
    if(!state.name) return alert('Name is required');
    if (!isEdit && !state.id) state.id = uid('company');

    // (keep existing pendingLogo block as-is)
    if (pendingLogo){
      state.logoId = 'logo-'+state.id;
      try{ await logosPut(state.logoId, pendingLogo.blob, pendingLogo.type); }
      catch(e){ return alert('Failed to save logo: ' + (e&&e.message || e)); }
    }

    // 🔁 Mirror to ONE canonical value and write both fields
    const v = String(state.notes ?? state.description ?? '');
    state.description = v;
    state.notes = v;

    if (isEdit){
      db.companies = db.companies.map(x =>
        x.id === state.id
          ? { ...x, ...state, description: v, notes: v }
          : x
      );
    } else {
      db.companies.unshift({ ...state, description: v, notes: v });
    }

    save();
    modal.close();
    render();

    // Re-seed & re-render Dash360 if visible so it reads the new DB value
    try {
      dash360EnsureSeeded();
      const root = document.getElementById('dash360-root');
      if (root && root.style.display !== 'none') {
        dash360RenderCompanyView(root);
      }
    } catch(e) {
      console.error('❌ Error refreshing Dash360:', e);
    }
  };
  
  const cancel = el('button',{class:'iconbtn'},['Cancel']); 
  cancel.onclick = ()=> modal.close();
  actions.appendChild(cancel); actions.appendChild(saveBtn); 
  form.appendChild(actions);
  
  modal.open(isEdit? 'Edit company' : 'Add company', form);
}

/* ---------------- Utilities ---------------- */
function infoField(lbl, val){ const box = el('div'); box.appendChild(el('label',{html:lbl})); const v = el('div',{class:'value'}); if(typeof val==='string') v.textContent=val; else v.appendChild(val); box.appendChild(v); return box; }

/* ---------------- Init ---------------- */
render();
console.log('RoleMap v9 ready.');

// Purge stale cache once (optional but recommended)
// Run this in console for testing: localStorage.removeItem('dash360:companies');

// ============ Dash360 Modal CSS Loader ============
// Ensure modal CSS is loaded (runs once on page load)
(function loadDash360ModalCSS() {
  // Check if CSS is already loaded
  if (document.querySelector('#dash360-modal-css')) {
    return; // Already loaded
  }
  
  // Create and add the CSS
  const style = document.createElement('style');
  style.id = 'dash360-modal-css';
  style.textContent = '#dash360-root .dash360-confirm-modal{position:fixed!important;inset:0!important;display:flex!important;align-items:center;justify-content:center;z-index:99999!important;background:rgba(15,23,42,.45)!important}#dash360-root .dash360-confirm-modal .d360-box{background:#fff!important;border:1px solid #e5e7eb!important;border-radius:12px!important;box-shadow:0 20px 50px rgba(2,6,23,.25)!important;width:min(92vw,560px)!important;overflow:hidden!important}#dash360-root .dash360-confirm-modal .d360-head{background:#00B4D8!important;color:#fff!important;font-weight:800!important;padding:14px 16px!important}#dash360-root .dash360-confirm-modal .d360-body{padding:18px 16px 6px!important;color:#1f2937!important;font-size:18px!important}#dash360-root .dash360-confirm-modal .d360-sub{padding:0 16px 16px!important;color:#64748b!important}#dash360-root .dash360-confirm-modal .d360-foot{padding:12px 16px!important;display:flex!important;justify-content:flex-end!important;gap:12px!important;border-top:1px solid #eef2f7!important}#dash360-root .dash360-confirm-modal .btn{appearance:none!important;border-radius:10px!important;padding:10px 16px!important;font-weight:700!important;border:1px solid #e5e7eb!important;background:#fff!important;color:#0f172a!important;cursor:pointer!important}#dash360-root .dash360-confirm-modal .btn-danger{border:none!important;background:#e11d48!important;color:#fff!important}#dash360-root .dash360-confirm-modal .btn:hover{background:#f8fafc!important}#dash360-root .dash360-confirm-modal .btn-danger:hover{background:#be123c!important}';
  document.head.appendChild(style);
  console.log('Dash360 Modal CSS loaded successfully');
})();

</script>
</body>
</html>
